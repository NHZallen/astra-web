<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASTRA Music</title>
    <link rel="icon" href="./images/logo.png" type="image/png">
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* --- CSS 變數 --- */
        :root {
            --bg-color: #FFFFFF;
            --sidebar-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FA2D48;
            --accent-color-hover: #D41E36;
            --accent-color-light: rgba(250, 45, 72, 0.08);
            --divider: #E5E5E5;
            --player-bg: rgba(255, 255, 255, 0.85);
            --modal-bg: #FFFFFF;
            --input-bg: #F5F5F7;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.04);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.08);
            --radius-lg: 24px;
            --radius-md: 16px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 80px;
            --mobile-nav-height: 65px;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --sidebar-bg: #121212;
            --card-bg: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #A1A1A6;
            --accent-color-light: rgba(250, 45, 72, 0.2);
            --divider: #333333;
            --player-bg: rgba(28, 28, 30, 0.85);
            --modal-bg: #000000;
            --input-bg: #1C1C1E;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.6);
        }

        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            overflow: hidden; 
            height: 100vh; height: 100dvh; 
            transition: background 0.3s, color 0.3s;
            position: fixed; width: 100%;
        }
        
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .input-style { width:100%; padding:16px; margin-bottom:12px; border-radius:14px; border:1px solid transparent; background:var(--input-bg); color:var(--text-primary); outline:none; font-size: 1rem; transition:0.2s; }
        .input-style:focus { background: var(--bg-color); border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-color-light); }
        .btn-primary { width:100%; padding:16px; background:var(--accent-color); color:white; border:none; border-radius:14px; font-weight:600; font-size:1rem; cursor:pointer; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* Landing Page (省略部分樣式以節省空間，保持原有設計) */
        #landing-page { height: 100%; overflow-y: auto; overflow-x: hidden; z-index: 2000; position: relative; background-color: #FFFFFF; color: #1D1D1F; scroll-behavior: smooth; }
        .lp-nav { position: fixed; top: 0; width: 100%; padding: 20px 40px; padding-top: calc(20px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .lp-logo { font-weight: 700; font-size: 1.4rem; display: flex; align-items: center; color: #000; }
        .lp-login-btn { padding: 10px 24px; background: #000; color: #fff; border-radius: 30px; font-weight: 600; border: none; cursor: pointer; }
        .lp-hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding-top: 120px; background: radial-gradient(circle at 50% 30%, rgba(250, 45, 72, 0.05) 0%, transparent 60%); }
        .hero-title { font-size: 5rem; font-weight: 800; line-height: 1.05; margin-bottom: 30px; color: #1D1D1F; }
        .hero-title span { background: linear-gradient(135deg, #FA2D48, #FF7657); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-large { padding: 18px 45px; border-radius: 40px; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .btn-filled { background: #1D1D1F; color: white; border: none; }
        
        /* Modal & App */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); z-index: 2500; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(15px); }
        #login-modal.active { opacity: 1; pointer-events: auto; }
        .login-box { background: #FFFFFF; width: 85%; max-width: 380px; padding: 40px 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }

        /* Sidebar & Layout */
        #app-view { display: flex; height: 100%; width: 100%; position: absolute; top: 0; left: 0; }
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 40px 20px; padding-top: calc(40px + var(--safe-top)); display: flex; flex-direction: column; border-right: 1px solid var(--divider); flex-shrink: 0; }
        .sidebar-logo { font-size: 1.3rem; font-weight: 800; margin-bottom: 40px; color: var(--accent-color); padding-left: 10px; display: flex; align-items: center; }
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; padding-top: var(--header-height); }
        .content-header { position: fixed; top: 0; left: 260px; width: calc(100% - 260px); height: var(--header-height); padding: 0 30px; padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center; z-index: 90; background: var(--bg-color); transition: 0.3s; }
        .content-header.scrolled { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--divider); }
        [data-theme="dark"] .content-header.scrolled { background: rgba(0,0,0,0.8); }
        .nav-item { padding: 14px 20px; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; border-radius: 12px; margin-bottom: 5px; }
        .nav-item:hover { color: var(--text-primary); background: rgba(0,0,0,0.03); }
        .nav-item.active { background: var(--accent-color); color: white; box-shadow: 0 4px 15px var(--accent-color-light); }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .horizontal-section-wrapper { margin-bottom: 20px; }
        .horizontal-row { display: flex; overflow-x: auto; gap: 16px; padding-bottom: 20px; margin-bottom: 20px; scroll-behavior: smooth; scroll-snap-type: x mandatory; }
        .horizontal-row .music-card { flex: 0 0 auto; width: 18%; min-width: 150px; scroll-snap-align: start; }

        /* Music Card */
        .music-card { position: relative; cursor: pointer; transition: 0.3s; }
        .music-card:hover { transform: translateY(-4px); }
        .cover-art { width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-md); margin-bottom: 10px; background: #eee; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; background-size: cover; background-position: center; }
        .menu-btn { position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: 0.2s; z-index: 5; color: black; }
        .music-card:hover .menu-btn { opacity: 1; }

        /* Song List Item */
        .song-list-item { display: flex; align-items: center; padding: 8px; border-radius: 12px; margin-bottom: 8px; transition: 0.2s; cursor: pointer; background: transparent; }
        .song-list-item:hover { background: var(--input-bg); }
        .song-row-img { width: 44px; height: 44px; border-radius: 8px; margin-right: 10px; background-size: cover; background-position: center; flex-shrink: 0; background-color: #eee; }
        .song-row-info { flex: 1; overflow: hidden; min-width: 0; }
        .song-row-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-row-artist { color: var(--text-secondary); font-size: 0.75rem; }
        .list-menu-btn { width: 32px; height: 32px; border-radius: 50%; background: transparent; border: none; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .list-menu-btn:hover { background: var(--input-bg); color: var(--text-primary); }

        /* Player Bar */
        .player-bar { position: fixed; height: 85px; background: var(--player-bg); backdrop-filter: blur(20px); border: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 2000; transition: 0.5s; transform: translateY(200%); opacity: 0; }
        .player-bar.active { transform: translateY(0); opacity: 1; }
        @media (min-width: 769px) { .player-bar { bottom: 30px; right: 30px; width: calc(100% - 260px - 60px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .content-header { left: 0; width: 100%; padding: 0 20px; padding-top: calc(10px + var(--safe-top)); height: calc(60px + var(--safe-top)); }
            .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--mobile-nav-height) + var(--safe-bottom)); background: var(--modal-bg); border-top: 1px solid var(--divider); z-index: 120; justify-content: space-around; padding-bottom: var(--safe-bottom); align-items: center; }
            .mobile-nav-item { color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; font-weight: 500; width: 20%; }
            .mobile-nav-item.active { color: var(--accent-color); font-weight: 700; }
            .player-bar { bottom: calc(var(--mobile-nav-height) + var(--safe-bottom) + 12px); left: 50%; transform: translateX(-50%) translateY(200%); width: 92%; border-radius: 18px; height: 60px; padding: 0 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
            .player-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; }
            .main-content { padding-top: calc(70px + var(--safe-top)); padding-bottom: 160px; }
            .horizontal-row .music-card { width: 45%; min-width: 130px; }
        }

        /* Fullscreen Modal */
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 300; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; padding-top: var(--safe-top); }
        .fullscreen-modal.active { transform: translateY(0); }
        .modal-nav { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); flex-shrink: 0; }
        .modal-body { flex: 1; overflow-y: auto; padding: 30px; width: 100%; padding-bottom: 100px; max-width: 900px; margin: 0 auto; }
        
        .page-section { padding: 20px 16px 120px 16px; display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Context Menu Styles --- */
        #context-menu-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 4000;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #context-menu-modal.active { opacity: 1; pointer-events: auto; }
        .ctx-sheet {
            width: 100%; max-width: 400px; background: var(--card-bg);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 25px; padding-bottom: calc(25px + var(--safe-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 80vh; overflow-y: auto;
        }
        #context-menu-modal.active .ctx-sheet { transform: translateY(0); }
        
        @media (min-width: 769px) {
            #context-menu-modal { align-items: center; }
            .ctx-sheet { border-radius: 24px; transform: scale(0.9); opacity: 0; transition: 0.2s; }
            #context-menu-modal.active .ctx-sheet { transform: scale(1); opacity: 1; }
        }

        .ctx-header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--divider); }
        .ctx-thumb { width: 50px; height: 50px; border-radius: 8px; background-size: cover; background-position: center; margin-right: 15px; background-color: #eee; flex-shrink: 0; }
        .ctx-info h4 { margin: 0; font-size: 1rem; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .ctx-info p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }

        .ctx-grid { display: flex; flex-direction: column; gap: 10px; }
        .ctx-row { width: 100%; }
        .ctx-row-split { display: flex; gap: 10px; }
        .ctx-btn {
            background: var(--input-bg); border: none; border-radius: 12px;
            padding: 14px; font-size: 0.95rem; font-weight: 600; color: var(--text-primary);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.2s; width: 100%;
        }
        .ctx-btn:active { transform: scale(0.98); background: #E5E5E5; }
        .ctx-btn svg { margin-right: 8px; width: 20px; height: 20px; }
        .ctx-btn.danger { color: var(--accent-color); background: rgba(250, 45, 72, 0.08); }
        
        /* Playlist Buttons Split */
        .playlist-action-row { display: flex; gap: 15px; justify-content: center; width: 100%; margin-top: 20px; }
        .playlist-play-btn { flex: 1; padding: 12px; background: var(--accent-color); color: white; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; max-width: 180px; box-shadow: 0 4px 12px var(--accent-color-light); }
        .playlist-shuffle-btn { flex: 1; padding: 12px; background: var(--input-bg); color: var(--text-primary); border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; max-width: 180px; }
        
        /* Add Music Row in Playlist */
        .add-music-row {
            display: flex; align-items: center; padding: 12px; border-radius: 12px;
            margin-top: 15px; cursor: pointer; background: transparent; border: 1px dashed var(--divider);
            color: var(--accent-color); transition: 0.2s;
        }
        .add-music-row:hover { background: var(--input-bg); border-color: var(--accent-color); }
        .add-music-icon { 
            width: 44px; height: 44px; border-radius: 8px; margin-right: 10px; 
            background: rgba(250, 45, 72, 0.1); display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* Other styles reused from your provided code... */
        .profile-avatar-large { width: 120px; height: 120px; border-radius: 50%; background: #eee; margin-bottom: 20px; background-size: cover; background-position: center; border: 4px solid var(--card-bg); position: relative; }
        .pill-toggle { background: var(--input-bg); padding: 4px; border-radius: 30px; display: inline-flex; position: relative; cursor: pointer; width: 200px; height: 40px; }
        .pill-bg { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: 32px; background: var(--bg-color); border-radius: 20px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pill-toggle[data-state="dark"] .pill-bg { transform: translateX(100%); }
        .pill-option { flex: 1; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .pill-option.active { color: var(--text-primary); }
    </style>
</head>
<body>

    <!-- Context Menu Modal -->
    <div id="context-menu-modal" onclick="closeContextMenu(event)">
        <div class="ctx-sheet" onclick="event.stopPropagation()">
            <div class="ctx-header" id="ctx-header">
                <!-- Injected via JS -->
            </div>
            <div class="ctx-grid" id="ctx-actions">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <div style="margin-bottom: 20px;"><img src="./images/logo.png" style="width: 50px; height: 50px; object-fit: contain;"></div>
            <h2 style="margin-bottom:10px; font-size:1.8rem;">歡迎使用 ASTRA</h2>
            <p style="color:var(--text-secondary); margin-bottom:30px; font-size: 0.95rem;">登入以同步您的音樂庫</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" class="input-style" placeholder="用戶名" required autocomplete="off">
                <input type="password" id="password" class="input-style" placeholder="密碼 (預設: 123)" required>
                <button type="submit" class="btn-primary" style="margin-top:15px;">繼續</button>
            </form>
        </div>
    </div>

    <!-- App View -->
    <section id="app-view" class="hidden">
        <nav class="sidebar">
            <div class="sidebar-logo"><img src="./images/logo.png" style="height: 36px; margin-right: 12px;">ASTRA Music</div>
            <div class="nav-item active" onclick="switchPage('home')" id="nav-home"><svg class="icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="nav-item" onclick="switchPage('search')" id="nav-search"><svg class="icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="nav-item" onclick="switchPage('database')" id="nav-database"><svg class="icon"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="nav-item" style="margin-top:auto" onclick="openSettings()"><svg class="icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </nav>

        <main class="main-content" onscroll="handleScroll()">
            <header class="content-header" id="main-header">
                <h1 id="current-page-title" style="font-size: 2rem; font-weight: 800;">首頁</h1>
                <div id="header-avatar" onclick="openProfileModal()" style="width: 40px; height: 40px; border-radius: 50%; background-size: cover; border: 2px solid var(--card-bg);"></div>
            </header>

            <div id="page-home" class="page-section active">
                <div style="height:250px; border-radius:24px; background:linear-gradient(120deg, #89f7fe, #66a6ff); padding:30px; margin-bottom:30px; color:white; display:flex; align-items:flex-end;">
                    <div><h1 style="font-size:2.5rem; margin-bottom:10px;">WE GO UP-EP</h1><p>BABYMONSTER</p></div>
                </div>
                <h2>為你推薦</h2>
                <div id="home-horizontal-container" style="margin-top:20px;"></div>
            </div>

            <div id="page-search" class="page-section">
                <input type="text" class="input-style" placeholder="搜尋..." oninput="handleSearchInput(event)">
                <div id="search-results-area" style="padding-top:20px;"></div>
            </div>

            <div id="page-database" class="page-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2>我的資料庫</h2>
                    <button onclick="openCreatePlaylistModal()" style="padding:8px 16px; background:var(--accent-color); color:white; border:none; border-radius:20px; font-weight:bold;">+ 新建</button>
                </div>
                <div id="playlists-container" class="grid-container"></div>
            </div>
        </main>

        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="switchPage('home')" id="mn-home">首頁</div>
            <div class="mobile-nav-item" onclick="switchPage('search')" id="mn-search">搜尋</div>
            <div class="mobile-nav-item" onclick="switchPage('database')" id="mn-database">資料庫</div>
        </div>

        <footer class="player-bar" id="player-bar">
            <div style="display:flex; align-items:center; width: 60%;">
                <div id="p-thumb" style="width:48px; height:48px; border-radius:10px; margin-right:12px; background-size:cover; background-color:#ccc;"></div>
                <div><h4 id="p-title" style="margin:0; font-size:0.9rem;">未播放</h4><p id="p-artist" style="margin:0; font-size:0.75rem; color:var(--text-secondary);">ASTRA</p></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="togglePlay()" id="playBtn" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-color); border:none; font-size:1.2rem;">▶</button>
            </div>
        </footer>
    </section>

    <!-- Playlist Detail Modal -->
    <div id="collection-detail-modal" class="fullscreen-modal" style="z-index:305;">
        <div class="modal-nav">
            <button onclick="closeCollectionDetail()" style="background:none; border:none; font-size:1.5rem;">←</button>
            <h2 id="cd-nav-title" style="font-size:1rem;">Title</h2>
            <div style="width:30px;"></div>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px;">
                <div id="cd-cover" style="width:180px; height:180px; margin:0 auto 20px; border-radius:20px; background-size:cover; background-color:#eee; box-shadow:var(--shadow-md);"></div>
                <h1 id="cd-title" style="font-size:1.6rem; margin-bottom:5px;">Name</h1>
                <p id="cd-subtitle" style="color:var(--text-secondary);">Subtitle</p>
                
                <div class="playlist-action-row">
                    <button class="playlist-play-btn" onclick="playCollectionAll(false)">
                        <svg class="icon" viewBox="0 0 24 24" style="margin-right:6px; width:20px; height:20px;"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor" stroke="none"></polygon></svg>
                        播放
                    </button>
                    <button class="playlist-shuffle-btn" onclick="playCollectionAll(true)">
                        <svg class="icon" viewBox="0 0 24 24" style="margin-right:6px; width:20px; height:20px;"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                        隨機
                    </button>
                </div>
            </div>
            <div id="cd-content-area"></div>
        </div>
    </div>

    <!-- Modals for Settings, Create Playlist etc -->
    <div id="select-playlist-modal" class="fullscreen-modal" style="z-index:320; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3>添加到播放清單</h3>
            <div id="playlist-selector-list" style="max-height:300px; overflow-y:auto; margin:20px 0;"></div>
            <button onclick="closePlaylistSelector()" style="width:100%; padding:12px; background:var(--input-bg); border:none; border-radius:12px;">取消</button>
        </div>
    </div>

    <div id="create-playlist-modal" class="fullscreen-modal" style="z-index:330; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">建立新清單</h3>
            <input type="text" id="new-playlist-name" class="input-style" placeholder="清單名稱">
            <button onclick="confirmCreatePlaylist()" class="btn-primary">建立</button>
            <button onclick="closeCreatePlaylistModal()" style="width:100%; margin-top:10px; background:none; border:none; padding:10px;">取消</button>
        </div>
    </div>

    <div id="settings-modal" class="fullscreen-modal">
        <div class="modal-nav"><h2>設定</h2><button onclick="closeSettings()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px;">完成</button></div>
        <div class="modal-body">
            <div style="margin-bottom:30px;"><p>外觀主題</p><div class="pill-toggle" id="theme-pill" onclick="toggleThemePill()"><div class="pill-bg"></div><div class="pill-option active" id="pill-light">淺色</div><div class="pill-option" id="pill-dark">深色</div></div></div>
            <button onclick="handleLogout()" class="btn-primary" style="background:var(--text-primary);">登出</button>
        </div>
    </div>
    
    <div id="profile-modal" class="fullscreen-modal" style="z-index:350;">
        <div class="modal-nav"><h2>個人帳戶</h2><button onclick="closeProfileModal()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px;">關閉</button></div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:40px;">
                <div id="profile-preview-large" class="profile-avatar-large"></div>
                <h2 id="profile-username-display">User</h2>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const DB_NAME = 'ASTRA_DB';
        const STORE_NAME = 'user_data';
        
        // Data
        const musicLibrary = [
            { id: 1, title: "WE GO UP", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song1.mp3" },
            { id: 2, title: "PSYCHO", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song2.mp3" },
            { id: 3, title: "SUPA DUPA LUV", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song3.mp3" },
            { id: 4, title: "WILD", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song4.mp3" }
        ];
        // Populate more demo data
        for(let i=5; i<=25; i++) musicLibrary.push({ id: i, title: `Demo Song ${i}`, artist: "Artist "+i, album: "Album "+(i%5), filename: "song.mp3" });

        const albumImages = { "WE GO UP-EP": "./images/albums/we_go_up_ep.jpg" };
        const DEFAULT_IMG = "https://cdn-icons-png.flaticon.com/512/3208/3208703.png";

        let currentUserData = null;
        let currentQueue = [];
        let currentSongIndex = -1;
        let currentCollectionSongs = [];
        let currentPlaylistId = null; 
        let songToAdd = null;
        let isSearchAddMode = false; // 用於判斷是從「添加音樂」按鈕進來的

        // DB Utils
        function openDB() { return new Promise((r,j)=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(STORE_NAME))db.createObjectStore(STORE_NAME,{keyPath:'username'});};q.onsuccess=e=>r(e.target.result);q.onerror=j;}); }
        async function saveUserToDB(u) { const db=await openDB(); return new Promise((r,j)=>{const t=db.transaction(STORE_NAME,'readwrite');t.objectStore(STORE_NAME).put(u);t.oncomplete=r;t.onerror=j;}); }
        async function getUserFromDB(n) { const db=await openDB(); return new Promise((r,j)=>{const t=db.transaction(STORE_NAME,'readonly');const q=t.objectStore(STORE_NAME).get(n);q.onsuccess=()=>r(q.result);q.onerror=j;}); }

        // Init
        window.onload = async () => {
            const u = localStorage.getItem('current_session_user');
            if(u) {
                currentUserData = await getUserFromDB(u);
                if(currentUserData) {
                    await checkFavoritesPlaylist(); // Ensure Favorite Playlist exists
                    initApp();
                } else document.getElementById('landing-page').classList.remove('hidden');
            } else document.getElementById('login-modal').classList.add('active');
            
            document.getElementById('audio-player').addEventListener('ended', playNext);
        };

        async function checkFavoritesPlaylist() {
            if (!currentUserData.playlists) currentUserData.playlists = [];
            let fav = currentUserData.playlists.find(p => p.id === 'favorites');
            if (!fav) {
                currentUserData.playlists.unshift({
                    id: 'favorites',
                    name: '喜好項目',
                    songs: [],
                    img: 'https://cdn-icons-png.flaticon.com/512/833/833472.png', // Heart Icon or similar
                    isSystem: true
                });
                await saveUserToDB(currentUserData);
            }
        }

        function initApp() {
            document.getElementById('login-modal').classList.remove('active');
            document.getElementById('app-view').classList.remove('hidden');
            updateUIFromUserData();
            renderHorizontalRows('home-horizontal-container', musicLibrary);
            renderPlaylists();
        }

        function updateUIFromUserData() {
            const ava = currentUserData.avatar || DEFAULT_IMG;
            document.getElementById('header-avatar').style.backgroundImage = `url(${ava})`;
            document.getElementById('profile-preview-large').style.backgroundImage = `url(${ava})`;
            document.getElementById('profile-username-display').innerText = currentUserData.username;
            updateThemeUI(currentUserData.theme || 'light');
        }

        function getImg(item) {
            if(item.album && albumImages[item.album]) return albumImages[item.album];
            return DEFAULT_IMG;
        }

        // --- Render Functions ---

        function createSongCardHTML(song) {
            const img = getImg(song);
            // 上下文按鈕 (右下角三個點)
            return `
            <div class="music-card" onclick="playSong(${song.id})">
                <div class="cover-art" style="background-image:url('${img}')">
                    <div class="menu-btn" onclick="openContextMenu(event, 'song', ${song.id})">
                        <svg class="icon" viewBox="0 0 24 24" style="width:18px; height:18px;"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </div>
                </div>
                <div style="font-weight:bold; font-size:0.95rem;">${song.title}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div>
            </div>`;
        }

        function renderHorizontalRows(cid, list) {
            const c = document.getElementById(cid); c.innerHTML = '';
            let html = '<div class="horizontal-section-wrapper"><div class="horizontal-row">';
            html += list.map(createSongCardHTML).join('');
            html += '</div></div>';
            c.innerHTML = html;
        }

        function renderPlaylists() {
            const c = document.getElementById('playlists-container');
            c.innerHTML = currentUserData.playlists.map(p => `
                <div class="music-card" onclick="openPlaylistDetail('${p.id}')">
                    <div class="cover-art" style="background-image:url('${p.img || DEFAULT_IMG}')"></div>
                    <div style="font-weight:bold; font-size:0.95rem;">${p.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">${p.songs.length} 首歌曲</div>
                </div>
            `).join('');
        }

        // --- Context Menu Logic ---
        
        function openContextMenu(e, type, data, contextPlaylistId = null) {
            e.stopPropagation();
            const modal = document.getElementById('context-menu-modal');
            const header = document.getElementById('ctx-header');
            const actions = document.getElementById('ctx-actions');
            let html = '';

            // 1. Song Context Menu
            if (type === 'song') {
                const song = musicLibrary.find(s => s.id === data);
                if(!song) return;
                const img = getImg(song);
                const isFav = isSongInFavorites(song.id);
                
                // Header
                header.innerHTML = `
                    <div class="ctx-thumb" style="background-image:url('${img}')"></div>
                    <div class="ctx-info"><h4>${song.title}</h4><p>${song.artist}</p></div>
                `;

                // Actions
                // Row 1: Add to Playlist | Favorites
                html += `
                <div class="ctx-row-split">
                    <button class="ctx-btn" onclick="openPlaylistSelector(event, ${song.id})">
                        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        加入
                    </button>
                    <button class="ctx-btn ${isFav?'danger':''}" onclick="toggleFavorite(${song.id})">
                        <svg viewBox="0 0 24 24" fill="${isFav?'currentColor':'none'}" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        ${isFav?'已喜好':'喜好'}
                    </button>
                </div>`;
                
                // Row 2: Play
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="playSong(${song.id})"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>播放</button></div>`;
                
                // Row 3: Shuffle (Song -> then shuffle others)
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="playSong(${song.id}, true)"><svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>隨機播放</button></div>`;
                
                // Row 4: Reduce Recommendation
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="reduceRec()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>減少推薦</button></div>`;

            } 
            // 2. Playlist Item Context Menu (In a playlist)
            else if (type === 'playlist_song') {
                const song = musicLibrary.find(s => s.id === data);
                if(!song) return;
                const img = getImg(song);
                const isFav = isSongInFavorites(song.id);
                
                header.innerHTML = `
                    <div class="ctx-thumb" style="background-image:url('${img}')"></div>
                    <div class="ctx-info"><h4>${song.title}</h4><p>${song.artist}</p></div>
                `;
                
                // Row 1: Favorites | Add to Other
                html += `
                <div class="ctx-row-split">
                    <button class="ctx-btn ${isFav?'danger':''}" onclick="toggleFavorite(${song.id})">
                        <svg viewBox="0 0 24 24" fill="${isFav?'currentColor':'none'}" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        ${isFav?'已喜好':'喜好'}
                    </button>
                    <button class="ctx-btn" onclick="openPlaylistSelector(event, ${song.id})">
                         <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        加入清單
                    </button>
                </div>`;

                // Row 2: Pin Song
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="pinSong('${contextPlaylistId}', ${song.id})"><svg viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>釘選歌曲</button></div>`;

                // Row 3: Go to Album
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="goToAlbum('${song.album}')"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="8" x2="12" y2="8"></line></svg>前往專輯</button></div>`;
                
                // Row 4: Reduce Rec
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="reduceRec()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>減少推薦</button></div>`;

                // Row 5: Remove from Playlist
                html += `<div class="ctx-row"><button class="ctx-btn danger" onclick="removeFromPlaylist('${contextPlaylistId}', ${song.id})"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>從清單移除</button></div>`;

            }
            // 3. Album Context Menu
            else if (type === 'album') {
                const albumName = data;
                header.innerHTML = `
                    <div class="ctx-thumb" style="background-image:url('${albumImages[albumName]||DEFAULT_IMG}')"></div>
                    <div class="ctx-info"><h4>${albumName}</h4><p>專輯</p></div>
                `;
                // Row 1: Add (All songs) | Favorites (Concept: Favorite an album)
                html += `
                <div class="ctx-row-split">
                    <button class="ctx-btn" onclick="alert('Demo: Added Album')"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>加入</button>
                    <button class="ctx-btn" onclick="alert('Demo: Fav Album')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>喜好項目</button>
                </div>`;
                // Row 2: Play Album
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="openAlbumDetail('${albumName}')"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>播放</button></div>`;
                // Row 3: Shuffle Album
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="alert('Shuffle Album')"><svg viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>隨機播放</button></div>`;
                // Row 4: Reduce Rec
                html += `<div class="ctx-row"><button class="ctx-btn" onclick="reduceRec()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>減少推薦</button></div>`;
            }

            actions.innerHTML = html;
            modal.classList.add('active');
        }

        function closeContextMenu(e) {
            document.getElementById('context-menu-modal').classList.remove('active');
        }

        // --- Playlist Logic ---

        function openPlaylistDetail(pid) {
            currentPlaylistId = pid;
            const pl = currentUserData.playlists.find(p => p.id == pid);
            if(!pl) return;
            
            document.getElementById('cd-nav-title').innerText = pl.name;
            document.getElementById('cd-title').innerText = pl.name;
            document.getElementById('cd-subtitle').innerText = `${pl.songs.length} 首歌曲`;
            document.getElementById('cd-cover').style.backgroundImage = `url(${pl.img || DEFAULT_IMG})`;

            const songs = pl.songs.map(sid => musicLibrary.find(s => s.id === sid)).filter(s=>s);
            currentCollectionSongs = songs;

            let html = songs.map(s => `
                <div class="song-list-item" onclick="playSong(${s.id})">
                    <div class="song-row-img" style="background-image:url('${getImg(s)}')"></div>
                    <div class="song-row-info">
                        <div class="song-row-title">${s.title}</div>
                        <div class="song-row-artist">${s.artist}</div>
                    </div>
                    <button class="list-menu-btn" onclick="openContextMenu(event, 'playlist_song', ${s.id}, '${pid}')">
                        <svg class="icon" viewBox="0 0 24 24" style="width:18px; height:18px;"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                    </button>
                </div>
            `).join('');

            // 添加音樂按鈕 (最下方)
            html += `
            <button class="add-music-row" onclick="startSearchForPlaylist()">
                <div class="add-music-icon">
                    <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2.5" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </div>
                <div style="font-weight:600; font-size:1rem;">添加音樂</div>
            </button>
            <div style="height:40px;"></div>`;

            document.getElementById('cd-content-area').innerHTML = html;
            document.getElementById('collection-detail-modal').classList.add('active');
        }

        // Logic for "Add Music" in playlist (skips selector)
        function startSearchForPlaylist() {
            closeCollectionDetail();
            isSearchAddMode = true;
            switchPage('search');
            document.querySelector('#page-search input').focus();
            document.getElementById('search-results-area').innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-secondary);">正在為「${getPlaylistName(currentPlaylistId)}」添加音樂<br>請搜尋歌曲...</div>`;
        }

        // Search Input Handling with "Add to Playlist" mode
        function handleSearchInput(e) {
            const v = e.target.value.toLowerCase();
            const res = document.getElementById('search-results-area');
            if(!v) return res.innerHTML = '';
            
            const songs = musicLibrary.filter(s => s.title.toLowerCase().includes(v));
            
            if(songs.length === 0) res.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">無結果</p>';
            else {
                res.innerHTML = '<div class="grid-container">' + songs.map(s => {
                    const img = getImg(s);
                    // 如果是搜尋添加模式，點擊直接加入
                    const action = isSearchAddMode 
                        ? `addSongToCurrentPlaylist(${s.id})` 
                        : `playSong(${s.id})`;
                    
                    return `
                    <div class="music-card" onclick="${action}">
                        <div class="cover-art" style="background-image:url('${img}')">
                            ${!isSearchAddMode ? `<div class="menu-btn" onclick="openContextMenu(event, 'song', ${s.id})">...</div>` : '<div class="menu-btn" style="opacity:1; background:var(--accent-color); color:white;">+</div>'}
                        </div>
                        <div style="font-weight:bold;">${s.title}</div>
                        <div style="font-size:0.8rem; color:#888;">${s.artist}</div>
                    </div>`;
                }).join('') + '</div>';
            }
        }

        async function addSongToCurrentPlaylist(sid) {
            if(!currentPlaylistId) return;
            const p = currentUserData.playlists.find(x => x.id == currentPlaylistId);
            if(p && !p.songs.includes(sid)) {
                p.songs.push(sid);
                await saveUserToDB(currentUserData);
                renderPlaylists();
                alert(`已加入 ${p.name}`);
                // Return to playlist
                isSearchAddMode = false;
                switchPage('database');
                openPlaylistDetail(currentPlaylistId);
            } else {
                alert("歌曲已存在");
            }
        }

        // --- Helper Actions ---
        
        async function toggleFavorite(sid) {
            let fav = currentUserData.playlists.find(p => p.id === 'favorites');
            if(fav.songs.includes(sid)) {
                fav.songs = fav.songs.filter(id => id !== sid);
            } else {
                fav.songs.unshift(sid);
            }
            await saveUserToDB(currentUserData);
            closeContextMenu();
            // Refresh if open
            if(currentPlaylistId === 'favorites') openPlaylistDetail('favorites');
        }

        function isSongInFavorites(sid) {
            const fav = currentUserData.playlists.find(p => p.id === 'favorites');
            return fav && fav.songs.includes(sid);
        }

        async function pinSong(pid, sid) {
            const p = currentUserData.playlists.find(x => x.id == pid);
            if(p) {
                // Remove existing index
                p.songs = p.songs.filter(id => id !== sid);
                // Unshift to top
                p.songs.unshift(sid);
                await saveUserToDB(currentUserData);
                closeContextMenu();
                openPlaylistDetail(pid);
            }
        }

        async function removeFromPlaylist(pid, sid) {
            if(!confirm("確定移除?")) return;
            const p = currentUserData.playlists.find(x => x.id == pid);
            if(p) {
                p.songs = p.songs.filter(id => id !== sid);
                await saveUserToDB(currentUserData);
                renderPlaylists();
                closeContextMenu();
                openPlaylistDetail(pid);
            }
        }

        function reduceRec() {
            closeContextMenu();
            alert("已減少此類推薦 (模擬)");
        }

        function goToAlbum(albumName) {
            closeContextMenu();
            closeCollectionDetail(); // Close playlist modal if open
            // Logic to open album detail (simplified for demo)
            alert("前往專輯: " + albumName);
        }

        // --- Player ---
        const player = document.getElementById('audio-player');
        
        function playSong(id, shuffle = false) {
            const song = musicLibrary.find(s=>s.id===id);
            if(shuffle) {
                // Randomize rest of library as queue
                currentQueue = [...musicLibrary].sort(()=>Math.random()-0.5);
                // Put selected song first
                currentQueue = [song, ...currentQueue.filter(s=>s.id!==id)];
            } else {
                currentQueue = [song]; // Simple play
            }
            currentSongIndex = 0;
            loadAndPlay();
            document.getElementById('player-bar').classList.add('active');
            closeContextMenu();
        }

        function playCollectionAll(shuffle) {
            if(!currentCollectionSongs.length) return;
            currentQueue = [...currentCollectionSongs];
            if(shuffle) currentQueue.sort(()=>Math.random()-0.5);
            currentSongIndex = 0;
            loadAndPlay();
            document.getElementById('player-bar').classList.add('active');
        }

        function loadAndPlay() {
            const s = currentQueue[currentSongIndex];
            player.src = `./music/${s.filename}`; // Demo path
            document.getElementById('p-title').innerText = s.title;
            document.getElementById('p-artist').innerText = s.artist;
            document.getElementById('p-thumb').style.backgroundImage = `url(${getImg(s)})`;
            player.play();
            document.getElementById('playBtn').innerText = "||";
        }

        function togglePlay() {
            if(player.paused) { player.play(); document.getElementById('playBtn').innerText = "||"; }
            else { player.pause(); document.getElementById('playBtn').innerText = "▶"; }
        }

        function playNext() {
            if(currentSongIndex < currentQueue.length - 1) {
                currentSongIndex++;
                loadAndPlay();
            }
        }

        // --- Nav & Standard Utils ---
        function switchPage(p) {
            document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(e=>e.classList.remove('active'));
            if(document.getElementById('nav-'+p)) document.getElementById('nav-'+p).classList.add('active');
            if(document.getElementById('mn-'+p)) document.getElementById('mn-'+p).classList.add('active');
            if(p!=='search') { isSearchAddMode=false; document.getElementById('search-results-area').innerHTML=''; document.querySelector('#page-search input').value=''; }
        }

        function handleScroll() {
            const h = document.getElementById('main-header');
            if(document.querySelector('.main-content').scrollTop > 10) h.classList.add('scrolled');
            else h.classList.remove('scrolled');
        }

        function handleLogin(e){ e.preventDefault(); const u=document.getElementById('username').value; const p={username:u,playlists:[],theme:'light'}; localStorage.setItem('current_session_user',u); currentUserData=p; saveUserToDB(p).then(()=>window.location.reload()); }
        function handleLogout(){ localStorage.removeItem('current_session_user'); window.location.reload(); }
        
        function openSettings(){ document.getElementById('settings-modal').classList.add('active'); document.getElementById('player-bar').classList.add('hidden'); }
        function closeSettings(){ document.getElementById('settings-modal').classList.remove('active'); document.getElementById('player-bar').classList.remove('hidden'); }
        function openProfileModal(){ document.getElementById('profile-modal').classList.add('active'); document.getElementById('player-bar').classList.add('hidden'); }
        function closeProfileModal(){ document.getElementById('profile-modal').classList.remove('active'); document.getElementById('player-bar').classList.remove('hidden'); }

        function toggleThemePill() { 
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            currentUserData.theme = isDark ? 'light' : 'dark';
            saveUserToDB(currentUserData);
            updateThemeUI(currentUserData.theme);
        }
        function updateThemeUI(t) {
            const p=document.getElementById('theme-pill');
            const m=document.getElementById('theme-color-meta');
            if(t==='dark') { document.body.setAttribute('data-theme','dark'); p.setAttribute('data-state','dark'); document.getElementById('pill-dark').classList.add('active'); document.getElementById('pill-light').classList.remove('active'); m.setAttribute('content','#000000'); }
            else { document.body.removeAttribute('data-theme'); p.setAttribute('data-state','light'); document.getElementById('pill-light').classList.add('active'); document.getElementById('pill-dark').classList.remove('active'); m.setAttribute('content','#FFFFFF'); }
        }
        
        function closeCollectionDetail() { document.getElementById('collection-detail-modal').classList.remove('active'); }
        function getPlaylistName(id) { const p = currentUserData.playlists.find(x=>x.id==id); return p?p.name:''; }

        // Create Playlist Modal Logic
        function openCreatePlaylistModal() { document.getElementById('create-playlist-modal').classList.add('active'); }
        function closeCreatePlaylistModal() { document.getElementById('create-playlist-modal').classList.remove('active'); }
        async function confirmCreatePlaylist() {
            const n = document.getElementById('new-playlist-name').value;
            if(!n) return;
            const newPl = { id: Date.now(), name: n, songs: [], img: null };
            currentUserData.playlists.push(newPl);
            await saveUserToDB(currentUserData);
            renderPlaylists();
            closeCreatePlaylistModal();
            if(songToAdd) {
                // If coming from context menu add
                newPl.songs.push(songToAdd);
                await saveUserToDB(currentUserData);
                closePlaylistSelector();
                alert("已建立並加入");
            }
        }
        
        // Playlist Selector (Context Menu -> Add to...)
        function openPlaylistSelector(e, sid) {
            closeContextMenu();
            songToAdd = sid;
            const l = document.getElementById('playlist-selector-list');
            l.innerHTML = `<div onclick="openCreatePlaylistModal()" style="padding:15px; color:var(--accent-color); font-weight:bold; cursor:pointer;">+ 建立新清單</div>` + 
                currentUserData.playlists.map(p => `<div onclick="addToPlaylistDirect('${p.id}')" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer;">${p.name}</div>`).join('');
            document.getElementById('select-playlist-modal').classList.add('active');
        }
        function closePlaylistSelector() { document.getElementById('select-playlist-modal').classList.remove('active'); }
        async function addToPlaylistDirect(pid) {
            const p = currentUserData.playlists.find(x=>x.id==pid);
            if(p && !p.songs.includes(songToAdd)) {
                p.songs.push(songToAdd);
                await saveUserToDB(currentUserData);
                renderPlaylists();
                alert("已加入");
            } else alert("已存在");
            closePlaylistSelector();
        }

    </script>
</body>
</html>
