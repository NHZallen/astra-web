<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASTRA Music</title>
    <link rel="icon" href="./images/logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* --- CSS 變數 --- */
        :root {
            --bg-color: #FFFFFF;
            --sidebar-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FA2D48;
            --accent-color-hover: #D41E36;
            --accent-color-light: rgba(250, 45, 72, 0.08);
            --divider: #E5E5E5;
            --player-bg: rgba(255, 255, 255, 0.85);
            --modal-bg: #FFFFFF;
            --input-bg: #F5F5F7;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.04);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.08);
            --radius-lg: 24px;
            --radius-md: 16px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 80px;
            --mobile-nav-height: 65px;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --sidebar-bg: #121212;
            --card-bg: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #A1A1A6;
            --accent-color-light: rgba(250, 45, 72, 0.2);
            --divider: #333333;
            --player-bg: rgba(28, 28, 30, 0.85);
            --modal-bg: #000000;
            --input-bg: #1C1C1E;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.6);
        }

        /* 全局隱藏捲軸 */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            overflow: hidden; height: 100vh; transition: background 0.3s, color 0.3s;
        }
        
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .input-style { width:100%; padding:16px; margin-bottom:12px; border-radius:14px; border:1px solid transparent; background:var(--input-bg); color:var(--text-primary); outline:none; font-size: 1rem; transition:0.2s; }
        .input-style:focus { background: var(--bg-color); border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-color-light); }
        
        .btn-primary { width:100%; padding:16px; background:var(--accent-color); color:white; border:none; border-radius:14px; font-weight:600; font-size:1rem; cursor:pointer; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        
        /* --- Landing Page Styles --- */
        #landing-page {
            height: 100vh; overflow-y: auto; overflow-x: hidden; z-index: 2000; position: relative;
            background-color: #FFFFFF; color: #1D1D1F;
            scroll-behavior: smooth;
        }

        /* Navbar */
        .lp-nav {
            position: fixed; top: 0; width: 100%; padding: 20px 40px; padding-top: calc(20px + var(--safe-top));
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 100; transition: 0.3s; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .lp-logo { font-weight: 700; font-size: 1.4rem; letter-spacing: -0.5px; display: flex; align-items: center; color: #000; }
        .lp-login-btn {
            padding: 10px 24px; background: #000; color: #fff; border-radius: 30px; 
            font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; transition: 0.2s;
        }
        .lp-login-btn:hover { transform: scale(1.05); background: #333; }

        /* Sections General */
        .lp-section { padding: 100px 40px; max-width: 1200px; margin: 0 auto; box-sizing: border-box; }
        
        /* Hero Section */
        .lp-hero {
            min-height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; 
            padding: 140px 40px 60px 40px; 
            position: relative;
            background: radial-gradient(circle at 50% 30%, rgba(250, 45, 72, 0.05) 0%, transparent 60%);
            width: 100%; box-sizing: border-box;
        }
        .hero-tag {
            color: var(--accent-color); font-weight: 700; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;
            margin-bottom: 24px; opacity: 0; animation: fadeUp 0.8s ease forwards;
        }
        .hero-title {
            font-size: 5rem; font-weight: 800; line-height: 1.05; letter-spacing: -2px; margin-bottom: 30px;
            color: #1D1D1F; opacity: 0; animation: fadeUp 0.8s ease 0.2s forwards;
            max-width: 900px; 
        }
        .hero-title span { background: linear-gradient(135deg, #FA2D48, #FF7657); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .hero-subtitle {
            font-size: 1.3rem; color: #86868B; max-width: 600px; margin: 0 auto 50px; line-height: 1.6;
            opacity: 0; animation: fadeUp 0.8s ease 0.4s forwards;
        }
        .hero-cta-group {
            display: flex; gap: 20px; justify-content: center; opacity: 0; animation: fadeUp 0.8s ease 0.6s forwards; width: 100%;
        }
        .btn-large {
            padding: 18px 45px; border-radius: 40px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-filled { background: #1D1D1F; color: white; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .btn-filled:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(0,0,0,0.25); }
        .btn-outlined { background: transparent; color: #1D1D1F; border: 1px solid #D2D2D7; }
        .btn-outlined:hover { border-color: #1D1D1F; background: #F5F5F7; }

        /* Marquee Strip */
        .marquee-strip {
            background: #FA2D48; color: white; padding: 15px 0; overflow: hidden; position: relative; width: 100%; transform: rotate(-2deg) scale(1.05); margin: 60px 0;
        }
        .marquee-content {
            display: flex; gap: 50px; white-space: nowrap; animation: scrollLeft 20s linear infinite; font-weight: 700; font-size: 1.2rem; letter-spacing: 1px;
        }
        @keyframes scrollLeft { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* App Showcase */
        .app-showcase {
            display: flex; justify-content: center; margin: 80px 0; perspective: 1000px; padding: 0 20px;
        }
        .phone-mockup {
            width: 320px; height: 640px; background: #FFF; border-radius: 45px; border: 12px solid #1D1D1F;
            position: relative; overflow: hidden; box-shadow: 0 50px 100px rgba(0,0,0,0.15);
            transform: rotateY(-10deg) rotateX(5deg); transition: 0.5s;
        }
        .phone-mockup:hover { transform: rotateY(0) rotateX(0) scale(1.02); }
        .screen-content {
            width: 100%; height: 100%; background: #F5F5F7; padding: 20px; display: flex; flex-direction: column;
        }
        /* Mock UI Elements */
        .mock-header { height: 40px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .mock-blob { width: 100%; height: 200px; border-radius: 20px; background: linear-gradient(135deg, #FA2D48, #FF9A9E); margin-bottom: 20px; box-shadow: 0 10px 20px rgba(250, 45, 72, 0.3); }
        .mock-line { height: 12px; background: #E5E5E5; border-radius: 6px; margin-bottom: 10px; }
        .mock-row { display: flex; gap: 10px; margin-top: 20px; }
        .mock-square { width: 80px; height: 80px; border-radius: 12px; background: #E5E5E5; }

        /* Features Grid */
        .features-section { background: #F5F5F7; border-radius: 40px; margin: 40px 20px; }
        .grid-layout {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 50px;
        }
        .feature-box {
            background: #FFFFFF; padding: 40px; border-radius: 24px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: flex-start;
            border: 1px solid transparent; opacity: 0; transform: translateY(30px);
        }
        .feature-box.visible { opacity: 1; transform: translateY(0); transition: 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .feature-box:hover { box-shadow: 0 20px 40px rgba(0,0,0,0.08); transform: translateY(-5px); }
        .f-icon { width: 50px; height: 50px; background: #F5F5F7; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; color: var(--accent-color); }
        
        /* Footer */
        .lp-footer { text-align: center; padding: 100px 30px; background: #FFF; border-top: 1px solid #F5F5F7; }
        .footer-logo { font-size: 2rem; font-weight: 800; margin-bottom: 20px; color: #1D1D1F; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Responsive & Fixes (KEY UPDATES) --- */
        @media (max-width: 768px) {
            /* 1. Landing Page Specific: Increase padding (30px) to prevent edge sticking */
            .lp-nav { 
                padding: 15px 30px; /* 增加左右間距 */
                padding-top: calc(15px + var(--safe-top)); 
            }
            
            .lp-hero { 
                /* 增加兩側 Padding 至 30px */
                padding: 120px 30px 60px 30px; 
                align-items: center; 
            }
            
            .lp-section { 
                /* 增加兩側 Padding 至 30px */
                padding: 80px 30px; 
            }

            .lp-footer {
                padding-left: 30px;
                padding-right: 30px;
            }
            
            /* Landing Page Typography Fixes */
            .hero-title { 
                font-size: 3rem; 
                margin-bottom: 20px; 
                word-wrap: break-word; 
                width: 100%;
            }
            .hero-subtitle { 
                font-size: 1rem; 
                padding: 0 5px;
            }
            
            /* Landing Page UI Fixes */
            .phone-mockup { width: 280px; height: 560px; transform: none; margin: 0 auto; border-width: 8px; }
            .phone-mockup:hover { transform: scale(1.02); }
            .hero-cta-group { flex-direction: column; width: 100%; max-width: 320px; margin: 0 auto; gap: 15px; }
            .btn-large { width: 100%; }
            .features-section { margin: 20px 10px; border-radius: 30px; padding: 60px 30px; }
            .feature-box { padding: 30px; }


            /* 2. App View Specific: KEEP at 20px (Original spacing) */
            .content-header { 
                left: 0; width: 100%; height: calc(60px + var(--safe-top));
                /* 維持 20px */
                padding: 0 20px; 
                padding-top: calc(10px + var(--safe-top)); 
            }
            
            .page-section { 
                /* 維持 20px */
                padding: 10px 20px 120px 20px; 
            }

            .mobile-nav { 
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; 
                height: calc(var(--mobile-nav-height) + var(--safe-bottom)); 
                background: var(--modal-bg); border-top: 1px solid var(--divider); 
                z-index: 120; justify-content: space-around; 
                padding-bottom: var(--safe-bottom); align-items: center; 
            }
            
            .sidebar { display: none; }
            .main-content { padding-top: calc(70px + var(--safe-top)); padding-bottom: 160px; }
            .player-bar { 
                bottom: calc(var(--mobile-nav-height) + var(--safe-bottom) + 12px); 
                left: 50%; transform: translateX(-50%) translateY(200%); width: 92%; border-radius: 18px; 
                height: 60px; padding: 0 15px; padding-bottom:0; box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            }
            .player-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* --- Login Modal & App Styles --- */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); z-index: 2500;
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        }
        #login-modal.active { opacity: 1; pointer-events: auto; }
        .login-box {
            background: #FFFFFF; width: 85%; max-width: 380px; padding: 40px 30px; border-radius: 30px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); transform: scale(0.95); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        #login-modal.active .login-box { transform: scale(1); }

        /* App styles */
        .sidebar-logo { 
            font-size: 1.3rem; font-weight: 800; margin-bottom: 40px; color: var(--accent-color); 
            padding-left: 10px; display: flex; align-items: center; white-space: nowrap; overflow: hidden;
        }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; }
        .profile-avatar-large {
            width: 120px; height: 120px; border-radius: 50%; background: #eee; margin-bottom: 20px;
            background-size: cover; background-position: center; box-shadow: var(--shadow-md); border: 4px solid var(--card-bg); position: relative;
        }
        .camera-icon-badge {
            position: absolute; bottom: 0; right: 0; width: 36px; height: 36px;
            background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; border: 3px solid var(--card-bg); cursor: pointer;
        }
        .change-avatar-btn {
            margin-top: 15px; padding: 10px 24px; font-size: 0.9rem; background: var(--input-bg); 
            border: none; border-radius: 20px; cursor: pointer; color: var(--text-primary); font-weight: 600; transition: 0.2s;
        }
        .change-avatar-btn:hover { background: #E5E5E5; }
        
        /* Layout */
        #app-view { display: flex; height: 100vh; width: 100%; }
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 40px 20px; padding-top: calc(40px + var(--safe-top)); display: flex; flex-direction: column; border-right: 1px solid var(--divider); flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; padding-top: var(--header-height); }
        .content-header { position: fixed; top: 0; left: 260px; width: calc(100% - 260px); height: var(--header-height); padding: 0 30px; padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center; z-index: 90; background: var(--bg-color); border-bottom: 1px solid transparent; transition: 0.3s; }
        .content-header.scrolled { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--divider); }
        [data-theme="dark"] .content-header.scrolled { background: rgba(0,0,0,0.8); }
        .nav-item { padding: 14px 20px; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; border-radius: 12px; margin-bottom: 5px; }
        .nav-item:hover { color: var(--text-primary); background: rgba(0,0,0,0.03); }
        .nav-item.active { background: var(--accent-color); color: white; box-shadow: 0 4px 15px var(--accent-color-light); }
        .nav-item svg { margin-right: 12px; flex-shrink: 0; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .music-card { position: relative; cursor: pointer; transition: 0.3s; }
        .music-card:hover { transform: translateY(-4px); }
        .cover-art { width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-md); margin-bottom: 10px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; background-size: cover; background-position: center; }
        [data-theme="dark"] .cover-art { background: linear-gradient(135deg, #2C2C2E, #3A3A3C); }
        .add-btn { position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: 0.2s; z-index: 5; color: black; }
        .music-card:hover .add-btn { opacity: 1; }
        .playlist-row { display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: var(--radius-md); margin-bottom: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .playlist-row:hover { border-color: var(--accent-color); background: var(--input-bg); }
        .playlist-cover-small { width: 56px; height: 56px; border-radius: 10px; margin-right: 15px; background: #eee; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .player-bar { position: fixed; height: 85px; background: var(--player-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 2000; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); padding-bottom: env(safe-area-inset-bottom); transform: translateY(200%); opacity: 0; }
        .player-bar.active { transform: translateY(0); opacity: 1; }
        @media (min-width: 769px) { .player-bar { bottom: 30px; right: 30px; width: calc(100% - 260px - 60px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding-bottom: 0; } }
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 300; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; padding-top: var(--safe-top); }
        .fullscreen-modal.active { transform: translateY(0); }
        .modal-nav { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); }
        .modal-body { flex: 1; overflow-y: auto; padding: 30px; max-width: 800px; margin: 0 auto; width: 100%; padding-bottom: 100px; }
        .mobile-nav-item { position: relative; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 500; width: 20%; height: 100%; transition: color 0.3s; }
        .mobile-nav-item.active { color: var(--accent-color); font-weight: 700; }
        .page-heading { font-size: 2rem; font-weight: 800; color: var(--text-primary); }
        .user-profile-btn { width: 40px; height: 40px; border-radius: 50%; background: #eee; cursor: pointer; background-size: cover; background-position: center; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid var(--card-bg); }
        .page-section { padding: 20px 30px 120px 30px; display: none; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        .search-container { position: relative; width: 100%; margin-bottom: 30px; }
        .search-history-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow-md); z-index: 20; display: none; border: 1px solid var(--divider); max-height: 300px; overflow-y: auto; }
        .search-history-dropdown.active { display: block; }
        .history-item { padding: 12px 18px; border-bottom: 1px solid var(--divider); cursor: pointer; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; }
        .pill-toggle { background: var(--input-bg); padding: 4px; border-radius: 30px; display: inline-flex; position: relative; cursor: pointer; width: 200px; height: 40px; }
        .pill-bg { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: 32px; background: var(--bg-color); border-radius: 20px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pill-toggle[data-state="dark"] .pill-bg { transform: translateX(100%); }
        .pill-option { flex: 1; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .pill-option.active { color: var(--text-primary); }
        .log-item { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--divider); }
    </style>
</head>
<body>

    <!-- Landing Page (Redesigned: Light, Clean, Premium) -->
    <section id="landing-page">
        <!-- Navigation -->
        <nav class="lp-nav">
            <div class="lp-logo">
                <img src="./images/logo.png" style="height: 30px; margin-right: 10px;">
                ASTRA
            </div>
            <button class="lp-login-btn" onclick="openLoginModal()">登入</button>
        </nav>

        <!-- Hero Section -->
        <div class="lp-hero">
            <div class="hero-tag">2025 全新體驗</div>
            <h1 class="hero-title">音樂，<br><span>前所未有的純粹</span></h1>
            <p class="hero-subtitle">拋開繁雜，回歸音樂本質。ASTRA Music 結合無損音質與極簡設計，為您打造專屬的雲端音樂殿堂。</p>
            <div class="hero-cta-group">
                <button class="btn-large btn-filled" onclick="openLoginModal()">立即開始使用</button>
                <button class="btn-large btn-outlined" onclick="document.querySelector('.features-section').scrollIntoView({behavior:'smooth'})">探索功能</button>
            </div>
        </div>

        <!-- Marquee -->
        <div class="marquee-strip">
            <div class="marquee-content">
                <span>LOSSLESS AUDIO</span> • <span>CLOUD SYNC</span> • <span>NO ADS</span> • <span>PURE MUSIC</span> • <span>ASTRA 2025</span> • 
                <span>LOSSLESS AUDIO</span> • <span>CLOUD SYNC</span> • <span>NO ADS</span> • <span>PURE MUSIC</span> • <span>ASTRA 2025</span> •
            </div>
        </div>

        <!-- App Showcase -->
        <div class="lp-section">
            <div style="text-align: center; margin-bottom: 50px;">
                <h2 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 15px;">跨裝置無縫體驗</h2>
                <p style="color: #86868B;">在您的 iPhone、iPad 與 Mac 上完美同步。</p>
            </div>
            <div class="app-showcase">
                <div class="phone-mockup">
                    <div class="screen-content">
                        <div class="mock-header">
                            <div style="width: 20px; height: 20px; border-radius: 50%; background: #E5E5E5;"></div>
                            <div style="width: 60px; height: 10px; border-radius: 5px; background: #E5E5E5;"></div>
                        </div>
                        <div class="mock-blob"></div>
                        <div class="mock-line" style="width: 60%;"></div>
                        <div class="mock-line" style="width: 40%;"></div>
                        <div class="mock-row">
                            <div class="mock-square"></div>
                            <div class="mock-square"></div>
                            <div class="mock-square"></div>
                        </div>
                        <div class="mock-row">
                            <div class="mock-square"></div>
                            <div class="mock-square"></div>
                            <div class="mock-square"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Grid -->
        <div class="lp-section features-section">
            <div style="text-align: center;">
                <h2 style="font-size: 2.2rem; font-weight: 700;">為什麼選擇 ASTRA？</h2>
            </div>
            <div class="grid-layout">
                <div class="feature-box">
                    <div class="f-icon">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"></path><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"></path></svg>
                    </div>
                    <h3 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 10px;">無損音質</h3>
                    <p style="color: #86868B; line-height: 1.6;">支援高解析度音訊格式，還原錄音室等級的細節，讓每一個音符都清晰入耳。</p>
                </div>
                <div class="feature-box" style="transition-delay: 0.1s;">
                    <div class="f-icon">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2-2.4-3.5-4.4-3.5h-1.2c-.5-3.2-3.2-5.6-6.4-5.6-3.7 0-6.7 2.6-7.3 6.3C.6 9.7 0 11.3 1 13c1.1 1.6 3 2.6 5 2.6h15.2z"></path></svg>
                    </div>
                    <h3 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 10px;">雲端資料庫</h3>
                    <p style="color: #86868B; line-height: 1.6;">採用 IndexedDB 本地優先技術，配合雲端備份，確保您的播放清單永不丟失。</p>
                </div>
                <div class="feature-box" style="transition-delay: 0.2s;">
                    <div class="f-icon">
                        <svg class="icon" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12" y2="18"></line></svg>
                    </div>
                    <h3 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 10px;">簡潔介面</h3>
                    <p style="color: #86868B; line-height: 1.6;">無廣告、無干擾。專注於最重要的功能，提供流暢、直覺的操作體驗。</p>
                </div>
            </div>
        </div>

        <!-- Footer CTA -->
        <div class="lp-footer">
            <div class="footer-logo">ASTRA</div>
            <h2 style="font-size: 2rem; margin-bottom: 30px;">準備好開始了嗎？</h2>
            <button class="btn-large btn-filled" onclick="openLoginModal()">免費註冊 / 登入</button>
            <p style="margin-top: 40px; font-size: 0.9rem; color: #86868B;">&copy; 2025 ASTRA Music. Designed for audiophiles.</p>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <div style="margin-bottom: 20px;">
                <img src="./images/logo.png" style="width: 50px; height: 50px; object-fit: contain;">
            </div>
            <h2 style="margin-bottom:10px; font-size:1.8rem;">歡迎使用 ASTRA</h2>
            <p style="color:var(--text-secondary); margin-bottom:30px; font-size: 0.95rem;">登入以同步您的音樂庫與個人設定</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" class="input-style" placeholder="用戶名" required autocomplete="off">
                <input type="password" id="password" class="input-style" placeholder="密碼 (預設: 123)" required>
                <button type="submit" class="btn-primary" style="margin-top:15px; box-shadow: 0 5px 15px rgba(250, 45, 72, 0.3);">繼續</button>
            </form>
            <button onclick="closeLoginModal()" style="margin-top:20px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">稍後再說</button>
        </div>
    </div>

    <!-- App View (Content Remains Same) -->
    <section id="app-view" class="hidden">
        <nav class="sidebar">
            <div class="sidebar-logo">
                <img src="./images/logo.png" style="height: 36px; vertical-align: middle; margin-right: 12px; flex-shrink: 0;">
                ASTRA Music
            </div>
            <div class="nav-item active" onclick="switchPage('home')" id="nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="nav-item" onclick="switchPage('search')" id="nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="nav-item" onclick="switchPage('discovery')" id="nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>新發現</div>
            <div class="nav-item" onclick="switchPage('database')" id="nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="nav-item" style="margin-top:auto" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </nav>

        <main class="main-content" onscroll="handleScroll()">
            <header class="content-header" id="main-header">
                <h1 class="page-heading" id="current-page-title">首頁</h1>
                <div class="user-profile-btn" id="header-avatar" onclick="openProfileModal()" style="background-image:url('https://cdn-icons-png.flaticon.com/512/847/847969.png')"></div>
            </header>

            <!-- A. Home -->
            <div id="page-home" class="page-section active">
                <div class="hero-banner" style="height:300px; border-radius:24px; background:linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%); display:flex; align-items:flex-end; padding:30px; margin-bottom:30px; color:white; position:relative; overflow:hidden;">
                    <div style="position:relative; z-index:2;">
                        <span style="background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:8px; font-size:0.8rem; font-weight:bold; backdrop-filter:blur(5px);">NEW RELEASE</span>
                        <h1 style="font-size:2.8rem; margin:10px 0;">WE GO UP-EP</h1>
                        <p style="opacity:0.9;">BABYMONSTER 全新專輯</p>
                        <button onclick="openAlbumDetail('WE GO UP-EP')" style="margin-top:15px; padding:12px 25px; background:white; color:black; border:none; border-radius:30px; font-weight:bold; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.2);">立即播放</button>
                    </div>
                    <div style="position:absolute; right:-20px; bottom:-40px; font-size:15rem; opacity:0.1; font-weight:900; pointer-events:none;">BM</div>
                </div>
                <h2>為你推薦</h2>
                <div class="grid-container" id="home-grid" style="margin-top:20px;"></div>
            </div>

            <!-- B. Search -->
            <div id="page-search" class="page-section">
                <div class="search-container">
                    <input type="text" id="search-input" class="input-style" placeholder="搜尋藝人、歌曲..." onfocus="showSearchHistory()" onkeydown="handleSearchKey(event)" style="padding:16px; font-size:1.1rem; margin-bottom:0;">
                    <div id="search-history-dropdown" class="search-history-dropdown"></div>
                </div>
                <div id="search-results-area">
                    <div style="color:var(--text-secondary); text-align:center; padding-top:20px;">輸入關鍵字並按下 Enter 搜尋</div>
                </div>
            </div>

            <!-- C. Discovery -->
            <div id="page-discovery" class="page-section">
                <h2 style="margin-bottom:20px;">最新發行</h2>
                <div class="grid-container" id="discovery-grid"></div>
            </div>

            <!-- D. Database -->
            <div id="page-database" class="page-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2>我的播放清單</h2>
                    <button onclick="openCreatePlaylistModal()" style="padding:8px 16px; background:var(--accent-color); color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">+ 新建清單</button>
                </div>
                <div id="playlists-container"></div>
            </div>
        </main>

        <!-- Mobile Nav -->
        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="switchPage('home')" id="mobile-nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="mobile-nav-item" onclick="switchPage('search')" id="mobile-nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="mobile-nav-item" onclick="switchPage('discovery')" id="mobile-nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>新發現</div>
            <div class="mobile-nav-item" onclick="switchPage('database')" id="mobile-nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="mobile-nav-item" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </div>

        <footer class="player-bar" id="player-bar">
            <div style="display:flex; align-items:center; width: 55%;">
                <div id="p-thumb" style="width:48px; height:48px; background:#ccc; border-radius:10px; margin-right:12px; background-size:cover;"></div>
                <div style="overflow:hidden;">
                    <h4 id="p-title" style="margin:0; font-size:0.9rem; white-space:nowrap;">未播放</h4>
                    <p id="p-artist" style="margin:0; font-size:0.75rem; color:var(--text-secondary);">ASTRA</p>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <button onclick="togglePlay()" id="playBtn" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-color); border:none; cursor:pointer; font-size:1.2rem;">▶</button>
                <button onclick="playNext()" style="background:none; border:none; color:var(--text-primary); cursor:pointer;">
                    <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="currentColor"><path d="M5 4l10 8-10 8V4z"></path><line x1="19" y1="5" x2="19" y2="19"></line></svg>
                </button>
            </div>
        </footer>
    </section>

    <!-- Modals (Profile, Settings, etc.) -->
    <div id="profile-modal" class="fullscreen-modal" style="z-index:350;">
        <div class="modal-nav"><h2>個人帳戶</h2><button onclick="closeProfileModal()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">關閉</button></div>
        <div class="modal-body">
            <div class="profile-header">
                <input type="file" id="profile-upload" accept="image/*" style="display:none;" onchange="handleProfileUpload(this)">
                <div id="profile-preview-large" class="profile-avatar-large" onclick="document.getElementById('profile-upload').click()">
                    <div class="camera-icon-badge"><svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></div>
                </div>
                <h2 id="profile-username-display">User</h2>
                <button class="change-avatar-btn" onclick="document.getElementById('profile-upload').click()">更換頭像</button>
            </div>
            <div style="margin-bottom:30px;"><input type="text" id="edit-username" class="input-style" placeholder="新使用者名稱"><button class="btn-primary" onclick="updateUsername()">更新名稱</button></div>
            <div style="margin-bottom:30px; border-top:1px solid var(--divider); padding-top:20px;"><input type="password" id="old-password" class="input-style" placeholder="舊密碼"><input type="password" id="new-password" class="input-style" placeholder="新密碼"><button class="btn-primary" style="background:#333;" onclick="updatePassword()">更新密碼</button></div>
        </div>
    </div>

    <div id="settings-modal" class="fullscreen-modal">
        <div class="modal-nav"><h2>設定</h2><button onclick="closeSettings()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">完成</button></div>
        <div class="modal-body">
            <div style="margin-bottom:30px;"><p style="margin-bottom:10px; font-weight:600;">外觀主題</p><div class="pill-toggle" id="theme-pill" onclick="toggleThemePill()"><div class="pill-bg"></div><div class="pill-option active" id="pill-light">淺色</div><div class="pill-option" id="pill-dark">深色</div></div></div>
            <div style="padding:20px 0; border-bottom:1px solid var(--divider); cursor:pointer;" onclick="showChangelog()"><div style="display:flex; justify-content:space-between;"><span>更新日誌</span><span style="color:var(--text-secondary);" id="setting-ver">v1.1.0 ></span></div></div>
            <button onclick="handleLogout()" style="margin-top:40px; width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">登出系統</button>
        </div>
    </div>

    <div id="changelog-modal" class="fullscreen-modal" style="z-index:310;">
        <div class="modal-nav"><h2>更新日誌</h2><button onclick="closeChangelog()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">關閉</button></div>
        <div class="modal-body" id="changelog-content"></div>
    </div>

    <div id="select-playlist-modal" class="fullscreen-modal" style="z-index:320; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">添加到播放清單</h3>
            <div id="playlist-selector-list" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="closePlaylistSelector()" style="width:100%; padding:12px; margin-top:20px; background:var(--input-bg); border:none; border-radius:12px; cursor:pointer; color:var(--text-primary);">取消</button>
        </div>
    </div>

    <div id="create-playlist-modal" class="fullscreen-modal" style="z-index:330; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">建立新清單</h3>
            <input type="text" id="new-playlist-name" class="input-style" placeholder="清單名稱">
            <div style="margin-bottom:20px;">
                <p style="margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">封面圖片 (選填)</p>
                <input type="file" id="new-playlist-img" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <div onclick="document.getElementById('new-playlist-img').click()" id="img-preview" style="width:100px; height:100px; background:var(--input-bg); border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover; background-position:center;"><span style="font-size:2rem; color:var(--text-secondary);">+</span></div>
            </div>
            <button onclick="confirmCreatePlaylist()" class="btn-primary">建立</button>
            <button onclick="closeCreatePlaylistModal()" style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:var(--text-secondary); cursor:pointer;">取消</button>
        </div>
    </div>

    <!-- Collection Detail Modal (Artist/Album/Playlist) -->
    <div id="collection-detail-modal" class="fullscreen-modal" style="z-index:305;">
        <div class="modal-nav">
            <button onclick="closeCollectionDetail()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-primary);">←</button>
            <h2 id="cd-nav-title" style="font-size:1.2rem;">Title</h2>
            <div style="width:30px;"></div>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:30px;">
                <div id="cd-cover" style="width:180px; height:180px; margin:0 auto 20px; border-radius:20px; background:#eee; background-size:cover; background-position:center; box-shadow:var(--shadow-md);"></div>
                <h1 id="cd-title" style="font-size:1.8rem; margin-bottom:5px;">Name</h1>
                <p id="cd-subtitle" style="color:var(--text-secondary);">Subtitle</p>
                <button onclick="playCollectionAll()" style="margin-top:20px; padding:12px 40px; background:var(--accent-color); color:white; border-radius:30px; border:none; font-weight:bold; cursor:pointer;">播放全部</button>
            </div>
            <h3 style="margin-bottom:15px; font-size:1.1rem;">歌曲列表</h3>
            <div id="cd-songs-list"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- 1. 定義歌手與專輯圖片對照表 (User-Editable Area) ---
        const artistImages = {
            "BABYMONSTER": "./images/artists/babymonster.jpg"
        };

        const albumImages = {
            "WE GO UP-EP": "./images/albums/we_go_up_ep.jpg"
        };

        const DEFAULT_ARTIST_IMG = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        const DEFAULT_ALBUM_IMG = "https://cdn-icons-png.flaticon.com/512/3208/3208703.png";

        // --- DB & Variables ---
        const DB_NAME = 'ASTRA_DB';
        const STORE_NAME = 'user_data';
        
        function openDB() { return new Promise((res, rej) => { const req = indexedDB.open(DB_NAME, 1); req.onupgradeneeded = e => { const db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'username' }); }; req.onsuccess = e => res(e.target.result); req.onerror = e => rej(e); }); }
        async function saveUserToDB(userObj) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(userObj); tx.oncomplete = () => res(); tx.onerror = () => rej(); }); }
        async function getUserFromDB(username) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readonly'); const req = tx.objectStore(STORE_NAME).get(username); req.onsuccess = () => res(req.result); req.onerror = () => rej(); }); }

        // --- Music Data ---
        const musicLibrary = [
            { id: 1, title: "WE GO UP", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song1.mp3", cover: "" },
            { id: 2, title: "PSYCHO", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song2.mp3", cover: "" },
            { id: 3, title: "SUPA DUPA LUV", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song3.mp3", cover: "" },
            { id: 4, title: "WILD", artist: "BABYMONSTER", album: "WE GO UP-EP", filename: "song4.mp3", cover: "" },
        ];
        
        let currentUserData = null; 
        let currentQueue = []; 
        let currentSongIndex = -1;
        let currentCollectionSongs = [];
        let songToAdd = null; 
        let tempImgBase64 = null;

        // --- Init ---
        window.onload = async function() {
            // Scroll Animation Trigger for Landing Page
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.feature-box').forEach(el => observer.observe(el));

            // Logic to check login
            const sessionUser = localStorage.getItem('current_session_user');
            if(sessionUser) {
                currentUserData = await getUserFromDB(sessionUser);
                if(currentUserData) {
                    if(!currentUserData.search_history) { currentUserData.search_history = []; saveUserToDB(currentUserData); }
                    document.getElementById('landing-page').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    initApp();
                } else localStorage.removeItem('current_session_user');
            }
            
            const player = document.getElementById('audio-player');
            player.addEventListener('ended', playNext); 
            if ('mediaSession' in navigator) {
                player.addEventListener('loadedmetadata', updateIOSPositionState);
                player.addEventListener('play', updateIOSPositionState);
                player.addEventListener('pause', updateIOSPositionState);
                player.addEventListener('ratechange', updateIOSPositionState);
                player.addEventListener('seeked', updateIOSPositionState);
            }
        };

        function initApp() {
            renderCards('home-grid', musicLibrary);
            renderCards('discovery-grid', [...musicLibrary].reverse());
            renderPlaylists();
            checkVersion();
            updateUIFromUserData();
            updateMobileNavActive('home');
        }

        function updateUIFromUserData() {
            updateThemeUI(currentUserData.theme || 'light');
            const avatarUrl = currentUserData.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            document.getElementById('header-avatar').style.backgroundImage = `url(${avatarUrl})`;
            document.getElementById('profile-preview-large').style.backgroundImage = `url(${avatarUrl})`;
            document.getElementById('profile-username-display').innerText = currentUserData.username;
        }

        // --- Helper: Get Images ---
        function getArtistImage(name) { return artistImages[name] || DEFAULT_ARTIST_IMG; }
        function getAlbumImage(name) { return albumImages[name] || DEFAULT_ALBUM_IMG; }
        function getSongCover(song) {
            if(song.cover) return song.cover;
            if(song.album && albumImages[song.album]) return albumImages[song.album];
            return DEFAULT_ALBUM_IMG;
        }

        // --- Navigation ---
        function switchPage(pid) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+pid)) document.getElementById('nav-'+pid).classList.add('active');
            updateMobileNavActive(pid);
            const titles = { 'home': '首頁', 'search': '搜尋', 'discovery': '新發現', 'database': '資料庫' };
            document.getElementById('current-page-title').innerText = titles[pid];
            if(pid !== 'search') document.getElementById('search-history-dropdown').classList.remove('active');
        }

        function updateMobileNavActive(pid) {
            document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
            const navId = 'mobile-nav-' + pid;
            const navEl = document.getElementById(navId);
            if(navEl) navEl.classList.add('active');
        }

        function handleScroll() {
            const header = document.getElementById('main-header');
            const mainContent = document.querySelector('.main-content');
            if(mainContent.scrollTop > 10) header.classList.add('scrolled');
            else header.classList.remove('scrolled');
        }

        // --- Player Logic ---
        const audioPlayer = document.getElementById('audio-player');
        let isPlaying = false;

        function playSong(id) {
            const song = musicLibrary.find(s => s.id === id);
            if(!song) return;
            currentQueue = [song]; 
            currentSongIndex = 0;
            playSongObject(song);
        }

        function playSongObject(song) {
            audioPlayer.src = `./music/${song.filename}`;
            document.getElementById('p-title').innerText = song.title;
            document.getElementById('p-artist').innerText = song.artist;
            const coverImage = getSongCover(song);
            document.getElementById('p-thumb').style.backgroundImage = `url('${coverImage}')`;
            
            audioPlayer.play()
                .then(() => {
                    isPlaying = true;
                    updatePlayBtn();
                    document.getElementById('player-bar').classList.add('active');
                    setupMediaSession(song, coverImage);
                })
                .catch(err => console.log("播放被阻擋:", err));
        }

        function togglePlay() {
            if(audioPlayer.src) {
                if(isPlaying) audioPlayer.pause(); else audioPlayer.play();
                isPlaying = !isPlaying;
                updatePlayBtn();
            }
        }

        function updatePlayBtn() {
            document.getElementById('playBtn').innerText = isPlaying ? "||" : "▶";
        }

        function playNext() {
            if(currentQueue.length > 0 && currentSongIndex < currentQueue.length - 1) {
                currentSongIndex++;
                playSongObject(currentQueue[currentSongIndex]);
            } else {
                const randomSong = musicLibrary[Math.floor(Math.random() * musicLibrary.length)];
                playSongObject(randomSong);
                currentQueue = [randomSong];
                currentSongIndex = 0;
            }
        }

        function setupMediaSession(song, coverImage) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.artist,
                    album: song.album,
                    artwork: [{ src: coverImage, sizes: '512x512', type: 'image/png' }]
                });
                navigator.mediaSession.setActionHandler('play', () => { audioPlayer.play(); isPlaying=true; updatePlayBtn(); });
                navigator.mediaSession.setActionHandler('pause', () => { audioPlayer.pause(); isPlaying=false; updatePlayBtn(); });
                navigator.mediaSession.setActionHandler('nexttrack', playNext);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    if (details.seekTime || details.seekTime === 0) {
                        audioPlayer.currentTime = details.seekTime;
                        updateIOSPositionState();
                    }
                });
                updateIOSPositionState();
            }
        }

        function updateIOSPositionState() {
            if ('mediaSession' in navigator && audioPlayer.duration && !isNaN(audioPlayer.duration)) {
                navigator.mediaSession.setPositionState({
                    duration: audioPlayer.duration,
                    playbackRate: audioPlayer.playbackRate,
                    position: audioPlayer.currentTime
                });
            }
        }

        // --- Search System ---
        function showSearchHistory() {
            const history = currentUserData.search_history || [];
            const dropdown = document.getElementById('search-history-dropdown');
            if(history.length === 0) dropdown.innerHTML = '<div style="padding:15px; text-align:center; color:var(--text-secondary);">無搜尋紀錄</div>';
            else dropdown.innerHTML = history.map(item => `<div class="history-item" onclick="performSearch('${item}')"><span><span class="history-icon">🕒</span> ${item}</span><span onclick="deleteHistory(event, '${item}')" style="font-size:1.2rem;">×</span></div>`).join('');
            dropdown.classList.add('active');
        }
        function handleSearchKey(event) { if(event.key === 'Enter') { const val = event.target.value.trim(); if(val) performSearch(val); event.target.blur(); } }

        async function performSearch(keyword) {
            document.getElementById('search-history-dropdown').classList.remove('active');
            document.getElementById('search-input').value = keyword;
            const area = document.getElementById('search-results-area');
            
            const matchedSongs = musicLibrary.filter(s => s.title.toLowerCase().includes(keyword.toLowerCase()));
            const matchedArtists = [...new Set(musicLibrary.filter(s => s.artist.toLowerCase().includes(keyword.toLowerCase())).map(s => s.artist))];
            const matchedAlbums = [...new Set(musicLibrary.filter(s => s.album.toLowerCase().includes(keyword.toLowerCase())).map(s => s.album))];
            
            let html = '';
            if(matchedArtists.length > 0) {
                html += `<div class="search-section-title">歌手</div><div class="grid-container">`;
                html += matchedArtists.map(artist => `<div class="artist-card" onclick="openArtistDetail('${artist}')"><div class="artist-img" style="background-image:url('${getArtistImage(artist)}')"></div><div style="font-weight:bold;">${artist}</div></div>`).join('');
                html += `</div>`;
            }
            if(matchedAlbums.length > 0) {
                html += `<div class="search-section-title">專輯</div><div class="grid-container">`;
                html += matchedAlbums.map(album => `<div class="music-card" onclick="openAlbumDetail('${album}')"><div class="cover-art" style="background-image:url('${getAlbumImage(album)}')"></div><div style="font-weight:bold; font-size:0.95rem;">${album}</div><div style="font-size:0.8rem; color:var(--text-secondary);">專輯</div></div>`).join('');
                html += `</div>`;
            }
            if(matchedSongs.length > 0) {
                html += `<div class="search-section-title">歌曲</div><div class="grid-container">`;
                html += matchedSongs.map(song => createSongCardHTML(song)).join('');
                html += `</div>`;
            }
            if(!html) html = `<div style="color:var(--text-secondary); text-align:center; padding-top:40px;">找不到 "${keyword}" 的結果</div>`;
            area.innerHTML = html;

            let history = currentUserData.search_history || [];
            history = history.filter(h => h !== keyword);
            history.unshift(keyword);
            if(history.length > 10) history = history.slice(0, 10);
            currentUserData.search_history = history;
            await saveUserToDB(currentUserData);
        }
        
        async function deleteHistory(e, item) { e.stopPropagation(); let history = currentUserData.search_history || []; history = history.filter(h => h !== item); currentUserData.search_history = history; await saveUserToDB(currentUserData); showSearchHistory(); }
        document.addEventListener('click', function(e) { const container = document.querySelector('.search-container'); if (container && !container.contains(e.target)) document.getElementById('search-history-dropdown').classList.remove('active'); });

        // --- Detail Views & Helpers ---
        function openCollectionDetail(title, subtitle, coverUrl, songs) {
            document.getElementById('cd-nav-title').innerText = title;
            document.getElementById('cd-title').innerText = title;
            document.getElementById('cd-subtitle').innerText = subtitle;
            document.getElementById('cd-cover').style.backgroundImage = `url(${coverUrl})`;
            const list = document.getElementById('cd-songs-list');
            list.innerHTML = songs.map(s => `<div class="playlist-row" onclick="playSong(${s.id})"><div style="font-weight:bold; flex:1;">${s.title}</div><div style="color:var(--text-secondary); font-size:0.9rem;">${s.artist}</div></div>`).join('');
            currentCollectionSongs = songs; 
            document.getElementById('collection-detail-modal').classList.add('active');
        }
        function closeCollectionDetail() { document.getElementById('collection-detail-modal').classList.remove('active'); }
        function openArtistDetail(artistName) { const songs = musicLibrary.filter(s => s.artist === artistName); openCollectionDetail(artistName, "歌手", getArtistImage(artistName), songs); }
        function openAlbumDetail(albumName) { const songs = musicLibrary.filter(s => s.album === albumName); const artist = songs.length > 0 ? songs[0].artist : "Unknown"; openCollectionDetail(albumName, `專輯 • ${artist}`, getAlbumImage(albumName), songs); }
        function openPlaylistDetail(plId) { const pl = currentUserData.playlists.find(p => p.id === plId); if(!pl) return; const songs = musicLibrary.filter(s => pl.songs.includes(s.id)); openCollectionDetail(pl.name, `${songs.length} 首歌曲`, pl.img || DEFAULT_ALBUM_IMG, songs); }
        function playCollectionAll() { if(currentCollectionSongs.length > 0) { currentQueue = [...currentCollectionSongs]; currentSongIndex = 0; playSongObject(currentQueue[0]); } }

        function createSongCardHTML(song) {
            const img = getSongCover(song);
            return `<div class="music-card" onclick="playSong(${song.id})"><div class="cover-art" style="background-image:url('${img}')"><div class="add-btn" onclick="openPlaylistSelector(event, ${song.id})"><svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div></div><div style="font-weight:bold; font-size:0.95rem; margin-bottom:2px;">${song.title}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div></div>`;
        }
        function renderCards(containerId, songs) { document.getElementById(containerId).innerHTML = songs.map(s => createSongCardHTML(s)).join(''); }
        function renderPlaylists() { const container = document.getElementById('playlists-container'); const playlists = currentUserData.playlists || []; if(playlists.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">尚未建立清單</div>'; return; } container.innerHTML = playlists.map(pl => `<div class="playlist-row" onclick="openPlaylistDetail(${pl.id})"><div class="playlist-cover-small" style="background-image:url(${pl.img || DEFAULT_ALBUM_IMG})"></div><div><div style="font-weight:bold;">${pl.name}</div><div style="font-size:0.8rem; color:var(--text-secondary);">${pl.songs.length} 首歌曲</div></div></div>`).join(''); }

        // --- Standard Functions (Login, Profile, Settings) ---
        function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
        function closeLoginModal() { document.getElementById('login-modal').classList.remove('active'); }
        async function handleLogin(e) { e.preventDefault(); const u = document.getElementById('username').value; const p = document.getElementById('password').value; let user = await getUserFromDB(u); if(user){ if(user.password===p){ currentUserData=user; localStorage.setItem('current_session_user',u); closeLoginModal(); document.getElementById('landing-page').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); initApp(); }else alert("密碼錯誤"); }else{ if(confirm("用戶不存在，是否立即註冊?")){ const n={username:u,password:p,avatar:null,playlists:[],theme:'light',search_history:[]}; await saveUserToDB(n); currentUserData=n; localStorage.setItem('current_session_user',u); closeLoginModal(); document.getElementById('landing-page').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); initApp(); } } }
        function handleLogout() { localStorage.removeItem('current_session_user'); location.reload(); }
        function openProfileModal() { document.getElementById('profile-modal').classList.add('active'); }
        function closeProfileModal() { document.getElementById('profile-modal').classList.remove('active'); }
        async function updateUsername() { const n = document.getElementById('edit-username').value; if(!n)return; const old=JSON.parse(JSON.stringify(currentUserData)); const ex=await getUserFromDB(n); if(ex)return alert("使用者名稱已存在"); const nw={...old,username:n}; await saveUserToDB(nw); const db=await openDB(); const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).delete(old.username); currentUserData=nw; localStorage.setItem('current_session_user',n); updateUIFromUserData(); alert("更新成功"); }
        async function updatePassword() { const o=document.getElementById('old-password').value; const n=document.getElementById('new-password').value; if(o!==currentUserData.password)return alert("舊密碼錯誤"); currentUserData.password=n; await saveUserToDB(currentUserData); alert("密碼已更新"); }
        function handleProfileUpload(i) { if(i.files&&i.files[0]){ const r=new FileReader(); r.onload=async function(e){ currentUserData.avatar=e.target.result; await saveUserToDB(currentUserData); updateUIFromUserData(); }; r.readAsDataURL(i.files[0]); } }
        function toggleThemePill() { const isDark=document.body.getAttribute('data-theme')==='dark'; currentUserData.theme=isDark?'light':'dark'; saveUserToDB(currentUserData); updateThemeUI(currentUserData.theme); }
        function updateThemeUI(t) { const p=document.getElementById('theme-pill'); const pl=document.getElementById('pill-light'); const pd=document.getElementById('pill-dark'); const m=document.getElementById('theme-color-meta'); if(t==='dark'){ document.body.setAttribute('data-theme','dark'); p.setAttribute('data-state','dark'); pl.classList.remove('active'); pd.classList.add('active'); m.setAttribute('content','#000000'); }else{ document.body.removeAttribute('data-theme'); p.setAttribute('data-state','light'); pd.classList.remove('active'); pl.classList.add('active'); m.setAttribute('content','#FFFFFF'); } }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
        async function checkVersion() { try{const r=await fetch('./changelog.json');const l=await r.json();if(l.length)document.getElementById('setting-ver').innerText=`v${l[0].version} >`;}catch(e){} }
        async function showChangelog() { const c=document.getElementById('changelog-content'); c.innerHTML='Loading...'; document.getElementById('changelog-modal').classList.add('active'); try{const r=await fetch('./changelog.json');const l=await r.json();c.innerHTML=l.map(x=>`<div class="log-item"><div class="log-ver">v${x.version}</div><div>${x.date}</div><p>${x.content}</p></div>`).join('');}catch(e){} }
        function closeChangelog() { document.getElementById('changelog-modal').classList.remove('active'); }
        function openPlaylistSelector(e,sid){ e.stopPropagation(); songToAdd=sid; if(!currentUserData.playlists.length){if(confirm("尚未建立清單，是否新建?"))openCreatePlaylistModal();return;} const l=document.getElementById('playlist-selector-list'); l.innerHTML=`<div onclick="openCreatePlaylistModal()" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer; color:var(--accent-color); font-weight:bold;">+ 建立新清單</div>`+currentUserData.playlists.map(p=>`<div onclick="addToPlaylist(${p.id})" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer;">${p.name}</div>`).join(''); document.getElementById('select-playlist-modal').classList.add('active'); }
        function closePlaylistSelector(){ document.getElementById('select-playlist-modal').classList.remove('active'); }
        function openCreatePlaylistModal(){ document.getElementById('select-playlist-modal').classList.remove('active'); document.getElementById('create-playlist-modal').classList.add('active'); tempImgBase64=null; document.getElementById('img-preview').style.backgroundImage=''; }
        function closeCreatePlaylistModal(){ document.getElementById('create-playlist-modal').classList.remove('active'); }
        function previewImage(i){ if(i.files&&i.files[0]){ const r=new FileReader(); r.onload=function(e){ tempImgBase64=e.target.result; document.getElementById('img-preview').style.backgroundImage=`url(${tempImgBase64})`; }; r.readAsDataURL(i.files[0]); } }
        async function confirmCreatePlaylist(){ const n=document.getElementById('new-playlist-name').value; if(!n)return alert("請輸入清單名稱"); const p={id:Date.now(),name:n,songs:[],img:tempImgBase64}; currentUserData.playlists.push(p); await saveUserToDB(currentUserData); renderPlaylists(); closeCreatePlaylistModal(); if(songToAdd)addToPlaylist(p.id); }
        async function addToPlaylist(pid){ const p=currentUserData.playlists.find(x=>x.id===pid); if(p&&!p.songs.includes(songToAdd)){ p.songs.push(songToAdd); await saveUserToDB(currentUserData); renderPlaylists(); alert("已加入清單"); }else alert("歌曲已存在於清單中"); closePlaylistSelector(); }
    </script>
</body>
</html>
