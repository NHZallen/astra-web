<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASTRA Music</title>
    <link rel="manifest" href="manifest.json">
    <!-- 預設主題色 (JS 會動態修改這裡) -->
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* --- CSS 變數 --- */
        :root {
            --bg-color: #FFFFFF;
            --sidebar-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FA2D48;
            --divider: #E5E5E5;
            --player-bg: rgba(255, 255, 255, 0.9);
            --modal-bg: #FFFFFF;
            --input-bg: #F0F0F0;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.1);
            --radius-lg: 24px;
            --radius-md: 16px;
            /* 安全區域變數 */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --sidebar-bg: #121212;
            --card-bg: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #A1A1A6;
            --divider: #333333;
            --player-bg: rgba(28, 28, 30, 0.9);
            --modal-bg: #000000;
            --input-bg: #1C1C1E;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            overflow: hidden; height: 100vh; transition: background 0.3s, color 0.3s;
            /* 讓背景色延伸到安全區域 */
            padding-top: var(--safe-top); 
        }
        
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- 1. Landing Page --- */
        #landing-page {
            height: 100%; overflow-y: auto; background: var(--bg-color); z-index: 2000; position: relative;
            scroll-behavior: smooth;
        }
        
        .lp-nav {
            position: sticky; top: 0; width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 100; transition: 0.3s;
        }
        [data-theme="dark"] .lp-nav { background: rgba(0,0,0,0.8); }
        
        .lp-hero {
            min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;
            background: radial-gradient(circle at 50% 30%, rgba(250, 45, 72, 0.15) 0%, transparent 70%);
        }
        .lp-title {
            font-size: 5rem; font-weight: 800; line-height: 1; margin-bottom: 20px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            opacity: 0; animation: fadeUp 1s ease forwards;
        }
        .lp-subtitle { opacity: 0; animation: fadeUp 1s ease 0.3s forwards; color: var(--text-secondary); margin-bottom: 30px; }
        .lp-btn { opacity: 0; animation: fadeUp 1s ease 0.6s forwards; padding: 15px 40px; border-radius: 50px; border: none; background: var(--accent-color); color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        
        .lp-features { padding: 100px 40px; max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
        .feature-card { padding: 40px; background: var(--sidebar-bg); border-radius: var(--radius-lg); transform: translateY(50px); opacity: 0; transition: 0.6s ease; }
        .feature-card.visible { transform: translateY(0); opacity: 1; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 2. App Layout --- */
        #app-view { display: flex; height: 100%; width: 100%; }

        .sidebar {
            width: 280px; background: var(--sidebar-bg); padding: 40px 20px; display: flex; flex-direction: column;
            border-right: 1px solid var(--divider); flex-shrink: 0;
        }
        .sidebar-logo { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; color: var(--accent-color); padding-left: 20px; }
        .nav-item { 
            padding: 16px 20px; color: var(--text-secondary); font-weight: 600; cursor: pointer; 
            transition: 0.2s; font-size: 1rem; display: flex; align-items: center; border-radius: 12px; margin-bottom: 5px;
        }
        .nav-item:hover, .nav-item.active { background: var(--input-bg); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-color); color: white; }
        .nav-item svg { margin-right: 15px; }

        .main-content { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page-section { padding: 40px; padding-bottom: 120px; display: none; animation: fadeIn 0.3s ease; min-height: 100%; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card System */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 24px; }
        .music-card { position: relative; cursor: pointer; transition: 0.3s; }
        .music-card:hover { transform: translateY(-5px); }
        .cover-art {
            width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-md); margin-bottom: 12px;
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5); display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
            background-size: cover; background-position: center;
        }
        [data-theme="dark"] .cover-art { background-color: #333; }
        .add-btn {
            position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0; transition: 0.2s; z-index: 5; color: black;
        }
        .music-card:hover .add-btn { opacity: 1; }

        /* Player Bar */
        .player-bar {
            position: fixed; height: 90px; background: var(--player-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; 
            z-index: 100; transition: 0.3s ease;
        }
        @media (min-width: 769px) { 
            .player-bar { bottom: 30px; right: 30px; width: calc(100% - 280px - 60px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
        }

        /* Database Styles */
        .playlist-row {
            display: flex; align-items: center; padding: 15px; background: var(--card-bg); border-radius: var(--radius-md);
            margin-bottom: 15px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .playlist-row:hover { border-color: var(--accent-color); transform: scale(1.01); }
        .playlist-icon { 
            width: 60px; height: 60px; background: var(--input-bg); border-radius: 12px; margin-right: 20px; 
            background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center;
        }
        
        /* Song List in Playlist Detail */
        .song-list-item {
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--divider); cursor: pointer; transition: 0.2s;
        }
        .song-list-item:hover { background: var(--input-bg); }
        .song-idx { color: var(--text-secondary); width: 30px; font-weight: bold; }

        /* Modals & Fullscreen */
        .fullscreen-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 300;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column;
            padding-top: var(--safe-top); /* Avoid notch */
        }
        .fullscreen-modal.active { transform: translateY(0); }
        .modal-nav { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); }
        .modal-body { flex: 1; overflow-y: auto; padding: 40px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* Custom Popup Modal (Create Playlist) */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 500;
            display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .popup-overlay.active { opacity: 1; pointer-events: auto; }
        .popup-box {
            background: var(--card-bg); width: 90%; max-width: 400px; padding: 30px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); transform: scale(0.9); transition: 0.3s;
        }
        .popup-overlay.active .popup-box { transform: scale(1); }

        /* Mobile Adjustments */
        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav {
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: calc(60px + var(--safe-bottom));
                background: var(--modal-bg); border-top: 1px solid var(--divider); z-index: 110; justify-content: space-around; 
                padding-bottom: var(--safe-bottom); align-items: center;
            }
            .mobile-nav-item { color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; flex: 1; }
            .mobile-nav-item.active { color: var(--accent-color); }
            .player-bar { bottom: calc(70px + var(--safe-bottom)); left: 50%; transform: translateX(-50%); width: 95%; border-radius: 20px; height: 70px; padding: 0 20px; }
            .main-content { padding-bottom: 200px; }
            .page-section { padding: 20px; padding-top: 60px; }
            .modal-nav { padding: 20px; }
            .lp-title { font-size: 3.5rem; }
            .lp-features { padding: 60px 20px; }
        }
    </style>
</head>
<body>

    <!-- Landing Page -->
    <section id="landing-page">
        <nav class="lp-nav">
            <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent-color);">ASTRA.</div>
            <button class="lp-btn" style="padding: 10px 25px; opacity: 1; animation: none;" onclick="openLoginModal()">登入</button>
        </nav>
        <div class="lp-hero">
            <h1 class="lp-title">探索<br>無限音頻宇宙</h1>
            <p class="lp-subtitle">ASTRA Music 帶您進入前所未有的聽覺盛宴。</p>
            <button class="lp-btn" onclick="openLoginModal()">立即開始</button>
        </div>
        <div class="lp-features">
            <div class="feature-card"><h3 style="margin-bottom:10px;">無損音質</h3><p style="color:var(--text-secondary)">極致的聽覺體驗，支援 Hi-Res 音訊。</p></div>
            <div class="feature-card"><h3 style="margin-bottom:10px;">個人資料庫</h3><p style="color:var(--text-secondary)">建立專屬播放清單，收藏您的最愛。</p></div>
            <div class="feature-card"><h3 style="margin-bottom:10px;">自訂義封面</h3><p style="color:var(--text-secondary)">上傳圖片，打造個性化音樂庫。</p></div>
        </div>
        <div style="height:100px;"></div>
    </section>

    <!-- App View -->
    <section id="app-view" class="hidden">
        <nav class="sidebar">
            <div class="sidebar-logo">ASTRA.</div>
            <div class="nav-item active" onclick="switchPage('home')" id="nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="nav-item" onclick="switchPage('search')" id="nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="nav-item" onclick="switchPage('discovery')" id="nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>新發現</div>
            <div class="nav-item" onclick="switchPage('database')" id="nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="nav-item" style="margin-top:auto" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </nav>

        <main class="main-content">
            <!-- A. 首頁 -->
            <div id="page-home" class="page-section active">
                <div style="height:350px; background: linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%); border-radius:24px; display:flex; align-items:flex-end; padding:40px; margin-bottom:40px; color:white;">
                    <div><h1>ASTRA Picks</h1><p>今日精選推薦，為你打造。</p></div>
                </div>
                <h2>為你推薦</h2>
                <div class="grid-container" id="home-grid" style="margin-top:20px;"></div>
            </div>

            <!-- B. 搜尋 -->
            <div id="page-search" class="page-section">
                <input type="text" placeholder="搜尋..." style="width:100%; padding:20px; background:var(--input-bg); border:none; border-radius:15px; font-size:1.1rem; color:var(--text-primary); outline:none; margin-bottom:30px;" oninput="handleSearch(this.value)">
                <div class="grid-container" id="search-grid"></div>
            </div>

            <!-- C. 新發現 -->
            <div id="page-discovery" class="page-section">
                <h2>每週新發現</h2>
                <div class="grid-container" id="discovery-grid" style="margin-top:20px;"></div>
            </div>

            <!-- D. 資料庫 (列表) -->
            <div id="page-database" class="page-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2>我的資料庫</h2>
                    <button onclick="openCreatePlaylistModal()" style="padding:10px 20px; background:var(--accent-color); color:white; border:none; border-radius:30px; font-weight:bold; cursor:pointer;">+ 新建清單</button>
                </div>
                <div id="playlists-container"></div>
            </div>

            <!-- E. 資料庫 (詳情) -->
            <div id="page-playlist-detail" class="page-section">
                <div style="margin-bottom:20px;">
                    <button onclick="switchPage('database')" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:1rem;">&larr; 返回資料庫</button>
                </div>
                <div style="display:flex; align-items:center; margin-bottom:40px;">
                    <div id="detail-cover" style="width:150px; height:150px; border-radius:20px; background:#eee; margin-right:30px; background-size:cover; background-position:center;"></div>
                    <div>
                        <h1 id="detail-name" style="margin-bottom:10px;"></h1>
                        <p id="detail-count" style="color:var(--text-secondary);"></p>
                    </div>
                </div>
                <div id="detail-songs-list"></div>
            </div>
        </main>

        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="switchPage('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="mobile-nav-item" onclick="switchPage('search')"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="mobile-nav-item" onclick="switchPage('database')"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="mobile-nav-item" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </div>

        <footer class="player-bar">
            <div style="display:flex; align-items:center;">
                <div id="p-thumb" style="width:50px; height:50px; background:#ccc; border-radius:10px; margin-right:15px; background-size:cover;"></div>
                <div><h4 id="p-title" style="margin:0; font-size:0.95rem;">未播放</h4><p id="p-artist" style="margin:0; font-size:0.8rem; color:var(--text-secondary);">ASTRA Music</p></div>
            </div>
            <button onclick="togglePlay()" id="playBtn" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-color); border:none; cursor:pointer;">▶</button>
        </footer>
    </section>

    <!-- Modals -->
    <div id="login-modal" class="popup-overlay">
        <div class="popup-box">
            <h2>歡迎回來</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" style="width:100%; padding:15px; margin:20px 0; background:var(--input-bg); border:none; border-radius:12px; color:var(--text-primary);" placeholder="用戶名" required>
                <input type="password" id="password" style="width:100%; padding:15px; margin-bottom:20px; background:var(--input-bg); border:none; border-radius:12px; color:var(--text-primary);" placeholder="密碼" required>
                <button type="submit" style="width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold;">登入</button>
            </form>
            <button onclick="document.getElementById('login-modal').classList.remove('active')" style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:var(--text-secondary);">取消</button>
        </div>
    </div>

    <div id="create-playlist-modal" class="popup-overlay">
        <div class="popup-box">
            <h2>新建播放清單</h2>
            <input type="text" id="new-pl-name" placeholder="清單名稱" style="width:100%; padding:15px; margin:20px 0; background:var(--input-bg); border:none; border-radius:12px; color:var(--text-primary);">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:10px; color:var(--text-secondary);">上傳封面 (可選)</label>
                <input type="file" id="new-pl-img" accept="image/*" style="width:100%;">
            </div>
            <button onclick="confirmCreatePlaylist()" style="width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold;">建立</button>
            <button onclick="document.getElementById('create-playlist-modal').classList.remove('active')" style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:var(--text-secondary);">取消</button>
        </div>
    </div>

    <div id="select-playlist-modal" class="fullscreen-modal" style="background:rgba(0,0,0,0.8); z-index:400; justify-content:center; align-items:center; padding:20px;">
        <div style="background:var(--card-bg); width:100%; max-width:400px; border-radius:24px; padding:30px; max-height:80vh; overflow-y:auto;">
            <h3 style="margin-bottom:20px;">添加到播放清單</h3>
            <div id="playlist-selector-list"></div>
            <div onclick="openCreatePlaylistModal(); document.getElementById('select-playlist-modal').classList.remove('active');" style="padding:15px; border-top:1px solid var(--divider); color:var(--accent-color); font-weight:bold; cursor:pointer; margin-top:10px;">
                + 新建清單
            </div>
            <button onclick="document.getElementById('select-playlist-modal').classList.remove('active')" style="width:100%; margin-top:20px; padding:12px; background:var(--input-bg); border:none; border-radius:12px; color:var(--text-primary);">取消</button>
        </div>
    </div>

    <div id="settings-modal" class="fullscreen-modal">
        <div class="modal-nav"><h2>設定</h2><button onclick="document.getElementById('settings-modal').classList.remove('active')" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; color:var(--text-primary);">完成</button></div>
        <div class="modal-body">
            <div style="margin-bottom:30px; display:flex; justify-content:space-between; align-items:center;">
                <span>深色模式</span>
                <input type="checkbox" id="theme-switch" onchange="toggleTheme()" style="transform:scale(1.5);">
            </div>
            <div onclick="showChangelog()" style="padding:20px 0; border-bottom:1px solid var(--divider); cursor:pointer; display:flex; justify-content:space-between;">
                <span>更新日誌</span><span style="color:var(--text-secondary);">查看 ></span>
            </div>
            <button onclick="handleLogout()" style="margin-top:40px; width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold;">登出</button>
        </div>
    </div>

    <div id="changelog-modal" class="fullscreen-modal" style="z-index:450;">
        <div class="modal-nav"><h2>更新日誌</h2><button onclick="document.getElementById('changelog-modal').classList.remove('active')" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; color:var(--text-primary);">關閉</button></div>
        <div class="modal-body" id="changelog-content"></div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- Data ---
        const musicLibrary = [
            { id: 1, title: "WE GO UP", artist: "BABYMONSTER", filename: "song1.mp3" },
            { id: 2, title: "PSYCHO", artist: "BABYMONSTER", filename: "song2.mp3" },
            { id: 3, title: "SUPA DUPA LUV", artist: "BABYMONSTER", filename: "song3.mp3" },
            { id: 4, title: "WILD", artist: "BABYMONSTER", filename: "song4.mp3" },
        ];
        let myPlaylists = JSON.parse(localStorage.getItem('astra_playlists')) || [];
        let songToAdd = null;
        let updateLogs = [];

        // --- Init ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
        });
        document.querySelectorAll('.feature-card').forEach(card => observer.observe(card));

        window.onload = async function() {
            // Load logs
            try {
                const res = await fetch('./changelog.json');
                updateLogs = await res.json();
            } catch(e) { console.log('No changelog found'); }

            // Theme Check
            if(localStorage.getItem('astra_theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('theme-switch').checked = true;
                updateMetaColor('#000000');
            } else {
                updateMetaColor('#FFFFFF');
            }

            // User Check
            if(localStorage.getItem('astra_user')) {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                initApp();
            }
        };

        function initApp() {
            renderCards('home-grid', musicLibrary);
            renderCards('search-grid', musicLibrary);
            renderCards('discovery-grid', [...musicLibrary].reverse());
            renderPlaylists();
        }

        // --- Theme Logic ---
        function toggleTheme() {
            const isDark = document.getElementById('theme-switch').checked;
            if(isDark) {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('astra_theme', 'dark');
                updateMetaColor('#000000');
            } else {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('astra_theme', 'light');
                updateMetaColor('#FFFFFF');
            }
        }
        function updateMetaColor(color) {
            document.getElementById('theme-color-meta').setAttribute('content', color);
        }

        // --- Core Render ---
        function renderCards(containerId, songs) {
            document.getElementById(containerId).innerHTML = songs.map(song => `
                <div class="music-card" onclick="playSong(${song.id})">
                    <div class="cover-art">
                        <div class="add-btn" onclick="openPlaylistSelector(event, ${song.id})">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </div>
                    </div>
                    <div style="font-weight:bold; font-size:0.95rem; margin-top:8px;">${song.title}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div>
                </div>
            `).join('');
        }

        // --- Database & Playlists ---
        function renderPlaylists() {
            const container = document.getElementById('playlists-container');
            if(myPlaylists.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-secondary);">暫無播放清單</div>`;
                return;
            }
            container.innerHTML = myPlaylists.map(pl => `
                <div class="playlist-row" onclick="openPlaylistDetail(${pl.id})">
                    <div class="playlist-icon" style="${pl.img ? 'background-image:url('+pl.img+')' : ''}">
                        ${!pl.img ? '<svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path></svg>' : ''}
                    </div>
                    <div>
                        <div style="font-weight:bold;">${pl.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">${pl.songs.length} 首歌曲</div>
                    </div>
                </div>
            `).join('');
        }

        function openCreatePlaylistModal() {
            document.getElementById('new-pl-name').value = '';
            document.getElementById('new-pl-img').value = '';
            document.getElementById('create-playlist-modal').classList.add('active');
        }

        function confirmCreatePlaylist() {
            const name = document.getElementById('new-pl-name').value;
            const fileInput = document.getElementById('new-pl-img');
            if(!name) return alert('請輸入名稱');

            const reader = new FileReader();
            reader.onload = function(e) {
                const newPl = { id: Date.now(), name: name, songs: [], img: e.target.result };
                myPlaylists.push(newPl);
                localStorage.setItem('astra_playlists', JSON.stringify(myPlaylists));
                document.getElementById('create-playlist-modal').classList.remove('active');
                renderPlaylists();
                // 如果是從加入歌曲流程來的，自動加入
                if(document.getElementById('select-playlist-modal').classList.contains('active')) {
                     openPlaylistSelector(null, songToAdd); // Refresh list
                }
            };

            if(fileInput.files[0]) {
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                // No image
                const newPl = { id: Date.now(), name: name, songs: [], img: null };
                myPlaylists.push(newPl);
                localStorage.setItem('astra_playlists', JSON.stringify(myPlaylists));
                document.getElementById('create-playlist-modal').classList.remove('active');
                renderPlaylists();
                 if(document.getElementById('select-playlist-modal').classList.contains('active')) {
                     openPlaylistSelector(null, songToAdd);
                }
            }
        }

        // --- Playlist Detail Logic (Fix: Click not working) ---
        function openPlaylistDetail(plId) {
            const pl = myPlaylists.find(p => p.id === plId);
            if(!pl) return;

            // 切換到詳情頁
            switchPage('playlist-detail');
            
            // 填充資料
            document.getElementById('detail-name').innerText = pl.name;
            document.getElementById('detail-count').innerText = `${pl.songs.length} 首歌曲`;
            document.getElementById('detail-cover').style.backgroundImage = pl.img ? `url(${pl.img})` : '';
            document.getElementById('detail-cover').style.backgroundColor = pl.img ? 'transparent' : '#eee';

            const list = document.getElementById('detail-songs-list');
            if(pl.songs.length === 0) {
                list.innerHTML = '<div style="padding:20px; color:var(--text-secondary);">這裡還沒有歌曲，快去加入吧！</div>';
            } else {
                list.innerHTML = pl.songs.map((sid, idx) => {
                    const song = musicLibrary.find(s => s.id === sid);
                    if(!song) return '';
                    return `
                        <div class="song-list-item" onclick="playSong(${song.id})">
                            <div class="song-idx">${idx+1}</div>
                            <div>
                                <div style="font-weight:600;">${song.title}</div>
                                <div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // --- Add to Playlist Flow ---
        function openPlaylistSelector(e, songId) {
            if(e) e.stopPropagation();
            songToAdd = songId;

            // Logic: If no playlists, force create
            if(myPlaylists.length === 0) {
                if(confirm('您還沒有播放清單，是否立即建立？')) {
                    openCreatePlaylistModal();
                }
                return;
            }

            const list = document.getElementById('playlist-selector-list');
            list.innerHTML = myPlaylists.map(pl => `
                <div onclick="addToPlaylist(${pl.id})" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer; display:flex; align-items:center;">
                    <div style="width:30px; height:30px; background:#ccc; border-radius:5px; margin-right:10px; background-size:cover; ${pl.img ? 'background-image:url('+pl.img+')' : ''}"></div>
                    ${pl.name}
                </div>
            `).join('');
            document.getElementById('select-playlist-modal').classList.add('active');
        }

        function addToPlaylist(plId) {
            const pl = myPlaylists.find(p => p.id === plId);
            if(pl && !pl.songs.includes(songToAdd)) {
                pl.songs.push(songToAdd);
                localStorage.setItem('astra_playlists', JSON.stringify(myPlaylists));
                renderPlaylists();
                alert(`已加入 "${pl.name}"`);
                document.getElementById('select-playlist-modal').classList.remove('active');
            } else {
                alert('歌曲已存在');
            }
        }

        // --- Changelog (Fix: Show all versions) ---
        function showChangelog() {
            const content = document.getElementById('changelog-content');
            if(updateLogs.length === 0) {
                content.innerHTML = '<p>暫無日誌資料</p>';
            } else {
                content.innerHTML = updateLogs.map(log => `
                    <div style="margin-bottom:30px; border-bottom:1px solid var(--divider); padding-bottom:20px;">
                        <h3 style="color:var(--accent-color);">v${log.version}</h3>
                        <p style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:10px;">${log.date}</p>
                        <div style="line-height:1.6;">${log.content}</div>
                    </div>
                `).join('');
            }
            document.getElementById('changelog-modal').classList.add('active');
        }

        // --- Player & Nav ---
        function playSong(id) {
            const song = musicLibrary.find(s => s.id === id);
            if(song) {
                document.getElementById('audio-player').src = `./music/${song.filename}`;
                document.getElementById('p-title').innerText = song.title;
                document.getElementById('p-artist').innerText = song.artist;
                document.getElementById('audio-player').play();
                document.getElementById('playBtn').innerText = "||";
            }
        }
        function togglePlay() {
            const player = document.getElementById('audio-player');
            if(player.src) {
                if(player.paused) { player.play(); document.getElementById('playBtn').innerText = "||"; }
                else { player.pause(); document.getElementById('playBtn').innerText = "▶"; }
            }
        }

        function switchPage(pid) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+pid)) document.getElementById('nav-'+pid).classList.add('active');
            // Reset scroll
            document.querySelector('.main-content').scrollTop = 0;
        }

        function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function handleLogin(e) { e.preventDefault(); localStorage.setItem('astra_user', 'user'); location.reload(); }
        function handleLogout() { localStorage.removeItem('astra_user'); location.reload(); }
        function handleSearch(v) { renderCards('search-grid', musicLibrary.filter(s=>s.title.toLowerCase().includes(v.toLowerCase()))); }
    </script>
</body>
</html>
