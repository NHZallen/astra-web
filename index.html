<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASTRA Music</title>
    <link rel="icon" href="./images/logo.png" type="image/png">
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* --- CSS 變數 --- */
        :root {
            --bg-color: #FFFFFF;
            --sidebar-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FA2D48;
            --accent-color-hover: #D41E36;
            --accent-color-light: rgba(250, 45, 72, 0.08);
            --divider: #E5E5E5;
            --player-bg: rgba(255, 255, 255, 0.85);
            --modal-bg: #FFFFFF;
            --input-bg: #F5F5F7;
            --context-menu-bg: rgba(255, 255, 255, 0.85);
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.04);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.08);
            --radius-lg: 24px;
            --radius-md: 16px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 80px;
            --mobile-nav-height: 65px;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --sidebar-bg: #121212;
            --card-bg: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #A1A1A6;
            --accent-color-light: rgba(250, 45, 72, 0.2);
            --divider: #333333;
            --player-bg: rgba(28, 28, 30, 0.85);
            --modal-bg: #000000;
            --input-bg: #1C1C1E;
            --context-menu-bg: rgba(30, 30, 30, 0.85);
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.6);
        }

        /* 全局隱藏捲軸 */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            overflow: hidden; 
            height: 100vh; 
            height: 100dvh; 
            transition: background 0.4s ease, color 0.4s ease;
            position: fixed; 
            width: 100%;
        }
        
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .input-style { width:100%; padding:16px; margin-bottom:12px; border-radius:14px; border:1px solid transparent; background:var(--input-bg); color:var(--text-primary); outline:none; font-size: 1rem; transition:0.2s; }
        .input-style:focus { background: var(--bg-color); border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-color-light); }
        
        .btn-primary { width:100%; padding:16px; background:var(--accent-color); color:white; border:none; border-radius:14px; font-weight:600; font-size:1rem; cursor:pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-primary:active { transform: scale(0.95); }
        
        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeSlideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes staggerList {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Landing Page Styles --- */
        #landing-page { height: 100%; overflow-y: auto; overflow-x: hidden; z-index: 2000; position: relative; background-color: #FFFFFF; color: #1D1D1F; scroll-behavior: smooth; }
        .lp-nav { position: fixed; top: 0; width: 100%; padding: 20px 40px; padding-top: calc(20px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 100; transition: 0.3s; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .lp-logo { font-weight: 700; font-size: 1.4rem; letter-spacing: -0.5px; display: flex; align-items: center; color: #000; }
        .lp-login-btn { padding: 10px 24px; background: #000; color: #fff; border-radius: 30px; font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
        .lp-section { padding: 100px 40px; max-width: 1200px; margin: 0 auto; }
        .lp-hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding-top: 120px; position: relative; background: radial-gradient(circle at 50% 30%, rgba(250, 45, 72, 0.05) 0%, transparent 60%); }
        .hero-tag { color: var(--accent-color); font-weight: 700; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 20px; opacity: 0; animation: fadeUp 0.8s ease forwards; }
        .hero-title { font-size: 5rem; font-weight: 800; line-height: 1.05; letter-spacing: -2px; margin-bottom: 30px; color: #1D1D1F; opacity: 0; animation: fadeUp 0.8s ease 0.2s forwards; }
        .hero-title span { background: linear-gradient(135deg, #FA2D48, #FF7657); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-subtitle { font-size: 1.3rem; color: #86868B; max-width: 600px; margin: 0 auto 50px; line-height: 1.5; opacity: 0; animation: fadeUp 0.8s ease 0.4s forwards; }
        .hero-cta-group { display: flex; gap: 20px; justify-content: center; opacity: 0; animation: fadeUp 0.8s ease 0.6s forwards; }
        .btn-large { padding: 18px 45px; border-radius: 40px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-filled { background: #1D1D1F; color: white; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .btn-outlined { background: transparent; color: #1D1D1F; border: 1px solid #D2D2D7; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) {
            .lp-nav { padding: 15px 30px; padding-top: calc(15px + var(--safe-top)); }
            .lp-hero { padding: 120px 30px 60px 30px; }
            .hero-title { font-size: 2.8rem; }
            .hero-cta-group { flex-direction: column; width: 100%; max-width: 300px; margin: 0 auto; }
            .btn-large { width: 100%; }
        }

        /* --- Login Modal --- */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.6); z-index: 2500; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.4s ease; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        #login-modal.active { opacity: 1; pointer-events: auto; }
        .login-box { background: #FFFFFF; width: 85%; max-width: 380px; padding: 40px 30px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.1); transform: scale(0.9); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid rgba(0,0,0,0.05); }
        #login-modal.active .login-box { transform: scale(1); }

        /* --- App Styles --- */
        .sidebar-logo { font-size: 1.3rem; font-weight: 800; margin-bottom: 40px; color: var(--accent-color); padding-left: 10px; display: flex; align-items: center; white-space: nowrap; overflow: hidden; }
        .profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; }
        .profile-avatar-large { 
            width: 120px; height: 120px; border-radius: 50%; background: #eee; margin-bottom: 20px; 
            background-size: cover !important; background-position: center !important; 
            box-shadow: var(--shadow-md); border: 4px solid var(--card-bg); position: relative; 
        }
        .camera-icon-badge { position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 3px solid var(--card-bg); cursor: pointer; }
        .change-avatar-btn { margin-top: 15px; padding: 10px 24px; font-size: 0.9rem; background: var(--input-bg); border: none; border-radius: 20px; cursor: pointer; color: var(--text-primary); font-weight: 600; transition: 0.2s; }
        
        #app-view { display: flex; height: 100%; width: 100%; position: absolute; top: 0; left: 0; }
        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 40px 20px; padding-top: calc(40px + var(--safe-top)); display: flex; flex-direction: column; border-right: 1px solid var(--divider); flex-shrink: 0; }
        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; padding-top: var(--header-height); -webkit-overflow-scrolling: touch; }
        .content-header { position: fixed; top: 0; left: 260px; width: calc(100% - 260px); height: var(--header-height); padding: 0 30px; padding-top: var(--safe-top); display: flex; justify-content: space-between; align-items: center; z-index: 90; background: var(--bg-color); border-bottom: 1px solid transparent; transition: 0.3s; }
        .content-header.scrolled { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--divider); }
        [data-theme="dark"] .content-header.scrolled { background: rgba(0,0,0,0.8); }
        .nav-item { padding: 14px 20px; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; border-radius: 12px; margin-bottom: 5px; }
        .nav-item:hover { color: var(--text-primary); background: rgba(0,0,0,0.03); }
        .nav-item.active { background: var(--accent-color); color: white; box-shadow: 0 4px 15px var(--accent-color-light); }
        .nav-item svg { margin-right: 12px; flex-shrink: 0; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        
        .horizontal-section-wrapper { margin-bottom: 20px; }
        .horizontal-row { display: flex; overflow-x: auto; gap: 16px; padding-bottom: 20px; margin-bottom: 20px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; }
        .horizontal-row::-webkit-scrollbar { display: none; }
        .horizontal-row .music-card { flex: 0 0 auto; width: 18%; min-width: 150px; scroll-snap-align: start; }

        .music-card { position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @media (hover: hover) {
            .music-card:hover { transform: translateY(-6px); }
        }
        .music-card:active { transform: scale(0.95); }

        .artist-card {
            flex: 0 0 auto; 
            width: 18%; 
            min-width: 140px; 
            scroll-snap-align: start;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        .artist-card:active { transform: scale(0.95); }
        .artist-img {
            width: 140px; 
            height: 140px; 
            border-radius: 50%;
            background-size: cover !important; 
            background-position: center !important; 
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--divider);
        }

        .cover-art { 
            width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-md); margin-bottom: 10px; 
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5); 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden; 
            background-size: cover !important; 
            background-position: center !important; 
        }
        [data-theme="dark"] .cover-art { background-image: linear-gradient(135deg, #2C2C2E, #3A3A3C); }
        
        .batch-select-overlay {
            position: absolute; top: 8px; left: 8px; width: 24px; height: 24px;
            background: rgba(255,255,255,0.9); border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid var(--text-secondary);
        }
        .music-card.edit-mode .batch-select-overlay { display: flex; }
        .music-card.selected .batch-select-overlay { background: var(--accent-color); border-color: var(--accent-color); }
        .music-card.selected .batch-select-overlay::after {
            content: ''; width: 10px; height: 5px; border-left: 2px solid white; border-bottom: 2px solid white;
            transform: rotate(-45deg); margin-top: -2px;
        }

        .ctx-btn { position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; z-index: 5; color: white; }
        .music-card:hover .ctx-btn { opacity: 1; }
        .music-card.edit-mode .ctx-btn { display: none; }
        @media (max-width: 768px) { .ctx-btn { opacity: 1; background: rgba(255,255,255,0.8); color: black; box-shadow: 0 2px 8px rgba(0,0,0,0.1); } [data-theme="dark"] .ctx-btn { background: rgba(0,0,0,0.6); color: white; } }

        .song-list-item { 
            display: flex; align-items: center; padding: 8px; border-radius: 12px; margin-bottom: 8px; 
            transition: 0.2s; cursor: pointer; background: transparent; overflow: hidden; position: relative; 
            animation: staggerList 0.4s ease forwards;
            opacity: 0;
        }
        .song-list-item:nth-child(1) { animation-delay: 0.05s; }
        .song-list-item:nth-child(2) { animation-delay: 0.1s; }
        .song-list-item:nth-child(3) { animation-delay: 0.15s; }
        .song-list-item:nth-child(4) { animation-delay: 0.2s; }
        .song-list-item:nth-child(5) { animation-delay: 0.25s; }
        .song-list-item:nth-child(n+6) { animation-delay: 0.3s; }

        .song-list-item:hover { background: var(--input-bg); transform: scale(1.01); }
        .song-list-item:active { transform: scale(0.99); }
        .song-row-img { width: 44px; height: 44px; border-radius: 8px; margin-right: 10px; background-size: cover !important; background-position: center !important; flex-shrink: 0; background-color: #eee; }
        .song-row-info { flex: 1; overflow: hidden; min-width: 0; margin-right: 10px; }
        .song-row-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .song-row-artist { color: var(--text-secondary); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .list-more-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .list-more-btn:hover { background: var(--divider); color: var(--text-primary); }

        /* --- Mini Player Bar (修正：增加 pointer-events 控制) --- */
        .player-bar { 
            position: fixed; height: 85px; background: var(--player-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 2000; 
            transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); padding-bottom: env(safe-area-inset-bottom); 
            transform: translateY(200%); opacity: 0; cursor: pointer; 
            pointer-events: none; /* 預設不可點擊 */
        }
        .player-bar.active { 
            transform: translateY(0); opacity: 1; 
            pointer-events: auto; /* 啟動時才可點擊 */
        }
        @media (min-width: 769px) { .player-bar { bottom: 30px; right: 30px; width: calc(100% - 260px - 60px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding-bottom: 0; } }

        /* --- Full Screen Player --- */
        #full-player {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(60px); -webkit-backdrop-filter: blur(60px);
            z-index: 3000; display: flex; flex-direction: column;
            transform: translateY(100%); 
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            color: white; overflow: hidden;
            touch-action: none;
        }
        #full-player.active { transform: translateY(0); }
        #full-player.dragging { transition: none; }
        
        .fp-bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; opacity: 0.4; filter: blur(100px); transition: background-image 0.5s; }
        
        .fp-header {
            display: flex; justify-content: center; align-items: center;
            padding: calc(10px + var(--safe-top)) 20px 20px 20px;
            position: relative; flex-shrink: 0;
            width: 100%;
        }
        .fp-header-pill { width: 40px; height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; cursor: pointer; position: absolute; top: calc(10px + var(--safe-top)); left: 50%; transform: translateX(-50%); transition: 0.2s; z-index: 20;}
        .fp-header-pill:active { background: rgba(255,255,255,0.6); transform: translateX(-50%) scaleX(1.1); }
        
        .fp-close-btn { 
            position: absolute; top: 25px; left: 30px; 
            width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center; 
            background: rgba(255,255,255,0.1); border-radius: 50%; 
            cursor: pointer; backdrop-filter: blur(10px); 
            z-index: 50; border: 1px solid rgba(255,255,255,0.15); 
            color: white; transition: 0.2s;
        }
        .fp-close-btn:hover { background: rgba(255,255,255,0.25); }
        @media (max-width: 768px) { .fp-close-btn { display: none !important; } }

        .fp-container { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; padding-top: 40px;} 
        
        .fp-view-main {
            flex: 1; display: flex; flex-direction: column; padding: 0 30px;
            padding-bottom: 120px; 
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .fp-view-main.shifted { transform: translateX(-20%); opacity: 0; pointer-events: none; }

        .fp-cover-container {
            flex: 1; display: flex; align-items: center; justify-content: center; min-height: 0;
            margin-bottom: 40px;
        }
        .fp-cover {
            width: 100%; max-width: 340px; aspect-ratio: 1/1;
            border-radius: 12px; background: #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            background-size: cover; background-position: center;
        }

        .fp-info-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 5px; }
        .fp-text { flex: 1; margin-right: 20px; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .fp-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; text-align: left; }
        .fp-artist { font-size: 1.1rem; color: rgba(255,255,255,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
        
        .fp-actions-top-right { display: flex; gap: 0; align-items: center; }
        .fp-icon-btn { background: none; border: none; color: rgba(255,255,255,0.7); cursor: pointer; padding: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .fp-icon-btn:active { transform: scale(0.9); }
        .fp-icon-btn.active { color: var(--accent-color); }
        .fp-icon-btn svg { width: 26px; height: 26px; stroke-width: 2px; }

        .fp-progress-container { width: 100%; margin-bottom: 20px; }
        
        /* [修改] 進度條樣式 - 仿圖二無段位 */
        .fp-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%; 
            height: 4px; /* 軌道高度 */
            background: rgba(255,255,255,0.2); /* 預設背景（未播放部分） */
            border-radius: 2px; 
            outline: none; 
            cursor: pointer;
            position: relative;
        }
        /* 滑塊樣式 */
        .fp-range::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 14px; /* 加大滑塊方便點擊 */
            height: 14px; 
            background: white; 
            border-radius: 50%; 
            transition: transform 0.1s;
            box-shadow: 0 0 10px rgba(0,0,0,0.3); 
        }
        .fp-range::-webkit-slider-thumb:active { transform: scale(1.3); }
        
        .fp-time-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: rgba(255,255,255,0.6); font-weight: 600; font-variant-numeric: tabular-nums; }

        .fp-controls { display: flex; justify-content: space-around; align-items: center; margin-bottom: 20px; padding: 0 10px; }
        .fp-ctrl-btn { background: none; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .fp-ctrl-btn:active { transform: scale(0.85); opacity: 0.7; }
        .fp-play-btn { width: 70px; height: 70px; background: transparent; border-radius: 50%; color: white; }
        .fp-play-btn svg { width: 45px; height: 45px; fill: white; stroke: none; }

        .fp-view-queue {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; 
            padding: 20px 30px;
            padding-top: 70px; 
            padding-bottom: 120px; 
            transform: translateX(100%); 
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease; 
            opacity: 0; pointer-events: none;
            z-index: 10;
        }
        .fp-view-queue.active { transform: translateX(0); opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            .fp-view-queue { padding-top: calc(40px + var(--safe-top)); }
        }

        .fp-queue-top-info {
            display: flex; align-items: center; 
            margin-bottom: 25px; 
            background: rgba(255,255,255,0.08);
            padding: 12px 16px; border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .fp-q-header-img {
            width: 56px; height: 56px; border-radius: 8px; margin-right: 15px;
            background-size: cover; background-position: center; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background-color: #333;
        }
        .fp-q-header-text { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .fp-q-header-text .t { font-size: 1.1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; color: white; }
        .fp-q-header-text .a { font-size: 0.9rem; color: rgba(255,255,255,0.7); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fp-q-header-actions { display: flex; gap: 8px; }

        .fp-options-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .fp-opt-btn {
            background: rgba(255,255,255,0.1); border-radius: 12px; border: none;
            padding: 12px 0; color: rgba(255,255,255,0.6); font-weight: 600; font-size: 0.75rem;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: 0.2s;
        }
        .fp-opt-btn.active { background: rgba(255,255,255,0.25); color: white; }
        .fp-opt-btn svg { width: 20px; height: 20px; }

        .fp-queue-list { flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .fp-queue-header { font-size: 1rem; font-weight: 700; margin-bottom: 15px; color: white; }
        .fp-q-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .fp-q-img { width: 40px; height: 40px; border-radius: 6px; background: #555; margin-right: 12px; background-size: cover; background-position: center; }
        .fp-q-info { flex: 1; }
        .fp-q-title { font-size: 0.9rem; font-weight: 600; color: white; }
        .fp-q-artist { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
        .fp-q-playing .fp-q-title { color: var(--accent-color); }

        .fp-bottom-row { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 110px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 40px; padding-bottom: 30px; z-index: 60; 
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 60%, transparent 100%);
            pointer-events: none; 
        }
        .fp-bottom-row .fp-icon-btn { pointer-events: auto; }

        @media (max-width: 768px) {
            .fp-bottom-row { padding: 0 30px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        }

        .fullscreen-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--modal-bg); z-index: 300; 
            transform: translateY(100%) scale(0.95); opacity: 0;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease; 
            display: flex; flex-direction: column; padding-top: var(--safe-top); 
        }
        .fullscreen-modal.active { transform: translateY(0) scale(1); opacity: 1; }
        
        .modal-nav { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); flex-shrink: 0; }
        .modal-body { flex: 1; overflow-y: auto; padding: 30px; max-width: 900px; margin: 0 auto; width: 100%; padding-bottom: 100px; }
        
        .page-section { padding: 20px 16px 120px 16px; display: none; opacity: 0; animation: none; }
        .page-section.active { display: block; animation: fadeSlideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .search-section-title { font-size: 1.2rem; font-weight: 700; margin-top: 20px; margin-bottom: 15px; color: var(--text-primary); }

        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .content-header { left: 0; width: 100%; padding: 0 20px; padding-top: calc(10px + var(--safe-top)); height: calc(60px + var(--safe-top)); }
            .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; height: calc(var(--mobile-nav-height) + var(--safe-bottom)); background: var(--modal-bg); border-top: 1px solid var(--divider); z-index: 120; justify-content: space-around; padding-bottom: var(--safe-bottom); align-items: center; }
            .mobile-nav-item { position: relative; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 500; width: 20%; height: 100%; transition: color 0.3s; }
            .mobile-nav-item.active { color: var(--accent-color); font-weight: 700; }
            .player-bar { bottom: calc(var(--mobile-nav-height) + var(--safe-bottom) + 12px); left: 50%; transform: translateX(-50%) translateY(200%); width: 92%; border-radius: 18px; height: 60px; padding: 0 15px; padding-bottom:0; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
            .player-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; }
            .main-content { padding-top: calc(70px + var(--safe-top)); padding-bottom: 160px; }
            .page-section { padding: 10px 16px 120px 16px; } 
            .horizontal-row .music-card { width: 45%; min-width: 130px; }
        }

        .page-heading { font-size: 2rem; font-weight: 800; color: var(--text-primary); transition: 0.3s; }
        .user-profile-btn { width: 40px; height: 40px; border-radius: 50%; background: #eee; cursor: pointer; background-size: cover !important; background-position: center !important; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid var(--card-bg); }
        .user-profile-btn:active { transform: scale(0.9); }
        
        .search-container { position: relative; width: 100%; margin-bottom: 30px; }
        .search-history-dropdown { position: absolute; top: 100%; left: 0; width: 100%; background: var(--card-bg); border-radius: 12px; box-shadow: var(--shadow-md); z-index: 20; display: none; border: 1px solid var(--divider); max-height: 300px; overflow-y: auto; }
        .search-history-dropdown.active { display: block; animation: fadeSlideUp 0.3s ease forwards; }
        .history-item { padding: 10px 18px; border-bottom: 1px solid var(--divider); cursor: pointer; color: var(--text-primary); display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .pill-toggle { background: var(--input-bg); padding: 4px; border-radius: 30px; display: inline-flex; position: relative; cursor: pointer; width: 200px; height: 40px; }
        .pill-bg { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: 32px; background: var(--bg-color); border-radius: 20px; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pill-toggle[data-state="dark"] .pill-bg { transform: translateX(100%); }
        .pill-option { flex: 1; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .pill-option.active { color: var(--text-primary); }

        /* --- CONTEXT MENU STYLES --- */
        .context-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9998; display: none;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        .context-menu-overlay.active { display: block; opacity: 1; }
        
        .context-menu {
            position: absolute;
            background: var(--context-menu-bg);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 16px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.25);
            width: 260px;
            padding: 8px;
            z-index: 9999;
            transform-origin: top left;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; gap: 4px;
        }
        .context-menu-overlay.active .context-menu { opacity: 1; transform: scale(1); }

        @media (max-width: 768px) {
            .context-menu {
                position: fixed; bottom: 20px; left: 3%; width: 94%;
                top: auto !important; transform-origin: bottom center;
                transform: translateY(120%);
                transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                border-radius: 20px;
            }
            .context-menu-overlay.active .context-menu { transform: translateY(0); }
        }

        .cm-row { display: flex; gap: 8px; }
        .cm-btn {
            flex: 1; padding: 12px; border-radius: 10px; background: transparent; border: none;
            color: var(--text-primary); font-size: 0.95rem; font-weight: 500; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s; text-align: left;
        }
        .cm-btn.full-width { justify-content: flex-start; padding-left: 15px; }
        .cm-btn:hover { background: var(--input-bg); transform: scale(1.02); }
        .cm-btn:active { background: rgba(0,0,0,0.1); transform: scale(0.98); }
        .cm-btn svg { margin-right: 10px; width: 20px; height: 20px; }
        .cm-btn.split svg { margin-right: 0; width: 22px; height: 22px; margin-bottom: 4px; }
        .cm-btn.split { flex-direction: column; font-size: 0.8rem; gap: 2px; }

        .playlist-header-actions { display: flex; gap: 15px; width: 100%; justify-content: center; margin-top: 20px; }
        .ph-btn {
            flex: 1; max-width: 180px; padding: 12px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .ph-btn.play { background: var(--accent-color); color: white; box-shadow: 0 4px 15px var(--accent-color-light); }
        .ph-btn.shuffle { background: var(--input-bg); color: var(--accent-color); }
        .ph-btn:active { transform: scale(0.95); }

        .add-music-bar {
            margin-top: 20px; width: 100%; padding: 15px;
            border-radius: 12px; border: 2px dashed rgba(250, 45, 72, 0.3);
            color: var(--accent-color); background: rgba(250, 45, 72, 0.03);
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .add-music-bar:hover { background: rgba(250, 45, 72, 0.08); border-color: var(--accent-color); transform: scale(1.01); }
        .add-music-bar:active { transform: scale(0.99); }
        .add-music-bar svg { margin-right: 8px; }

        #cd-cover {
            width: 180px; height: 180px; margin: 0 auto 20px; 
            border-radius: 20px; background: #eee; 
            background-size: cover !important; 
            background-position: center !important; 
            box-shadow: var(--shadow-md);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .cover-edit-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; cursor: pointer;
        }
        #cd-cover:hover .cover-edit-overlay { opacity: 1; }
        .cover-edit-overlay svg { color: white; width: 40px; height: 40px; }
        
        .tag-section-header { display: flex; align-items: center; margin-top: 30px; margin-bottom: 15px; }
        .tag-badge {
            background: var(--accent-color); color: white; padding: 4px 10px; border-radius: 6px; 
            font-size: 0.8rem; font-weight: bold; margin-left: 10px;
        }

        .batch-action-bar {
            display: none; justify-content: space-between; align-items: center;
            background: var(--accent-color); color: white;
            padding: 10px 20px; border-radius: 30px; margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(250, 45, 72, 0.3);
        }
        .batch-action-bar.active { display: flex; animation: fadeSlideUp 0.3s ease; }

        /* [新增] 藝人頁面垂直四排歌曲樣式 */
        .horizontal-grid-scroller {
            display: grid;
            grid-template-rows: repeat(4, auto); /* 垂直四排 */
            grid-auto-flow: column; /* 先填滿列，再往右延伸 */
            grid-auto-columns: calc((100% - 24px) / 3); /* 電腦版：寬度計算，約顯示3列(12首) */
            gap: 12px;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            scroll-snap-type: x mandatory;
        }
        .horizontal-grid-scroller::-webkit-scrollbar { display: none; }
        .horizontal-grid-scroller .song-list-item {
            scroll-snap-align: start;
            margin-bottom: 0;
            background: var(--input-bg); /* 讓它看起來像卡片 */
        }
        
        @media (max-width: 768px) {
            .horizontal-grid-scroller {
                grid-auto-columns: calc(100% - 20px); /* 手機版：寬度計算，約顯示1列(4首) */
            }
        }

        /* [新增] 圓形頭像成員列表樣式 */
        .member-avatar {
            display: flex; flex-direction: column; align-items: center;
            margin-right: 20px; cursor: pointer; min-width: 90px;
        }
        .member-avatar-img {
            width: 90px; height: 90px; border-radius: 50%;
            background-color: #eee; background-size: cover; background-position: center;
            margin-bottom: 8px; box-shadow: var(--shadow-sm); border: 1px solid var(--divider);
        }
        .member-name { font-size: 0.9rem; font-weight: 600; text-align: center; }

    </style>
</head>
<body>
    <!-- Context Menu Structure -->
    <div id="cm-overlay" class="context-menu-overlay" onclick="closeContextMenu()">
        <div id="context-menu" class="context-menu" onclick="event.stopPropagation()"></div>
    </div>

    <!-- Full Screen Player Modal (New Layout) -->
    <div id="full-player">
        <div class="fp-bg-layer" id="fp-bg"></div>
        
        <!-- Header -->
        <div class="fp-header" id="fp-drag-area">
            <button class="fp-close-btn" onclick="closeFullPlayer()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <div class="fp-header-pill" onclick="closeFullPlayer()"></div>
        </div>
        
        <div class="fp-container">
            <!-- View 1: Main -->
            <div class="fp-view-main" id="fp-view-main">
                <div class="fp-cover-container">
                    <div class="fp-cover" id="fp-cover-img"></div>
                </div>
                
                <div class="fp-info-row">
                    <div class="fp-text">
                        <div class="fp-title" id="fp-title">Song Title</div>
                        <div class="fp-artist" id="fp-artist">Artist Name</div>
                    </div>
                    <div class="fp-actions-top-right">
                        <button class="fp-icon-btn" id="fp-fav-btn" onclick="toggleCurrentFavorite(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                        <button class="fp-icon-btn" onclick="showContextMenu(event, 'song', {id: currentSongId})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                    </div>
                </div>

                <div class="fp-progress-container">
                    <input type="range" class="fp-range" id="fp-progress" min="0" value="0" step="0.01" oninput="seekAudio(this.value); updateRangeBackground(this)">
                    <div class="fp-time-labels">
                        <span id="fp-curr-time">0:00</span>
                        <span id="fp-total-time">-:--</span>
                    </div>
                </div>

                <div class="fp-controls">
                    <button class="fp-ctrl-btn" onclick="playPrev()">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 20L9 12l10-8v16zM5 19h2V5H5v14z"/></svg>
                    </button>
                    <button class="fp-ctrl-btn fp-play-btn" id="fp-play-btn" onclick="togglePlay()">
                        <svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                    </button>
                    <button class="fp-ctrl-btn" onclick="playNext()">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M5 4l10 8-10 8V4zM19 5h-2v14h2V5z"/></svg>
                    </button>
                </div>
            </div>

            <!-- View 2: Queue & Options -->
            <div class="fp-view-queue" id="fp-view-queue">
                <div class="fp-queue-top-info">
                    <div class="fp-q-header-img" id="fp-q-img"></div>
                    <div class="fp-q-header-text">
                        <div class="t" id="fp-q-title">Song</div>
                        <div class="a" id="fp-q-artist">Artist</div>
                    </div>
                    <div class="fp-q-header-actions">
                        <button class="fp-icon-btn" id="fp-q-fav-btn" onclick="toggleCurrentFavorite(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                        <button class="fp-icon-btn" onclick="showContextMenu(event, 'song', {id: currentSongId})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                    </div>
                </div>

                <div class="fp-options-grid">
                    <button class="fp-opt-btn" id="btn-shuffle" onclick="toggleShuffle()">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                        隨機播放
                    </button>
                    <button class="fp-opt-btn" id="btn-loop" onclick="toggleLoop()">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        <span id="txt-loop">循環</span>
                    </button>
                    <button class="fp-opt-btn" id="btn-auto" onclick="toggleAutoPlay()">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        自動播放
                    </button>
                    <button class="fp-opt-btn" id="btn-mix">
                        <svg class="icon" viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                        混音
                    </button>
                </div>

                <div class="fp-queue-list" id="fp-queue-list"></div>
            </div>
        </div>

        <div class="fp-bottom-row">
            <button class="fp-icon-btn">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            </button>
            <button class="fp-icon-btn" id="fp-queue-toggle-btn" onclick="togglePlayerView()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
        </div>
    </div>

    <!-- Landing Page -->
    <section id="landing-page">
        <nav class="lp-nav">
            <div class="lp-logo"><img src="./images/logo.png" style="height: 30px; margin-right: 10px;">ASTRA</div>
            <button class="lp-login-btn" onclick="openLoginModal()">登入</button>
        </nav>
        <div class="lp-hero">
            <div class="hero-tag">2025 全新體驗</div>
            <h1 class="hero-title">音樂<br><span>前所未有的純粹</span></h1>
            <p class="hero-subtitle">拋開繁雜，回歸音樂本質。ASTRA Music 結合無損音質與極簡設計，為您打造專屬的雲端音樂殿堂。</p>
            <div class="hero-cta-group">
                <button class="btn-large btn-filled" onclick="openLoginModal()">立即開始使用</button>
            </div>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <div style="margin-bottom: 20px;"><img src="./images/logo.png" style="width: 50px; height: 50px; object-fit: contain;"></div>
            <h2 style="margin-bottom:10px; font-size:1.8rem;">歡迎使用 ASTRA</h2>
            <p style="color:var(--text-secondary); margin-bottom:30px; font-size: 0.95rem;">登入以同步您的音樂庫與個人設定</p>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="username" class="input-style" placeholder="用戶名" required autocomplete="off">
                <input type="password" id="password" class="input-style" placeholder="密碼 (預設: 123)" required>
                <button type="submit" class="btn-primary" style="margin-top:15px; box-shadow: 0 5px 15px rgba(250, 45, 72, 0.3);">繼續</button>
            </form>
            <button onclick="closeLoginModal()" style="margin-top:20px; background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem;">稍後再說</button>
        </div>
    </div>

    <!-- App View -->
    <section id="app-view" class="hidden">
        <nav class="sidebar">
            <div class="sidebar-logo"><img src="./images/logo.png" style="height: 36px; vertical-align: middle; margin-right: 12px; flex-shrink: 0;">ASTRA Music</div>
            <div class="nav-item active" onclick="switchPage('home')" id="nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="nav-item" onclick="switchPage('search')" id="nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="nav-item" onclick="switchPage('discovery')" id="nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>新發現</div>
            <div class="nav-item" onclick="switchPage('database')" id="nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="nav-item" onclick="switchPage('settings')" id="nav-settings" style="margin-top:auto"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </nav>

        <main class="main-content" onscroll="handleScroll()">
            <header class="content-header" id="main-header">
                <h1 class="page-heading" id="current-page-title">首頁</h1>
                <div class="user-profile-btn" id="header-avatar" onclick="openProfileModal()" style="background-image:url('https://cdn-icons-png.flaticon.com/512/847/847969.png')"></div>
            </header>

            <!-- A. Home -->
            <div id="page-home" class="page-section active">
                <div class="hero-banner" style="height:300px; border-radius:24px; background:linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%); display:flex; align-items:flex-end; padding:30px; margin-bottom:30px; color:white; position:relative; overflow:hidden;">
                    <div style="position:relative; z-index:2;">
                        <span style="background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:8px; font-size:0.8rem; font-weight:bold; backdrop-filter:blur(5px);">NEW RELEASE</span>
                        <h1 style="font-size:2.8rem; margin:10px 0;">WE GO UP-EP</h1>
                        <p style="opacity:0.9;">BABYMONSTER 全新專輯</p>
                        <button onclick="openAlbumDetail('WE GO UP-EP')" style="margin-top:15px; padding:12px 25px; background:white; color:black; border:none; border-radius:30px; font-weight:bold; cursor:pointer; box-shadow:0 5px 15px rgba(0,0,0,0.2);">立即播放</button>
                    </div>
                </div>
                <h2>精選專輯</h2>
                <div id="home-album-container" class="horizontal-row" style="margin-top:15px;"></div>
                
                <h2>為你推薦</h2>
                <div id="home-horizontal-container" style="margin-top:20px;"></div>

                <div id="home-tags-container"></div>
            </div>

            <!-- B. Search -->
            <div id="page-search" class="page-section">
                <div class="search-container">
                    <input type="text" id="search-input" class="input-style" placeholder="搜尋藝人、歌曲、專輯..." onfocus="showSearchHistory()" oninput="handleSearchInput(event)" style="padding:16px; font-size:1.1rem; margin-bottom:0;">
                    <div id="search-history-dropdown" class="search-history-dropdown"></div>
                </div>
                <div id="search-results-area">
                    <div style="color:var(--text-secondary); text-align:center; padding-top:20px;">輸入關鍵字開始搜尋</div>
                </div>
            </div>

            <!-- C. Discovery -->
            <div id="page-discovery" class="page-section">
                <h2 style="margin-bottom:20px;">探索新聲</h2>
                <p style="color:var(--text-secondary); margin-bottom:20px;">挖掘那些您可能錯過的好音樂</p>
                <div id="discovery-horizontal-container"></div>
                <div id="discovery-tags-container"></div>
            </div>

            <!-- D. Database -->
            <div id="page-database" class="page-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2>我的播放清單</h2>
                    <div style="display:flex; gap:10px;">
                         <button id="batch-delete-toggle-btn" onclick="toggleBatchDeleteMode()" style="padding:8px 16px; background:var(--input-bg); color:var(--text-primary); border:none; border-radius:20px; font-weight:600; cursor:pointer;">編輯</button>
                         <button onclick="openCreatePlaylistModal()" style="padding:8px 16px; background:var(--accent-color); color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">+ 新建</button>
                    </div>
                </div>
                
                <div id="batch-action-bar" class="batch-action-bar">
                    <span id="batch-select-count">已選取 0 個項目</span>
                    <button onclick="executeBatchDelete()" style="background:white; color:var(--accent-color); border:none; padding:6px 15px; border-radius:15px; font-weight:bold; cursor:pointer;">刪除選取</button>
                </div>

                <div id="playlists-container" class="grid-container"></div>
            </div>

            <!-- E. Settings -->
            <div id="page-settings" class="page-section">
                <div style="margin-bottom:30px;">
                    <p style="margin-bottom:10px; font-weight:600;">外觀主題</p>
                    <div class="pill-toggle" id="theme-pill" onclick="toggleThemePill()">
                        <div class="pill-bg"></div>
                        <div class="pill-option active" id="pill-light">淺色</div>
                        <div class="pill-option" id="pill-dark">深色</div>
                    </div>
                </div>
                <button onclick="handleLogout()" style="margin-top:40px; width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">登出系統</button>
            </div>
        </main>

        <!-- Mobile Nav -->
        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="switchPage('home')" id="mobile-nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>首頁</div>
            <div class="mobile-nav-item" onclick="switchPage('search')" id="mobile-nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>搜尋</div>
            <div class="mobile-nav-item" onclick="switchPage('discovery')" id="mobile-nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>新發現</div>
            <div class="mobile-nav-item" onclick="switchPage('database')" id="mobile-nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>資料庫</div>
            <div class="mobile-nav-item" onclick="switchPage('settings')" id="mobile-nav-settings"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>設定</div>
        </div>

        <footer class="player-bar" id="player-bar" onclick="openFullPlayer()">
            <div style="display:flex; align-items:center; width: 55%;">
                <div id="p-thumb" style="width:48px; height:48px; background:#ccc; border-radius:10px; margin-right:12px; background-size:cover !important; background-position:center !important;"></div>
                <div style="overflow:hidden;">
                    <h4 id="p-title" style="margin:0; font-size:0.9rem; white-space:nowrap;">未播放</h4>
                    <p id="p-artist" style="margin:0; font-size:0.75rem; color:var(--text-secondary);">ASTRA</p>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;" onclick="event.stopPropagation()">
                <button onclick="togglePlay()" id="playBtn" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-color); border:none; cursor:pointer; font-size:1.2rem;">▶</button>
                <button onclick="playNext()" style="background:none; border:none; color:var(--text-primary); cursor:pointer;">
                    <svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="currentColor"><path d="M5 4l10 8-10 8V4z"></path><line x1="19" y1="5" x2="19" y2="19"></line></svg>
                </button>
            </div>
        </footer>
    </section>

    <!-- Modals -->
    <div id="profile-modal" class="fullscreen-modal" style="z-index:350;">
        <div class="modal-nav"><h2>個人帳戶</h2><button onclick="closeProfileModal()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">關閉</button></div>
        <div class="modal-body">
            <div class="profile-header">
                <input type="file" id="profile-upload" accept="image/*" style="display:none;" onchange="handleProfileUpload(this)">
                <div id="profile-preview-large" class="profile-avatar-large" onclick="document.getElementById('profile-upload').click()">
                    <div class="camera-icon-badge"><svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></div>
                </div>
                <h2 id="profile-username-display">User</h2>
                <button class="change-avatar-btn" onclick="document.getElementById('profile-upload').click()">更換頭像</button>
            </div>
            <div style="margin-bottom:30px;"><input type="text" id="edit-username" class="input-style" placeholder="新使用者名稱"><button class="btn-primary" onclick="updateUsername()">更新名稱</button></div>
            <div style="margin-bottom:30px; border-top:1px solid var(--divider); padding-top:20px;"><input type="password" id="old-password" class="input-style" placeholder="舊密碼"><input type="password" id="new-password" class="input-style" placeholder="新密碼"><button class="btn-primary" style="background:#333;" onclick="updatePassword()">更新密碼</button></div>
        </div>
    </div>

    <div id="select-playlist-modal" class="fullscreen-modal" style="z-index:320; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">添加到播放清單</h3>
            <div id="playlist-selector-list" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="closePlaylistSelector()" style="width:100%; padding:12px; margin-top:20px; background:var(--input-bg); border:none; border-radius:12px; cursor:pointer; color:var(--text-primary);">取消</button>
        </div>
    </div>

    <div id="create-playlist-modal" class="fullscreen-modal" style="z-index:330; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">建立新清單</h3>
            <input type="text" id="new-playlist-name" class="input-style" placeholder="清單名稱">
            <div style="margin-bottom:20px;">
                <p style="margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">封面圖片 (選填)</p>
                <input type="file" id="new-playlist-img" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <div onclick="document.getElementById('new-playlist-img').click()" id="img-preview" style="width:100px; height:100px; background:var(--input-bg); border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover; background-position:center;"><span style="font-size:2rem; color:var(--text-secondary);">+</span></div>
            </div>
            <button onclick="confirmCreatePlaylist()" class="btn-primary">建立</button>
            <button onclick="closeCreatePlaylistModal()" style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:var(--text-secondary); cursor:pointer;">取消</button>
        </div>
    </div>
    
    <div id="search-for-playlist-modal" class="fullscreen-modal" style="z-index:340;">
        <div class="modal-nav">
             <button onclick="closeSearchForPlaylist()" style="background:none; border:none; font-size:1.1rem; color:var(--accent-color);">取消</button>
             <h2 style="font-size:1rem;">加入歌曲</h2>
             <div style="width:40px;"></div>
        </div>
        <div class="modal-body" style="padding-top:10px;">
             <input type="text" id="playlist-add-search-input" class="input-style" placeholder="搜尋要加入的歌曲..." oninput="handlePlaylistAddSearch(event)">
             <div id="playlist-add-results" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="collection-detail-modal" class="fullscreen-modal" style="z-index:305;">
        <div class="modal-nav">
            <!-- [修改] 點擊返回時執行 handleModalBack -->
            <button onclick="handleModalBack()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-primary);">←</button>
            <h2 id="cd-nav-title" style="font-size:1.2rem;">Title</h2>
            <div style="width:30px;"></div>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:30px;">
                <div id="cd-cover" onclick="triggerCoverEdit()">
                    <div class="cover-edit-overlay">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                    </div>
                </div>
                <input type="file" id="playlist-cover-upload" accept="image/*" style="display:none;" onchange="handlePlaylistCoverUpdate(this)">
                
                <h1 id="cd-title" style="font-size:1.8rem; margin-bottom:5px;">Name</h1>
                <p id="cd-subtitle" style="color:var(--text-secondary);">Subtitle</p>
                <div class="playlist-header-actions">
                    <button class="ph-btn play" onclick="playCollectionAll(false)">
                        <svg class="icon" viewBox="0 0 24 24" style="fill:currentColor; stroke:none;"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> 播放
                    </button>
                    <button class="ph-btn shuffle" onclick="playCollectionAll(true)">
                        <svg class="icon" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg> 隨機播放
                    </button>
                </div>
            </div>
            <div id="cd-content-area"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- Data ---
        const artistImages = { "BABYMONSTER": "./images/artists/babymonster.jpg", "Ruka": "./images/artists/ruka.jpg", "Pharita": "./images/artists/pharita.jpg", "Asa": "./images/artists/asa.jpg", "Ahyeon": "./images/artists/ahyeon.jpg", "Rami": "./images/artists/rami.jpg", "Rora": "./images/artists/rora.jpg", "Chiquita": "./images/artists/chiquita.jpg" };
        const albumImages = { "WE GO UP-EP": "./images/albums/we_go_up_ep.jpg" };
        const DEFAULT_ARTIST_IMG = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        const DEFAULT_ALBUM_IMG = "https://cdn-icons-png.flaticon.com/512/3208/3208703.png";
        const DEFAULT_PLAYLIST_IMG = "https://cdn-icons-png.flaticon.com/512/3019/3019014.png";

        // [新增] 團體成員資料定義
        const artistMembers = {
            "BABYMONSTER": ["Ruka", "Pharita", "Asa", "Ahyeon", "Rami", "Rora", "Chiquita"]
        };

        const DB_NAME = 'ASTRA_DB';
        const STORE_NAME = 'user_data';
        
        function openDB() { return new Promise((res, rej) => { const req = indexedDB.open(DB_NAME, 2); req.onupgradeneeded = e => { const db = e.target.result; if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'username' }); }; req.onsuccess = e => res(e.target.result); req.onerror = e => rej(e); }); }
        async function saveUserToDB(userObj) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).put(userObj); tx.oncomplete = () => res(); tx.onerror = () => rej(); }); }
        async function getUserFromDB(username) { const db = await openDB(); return new Promise((res, rej) => { const tx = db.transaction(STORE_NAME, 'readonly'); const req = tx.objectStore(STORE_NAME).get(username); req.onsuccess = () => res(req.result); req.onerror = () => rej(); }); }

        const baseMusic = [
            { id: 1, title: "WE GO UP", artist: "BABYMONSTER", group: "BABYMONSTER", album: "WE GO UP-EP", filename: "song1.mp3", cover: "", tags: ["K-POP", "舞曲"] },
            { id: 2, title: "PSYCHO", artist: "BABYMONSTER", group: "BABYMONSTER", album: "WE GO UP-EP", filename: "song2.mp3", cover: "", tags: ["K-POP"] },
            { id: 3, title: "SUPA DUPA LUV", artist: "BABYMONSTER", group: "BABYMONSTER", album: "WE GO UP-EP", filename: "song3.mp3", cover: "", tags: ["K-POP", "R&B"] },
            { id: 4, title: "WILD", artist: "BABYMONSTER", group: "BABYMONSTER", album: "WE GO UP-EP", filename: "song4.mp3", cover: "", tags: ["K-POP"] },
            // 測試用：成員個人作品
            { id: 999, title: "Solo Demo", artist: "Ruka", group: "BABYMONSTER", album: "Solo Debut", filename: "song1.mp3", cover: "", tags: ["K-POP"] }
        ];
        
        let musicLibrary = [...baseMusic];
        const tagPool = ["華語", "西洋", "K-POP", "J-POP", "R&B", "搖滾", "嘻哈"];

        for(let i=5; i<=50; i++) {
            const randomTag = tagPool[Math.floor(Math.random() * tagPool.length)];
            const randomTag2 = Math.random() > 0.5 ? tagPool[Math.floor(Math.random() * tagPool.length)] : null;
            const tags = randomTag2 && randomTag2 !== randomTag ? [randomTag, randomTag2] : [randomTag];
            const isGroup = i % 2 === 0;
            
            musicLibrary.push({
                id: i,
                title: `Demo Song ${i}`,
                artist: isGroup ? "BABYMONSTER" : "Various Artist",
                group: isGroup ? "BABYMONSTER" : "Various Artist",
                album: `Demo Album ${Math.floor(i/5)}`,
                filename: "song1.mp3",
                cover: "",
                tags: tags 
            });
        }
        
        let currentUserData = null; 
        let currentQueue = []; 
        let currentSongIndex = -1;
        let currentCollectionSongs = [];
        let currentPlaylistId = null; 
        let itemsToAdd = []; 
        let tempImgBase64 = null;
        let addingToPlaylistId = null;
        
        let isShuffleMode = false;
        let loopMode = 0; 
        let isAutoPlay = false;
        let currentSongId = null; 

        let isBatchDeleteMode = false;
        let selectedPlaylists = new Set();
        
        // [新增] 導航堆疊變數
        let modalHistory = [];
        let currentModalState = null;

        // --- Init ---
        window.onload = async function() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.feature-box').forEach(el => observer.observe(el));

            const sessionUser = localStorage.getItem('current_session_user');
            if(sessionUser) {
                currentUserData = await getUserFromDB(sessionUser);
                if(currentUserData) {
                    if(!currentUserData.search_history) { currentUserData.search_history = []; }
                    if(!currentUserData.liked_songs) { currentUserData.liked_songs = []; } 
                    if(!currentUserData.disliked_songs) { currentUserData.disliked_songs = []; }
                    if(!currentUserData.play_counts) { currentUserData.play_counts = {}; }
                    if(!currentUserData.favorites_cover) { currentUserData.favorites_cover = null; }

                    saveUserToDB(currentUserData);
                    document.getElementById('landing-page').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    initApp();
                } else localStorage.removeItem('current_session_user');
            }
            
            const player = document.getElementById('audio-player');
            player.addEventListener('ended', handleSongEnd); 
            player.addEventListener('timeupdate', updateProgress);
            
            setupDragToClose(); 

            if ('mediaSession' in navigator) {
                player.addEventListener('play', () => updateMediaSessionPosition());
                player.addEventListener('pause', () => updateMediaSessionPosition());
            }
        };

        function initApp() {
            const recommended = getSmartRecommendations();
            renderHorizontalRows('home-horizontal-container', recommended);
            renderAlbumSection();
            
            const discoveries = getDiscoveryRecommendations();
            renderHorizontalRows('discovery-horizontal-container', discoveries);
            
            renderTagSections('home-tags-container', musicLibrary); 
            renderTagSections('discovery-tags-container', musicLibrary, true); 
            
            renderPlaylists();
            updateUIFromUserData();
            updateMobileNavActive('home');
        }

        // --- Drag to Close Logic ---
        function setupDragToClose() {
            const player = document.getElementById('full-player');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            player.addEventListener('touchstart', (e) => {
                const queueView = document.getElementById('fp-view-queue');
                const queueList = document.getElementById('fp-queue-list');
                
                if (queueView.classList.contains('active') && queueList.scrollTop > 5) return;

                startY = e.touches[0].clientY;
                if (startY < 200) {
                     isDragging = true;
                     player.classList.add('dragging');
                }
            }, {passive: true});

            player.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                
                if (diff > 0) {
                    player.style.transform = `translateY(${diff}px)`;
                    document.getElementById('fp-bg').style.opacity = Math.max(0, 0.4 - (diff/1000));
                }
            }, {passive: true});

            player.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                player.classList.remove('dragging');
                
                const diff = currentY - startY;
                if (diff > 120) { 
                    closeFullPlayer();
                } else {
                    player.style.transform = '';
                    document.getElementById('fp-bg').style.opacity = '0.4';
                }
                currentY = 0;
            });
        }

        function renderTagSections(containerId, sourceLibrary, isDiscovery = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const allTags = [...new Set(sourceLibrary.flatMap(s => s.tags || []))].filter(t => t);
            allTags.forEach(tag => {
                let songs = sourceLibrary.filter(s => s.tags && s.tags.includes(tag));
                if (songs.length > 0) {
                    if(isDiscovery) { songs.sort(() => Math.random() - 0.5); songs = songs.slice(0, 10); } 
                    else { songs = songs.slice(0, 15); }
                    if(songs.length === 0) return;
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'search-section-title tag-section-header';
                    titleDiv.innerHTML = `${tag} <span class="tag-badge">${isDiscovery ? '新發現' : '精選'}</span>`;
                    container.appendChild(titleDiv);
                    const wrapper = document.createElement('div');
                    wrapper.className = 'horizontal-section-wrapper';
                    const row = document.createElement('div');
                    row.className = 'horizontal-row';
                    row.innerHTML = songs.map(s => createSongCardHTML(s)).join('');
                    wrapper.appendChild(row);
                    container.appendChild(wrapper);
                }
            });
        }

        function getSmartRecommendations() {
            const disliked = currentUserData.disliked_songs || [];
            let candidates = musicLibrary.filter(s => !disliked.includes(s.id));
            const liked = currentUserData.liked_songs || [];
            const counts = currentUserData.play_counts || {};
            let artistAffinity = {};
            liked.forEach(songId => {
                const s = musicLibrary.find(x => x.id === songId);
                if (s) artistAffinity[s.artist] = (artistAffinity[s.artist] || 0) + 10;
            });
            Object.keys(counts).forEach(songId => {
                const s = musicLibrary.find(x => x.id === parseInt(songId));
                if (s) artistAffinity[s.artist] = (artistAffinity[s.artist] || 0) + (counts[songId] * 2); 
            });
            candidates.forEach(song => {
                let score = 0;
                if(liked.includes(song.id)) score += 100;
                const affinity = artistAffinity[song.artist] || 0;
                score += Math.min(affinity, 50);
                if(counts[song.id]) score += Math.min(counts[song.id] * 2, 40);
                score += Math.random() * 20;
                score += (song.id / 5);
                song._score = score;
            });
            candidates.sort((a, b) => b._score - a._score);
            return candidates.slice(0, 20);
        }

        function getDiscoveryRecommendations() {
            const disliked = currentUserData.disliked_songs || [];
            const liked = currentUserData.liked_songs || [];
            const counts = currentUserData.play_counts || {};
            let candidates = musicLibrary.filter(s => !disliked.includes(s.id));
            candidates.forEach(song => {
                let score = (counts[song.id] || 0); 
                if(liked.includes(song.id)) score += 10;
                song._discovery_score = score;
            });
            candidates.sort((a, b) => a._discovery_score - b._discovery_score);
            let pool = candidates.slice(0, 50);
            pool.sort(() => Math.random() - 0.5);
            return pool.slice(0, 20);
        }

        function updateUIFromUserData() {
            updateThemeUI(currentUserData.theme || 'light');
            const avatarUrl = currentUserData.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            document.getElementById('header-avatar').style.backgroundImage = `url(${avatarUrl})`;
            document.getElementById('profile-preview-large').style.backgroundImage = `url(${avatarUrl})`;
            document.getElementById('profile-username-display').innerText = currentUserData.username;
        }

        function getArtistImage(name) { return artistImages[name] || DEFAULT_ARTIST_IMG; }
        function getAlbumImage(name) { return albumImages[name] || DEFAULT_ALBUM_IMG; }
        function getSongCover(song) {
            if(song.cover) return song.cover;
            if(song.album && albumImages[song.album]) return albumImages[song.album];
            return DEFAULT_ALBUM_IMG;
        }

        // --- Context Menu ---
        function showContextMenu(e, type, data) {
            e.stopPropagation();
            if(isBatchDeleteMode) return; 

            const overlay = document.getElementById('cm-overlay');
            const menu = document.getElementById('context-menu');
            let html = '';
            
            const iconPlus = `<svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
            const iconHeart = `<svg class="icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
            const iconHeartFill = `<svg class="icon" viewBox="0 0 24 24" style="fill:var(--accent-color); stroke:var(--accent-color);"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
            const iconPlay = `<svg class="icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
            const iconShuffle = `<svg class="icon" viewBox="0 0 24 24"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>`;
            const iconBan = `<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>`;
            const iconPin = `<svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.74V3H9v7.74a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg>`;
            const iconAlbum = `<svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>`;
            const iconTrash = `<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

            const isLiked = data.id ? currentUserData.liked_songs.includes(data.id) : false;
            const likeIcon = isLiked ? iconHeartFill : iconHeart;
            const likeText = isLiked ? "取消喜好" : "喜好項目";

            if (type === 'song') {
                html = `
                    <div class="cm-row">
                        <button class="cm-btn split" onclick="openPlaylistSelector(event, ${data.id}, 'song'); closeContextMenu()">${iconPlus} 加入清單</button>
                        <button class="cm-btn split" onclick="toggleLike(${data.id}); closeContextMenu()">${likeIcon} ${likeText}</button>
                    </div>
                    <button class="cm-btn full-width" onclick="playSong(${data.id}); closeContextMenu()">${iconPlay} 立即播放</button>
                    <button class="cm-btn full-width" onclick="playSong(${data.id}); closeContextMenu()">${iconShuffle} 隨機播放後續</button>
                    <button class="cm-btn full-width" onclick="dislikeSong(${data.id}); closeContextMenu()">${iconBan} 減少推薦</button>
                `;
            } else if (type === 'playlist_song') {
                html = `
                    <div class="cm-row">
                        <button class="cm-btn split" onclick="toggleLike(${data.id}); closeContextMenu()">${likeIcon} ${likeText}</button>
                        <button class="cm-btn split" onclick="openPlaylistSelector(event, ${data.id}, 'song'); closeContextMenu()">${iconPlus} 加到其他</button>
                    </div>
                    <button class="cm-btn full-width" onclick="pinSongInPlaylist(${data.id}); closeContextMenu()">${iconPin} 釘選歌曲 (置頂)</button>
                    <button class="cm-btn full-width" onclick="openAlbumDetail('${data.albumName}'); closeContextMenu()">${iconAlbum} 前往專輯</button>
                    <button class="cm-btn full-width" onclick="removeFromPlaylist(event, ${data.id}); closeContextMenu()" style="color:var(--accent-color);">${iconTrash} 從清單移除</button>
                `;
            } else if (type === 'album') {
                html = `
                    <div class="cm-row">
                        <button class="cm-btn split" onclick="openPlaylistSelector(event, '${data.name}', 'album'); closeContextMenu()">${iconPlus} 加入清單</button>
                        <button class="cm-btn split" onclick="closeContextMenu(); alert('已加入喜好')">${iconHeart} 喜好項目</button>
                    </div>
                    <button class="cm-btn full-width" onclick="openAlbumDetail('${data.name}'); playCollectionAll(false); closeContextMenu()">${iconPlay} 立即播放</button>
                    <button class="cm-btn full-width" onclick="openAlbumDetail('${data.name}'); playCollectionAll(true); closeContextMenu()">${iconShuffle} 隨機播放</button>
                `;
            }

            menu.innerHTML = html;
            overlay.classList.add('active');

            const isMobile = window.innerWidth <= 768;
            if (!isMobile) {
                const rect = menu.getBoundingClientRect();
                let x = e.clientX;
                let y = e.clientY;
                if (x + rect.width > window.innerWidth) x -= rect.width;
                if (y + rect.height > window.innerHeight) y -= rect.height;
                menu.style.left = x + 'px';
                menu.style.top = y + 'px';
            }
        }

        function closeContextMenu() { document.getElementById('cm-overlay').classList.remove('active'); }

        async function toggleLike(id) {
            const idx = currentUserData.liked_songs.indexOf(id);
            if(idx === -1) currentUserData.liked_songs.push(id);
            else currentUserData.liked_songs.splice(idx, 1);
            await saveUserToDB(currentUserData);
            if(currentPlaylistId === 'favorites') openPlaylistDetail('favorites');
            
            if (currentSongId === id) updateFullPlayerHeart();
            renderPlaylists();
        }

        async function dislikeSong(id) {
            if(!currentUserData.disliked_songs.includes(id)) {
                currentUserData.disliked_songs.push(id);
                const likeIdx = currentUserData.liked_songs.indexOf(id);
                if(likeIdx !== -1) currentUserData.liked_songs.splice(likeIdx, 1);
                await saveUserToDB(currentUserData);
            }
        }

        // --- Core Functions ---
        function switchPage(pid) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+pid)) document.getElementById('nav-'+pid).classList.add('active');
            updateMobileNavActive(pid);
            const titles = { 'home': '首頁', 'search': '搜尋', 'discovery': '新發現', 'database': '資料庫', 'settings': '設定' };
            document.getElementById('current-page-title').innerText = titles[pid] || '';
            if(pid !== 'database' && isBatchDeleteMode) toggleBatchDeleteMode();
        }

        function updateMobileNavActive(pid) {
            document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('mobile-nav-' + pid)?.classList.add('active');
        }

        function handleScroll() {
            const header = document.getElementById('main-header');
            const mainContent = document.querySelector('.main-content');
            if(mainContent.scrollTop > 10) header.classList.add('scrolled');
            else header.classList.remove('scrolled');
        }

        // --- Player Logic ---
        const audioPlayer = document.getElementById('audio-player');
        let isPlaying = false;

        function playSong(id) {
            const song = musicLibrary.find(s => s.id === id);
            if(!song) return;
            
            if(!currentUserData.play_counts) currentUserData.play_counts = {};
            currentUserData.play_counts[id] = (currentUserData.play_counts[id] || 0) + 1;
            saveUserToDB(currentUserData);

            if (currentCollectionSongs.length > 0 && currentCollectionSongs.find(s => s.id === id)) {
                if (!currentQueue.some(s => s.id === id)) currentQueue = [...currentCollectionSongs];
            } else {
                currentQueue = [...musicLibrary];
            }
            
            currentSongIndex = currentQueue.findIndex(s => s.id === id);
            playSongObject(song);
        }

        function playSongObject(song) {
            currentSongId = song.id;
            audioPlayer.src = `./music/${song.filename}`;
            const coverImage = getSongCover(song);
            
            document.getElementById('p-title').innerText = song.title;
            document.getElementById('p-artist').innerText = song.artist;
            document.getElementById('p-thumb').style.backgroundImage = `url('${coverImage}')`;
            
            document.getElementById('fp-title').innerText = song.title;
            document.getElementById('fp-artist').innerText = song.artist;
            document.getElementById('fp-cover-img').style.backgroundImage = `url('${coverImage}')`;
            document.getElementById('fp-bg').style.backgroundImage = `url('${coverImage}')`;
            
            document.getElementById('fp-q-title').innerText = song.title;
            document.getElementById('fp-q-artist').innerText = song.artist;
            document.getElementById('fp-q-img').style.backgroundImage = `url('${coverImage}')`;
            
            updateRangeBackground(document.getElementById('fp-progress')); // 重置背景

            updateFullPlayerHeart();
            updateMediaSession(song, coverImage);
            
            audioPlayer.play().then(() => {
                isPlaying = true;
                updatePlayBtns();
                if(!document.getElementById('page-settings').classList.contains('active')){
                     document.getElementById('player-bar').classList.add('active');
                }
            }).catch(e => console.log(e));
            
            renderQueue();
        }

        function togglePlay() {
            if(audioPlayer.src) {
                if(isPlaying) audioPlayer.pause(); else audioPlayer.play();
                isPlaying = !isPlaying;
                updatePlayBtns();
            }
        }
        function updatePlayBtns() { 
            const miniBtn = document.getElementById('playBtn');
            miniBtn.innerText = isPlaying ? "||" : "▶";
            
            const fpBtn = document.getElementById('fp-play-btn');
            if(isPlaying) {
                fpBtn.classList.add('pause');
                fpBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>`;
            } else {
                fpBtn.classList.remove('pause');
                fpBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>`;
            }
        }

        function playNext() {
            if(currentQueue.length > 0) {
                if(currentSongIndex < currentQueue.length - 1) {
                    currentSongIndex++;
                    playSongObject(currentQueue[currentSongIndex]);
                } else if (loopMode === 1) { 
                    currentSongIndex = 0;
                    playSongObject(currentQueue[currentSongIndex]);
                } else if (isAutoPlay) {
                     const candidates = getDiscoveryRecommendations();
                     const nextSong = candidates[0];
                     if(nextSong) {
                         currentQueue.push(nextSong);
                         currentSongIndex++;
                         playSongObject(nextSong);
                     }
                } else {
                    isPlaying = false;
                    updatePlayBtns();
                }
            }
        }

        function playPrev() {
            if(audioPlayer.currentTime > 3) {
                audioPlayer.currentTime = 0;
            } else {
                if(currentQueue.length > 0) {
                     if(currentSongIndex > 0) {
                         currentSongIndex--;
                         playSongObject(currentQueue[currentSongIndex]);
                     } else {
                         playSongObject(currentQueue[currentQueue.length - 1]);
                     }
                }
            }
        }

        function handleSongEnd() {
            if (loopMode === 2) { 
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                playNext();
            }
        }
        
        // --- Full Player Logic ---
        function openFullPlayer() { 
            if (!currentSongId && !audioPlayer.src) return;

            const fp = document.getElementById('full-player');
            fp.classList.add('active'); 
            fp.style.transform = ''; 
            document.body.style.overflow='hidden'; 
            updateRangeBackground(document.getElementById('fp-progress'));
        }
        function closeFullPlayer() { 
            const fp = document.getElementById('full-player');
            fp.classList.remove('active'); 
            fp.style.transform = '';
            document.body.style.overflow=''; 
        }
        
        function togglePlayerView() {
            const main = document.getElementById('fp-view-main');
            const queue = document.getElementById('fp-view-queue');
            const toggleBtn = document.getElementById('fp-queue-toggle-btn');
            
            if (queue.classList.contains('active')) {
                queue.classList.remove('active');
                main.classList.remove('shifted');
                toggleBtn.classList.remove('active');
            } else {
                queue.classList.add('active');
                main.classList.add('shifted');
                toggleBtn.classList.add('active');
                renderQueue(); 
            }
        }

        function toggleCurrentFavorite(e) {
            e.stopPropagation();
            if(currentSongId) toggleLike(currentSongId);
        }
        function updateFullPlayerHeart() {
            const isLiked = currentUserData.liked_songs.includes(currentSongId);
            const btn = document.getElementById('fp-fav-btn');
            const qBtn = document.getElementById('fp-q-fav-btn');
            
            const filledIcon = `<svg viewBox="0 0 24 24" fill="currentColor" stroke="none" style="color:var(--accent-color);"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
            const outlineIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
            
            if(isLiked) {
                if(btn) btn.innerHTML = filledIcon;
                if(qBtn) qBtn.innerHTML = filledIcon;
            } else {
                if(btn) btn.innerHTML = outlineIcon;
                if(qBtn) qBtn.innerHTML = outlineIcon;
            }
        }

        function toggleShuffle() {
            isShuffleMode = !isShuffleMode;
            document.getElementById('btn-shuffle').classList.toggle('active', isShuffleMode);
            if(isShuffleMode) {
                const current = currentQueue[currentSongIndex];
                let rest = currentQueue.filter((_, i) => i !== currentSongIndex);
                for (let i = rest.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [rest[i], rest[j]] = [rest[j], rest[i]];
                }
                currentQueue = [current, ...rest];
                currentSongIndex = 0;
            } else {
                 if(currentCollectionSongs.length) {
                     const current = currentQueue[currentSongIndex];
                     currentQueue = [...currentCollectionSongs];
                     currentSongIndex = currentQueue.findIndex(s => s.id === current.id);
                 }
            }
            renderQueue();
        }

        function toggleLoop() {
            loopMode = (loopMode + 1) % 3;
            const btn = document.getElementById('btn-loop');
            const txt = document.getElementById('txt-loop');
            
            if (loopMode === 0) {
                btn.classList.remove('active');
                txt.innerText = "循環";
                btn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg><span id="txt-loop">循環</span>`;
            } else if (loopMode === 1) {
                btn.classList.add('active');
                txt.innerText = "列表循環";
                btn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg><span id="txt-loop">列表</span>`;
            } else {
                btn.classList.add('active');
                txt.innerText = "單曲循環";
                btn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path><text x="10" y="15" font-size="8" fill="currentColor" font-weight="bold">1</text></svg><span id="txt-loop">單曲</span>`;
            }
        }
        
        function toggleAutoPlay() {
            isAutoPlay = !isAutoPlay;
            document.getElementById('btn-auto').classList.toggle('active', isAutoPlay);
        }

        // Progress & Time 
        function updateProgress() {
            if(!audioPlayer.duration) return;
            const current = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            const slider = document.getElementById('fp-progress');
            slider.max = Math.floor(duration);
            slider.value = current; // 移除 Math.floor 以保持平滑
            document.getElementById('fp-curr-time').innerText = formatTime(current);
            document.getElementById('fp-total-time').innerText = formatTime(duration);
            
            updateRangeBackground(slider);
        }
        
        function updateRangeBackground(input) {
            const val = input.value;
            const max = input.max || 100;
            const percentage = max > 0 ? (val / max) * 100 : 0;
            input.style.background = `linear-gradient(to right, #FFFFFF ${percentage}%, rgba(255,255,255,0.2) ${percentage}%)`;
        }

        function seekAudio(val) {
            audioPlayer.currentTime = val;
            updateRangeBackground(document.getElementById('fp-progress'));
        }

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }
        
        function updateMediaSession(song, coverImage) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.artist,
                    album: song.album,
                    artwork: [
                        { src: coverImage, sizes: '96x96', type: 'image/png' },
                        { src: coverImage, sizes: '512x512', type: 'image/png' },
                    ]
                });
                navigator.mediaSession.setActionHandler('play', () => { audioPlayer.play(); isPlaying=true; updatePlayBtns(); });
                navigator.mediaSession.setActionHandler('pause', () => { audioPlayer.pause(); isPlaying=false; updatePlayBtns(); });
                navigator.mediaSession.setActionHandler('nexttrack', playNext);
                navigator.mediaSession.setActionHandler('previoustrack', playPrev);
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                     if (details.seekTime || details.seekTime === 0) {
                         audioPlayer.currentTime = details.seekTime;
                         updateMediaSessionPosition();
                     }
                });
            }
        }
        
        function updateMediaSessionPosition() {
             if ('mediaSession' in navigator && audioPlayer.duration) {
                try {
                    navigator.mediaSession.setPositionState({
                        duration: audioPlayer.duration,
                        playbackRate: audioPlayer.playbackRate,
                        position: audioPlayer.currentTime
                    });
                } catch(e) {} 
            }
        }

        function renderQueue() {
            const list = document.getElementById('fp-queue-list');
            let html = `<div class="fp-queue-header">待播清單</div>`;
            
            for (let i = currentSongIndex; i < currentQueue.length; i++) {
                const s = currentQueue[i];
                const isPlayingItem = (i === currentSongIndex);
                html += `
                    <div class="fp-q-item ${isPlayingItem ? 'fp-q-playing' : ''}" onclick="playSong(${s.id})">
                        <div class="fp-q-img" style="background-image:url('${getSongCover(s)}')"></div>
                        <div class="fp-q-info">
                            <div class="fp-q-title">${s.title} ${isPlayingItem ? '<svg class="icon" viewBox="0 0 24 24" style="width:14px;height:14px; display:inline; vertical-align:middle; margin-left:4px;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>' : ''}</div>
                            <div class="fp-q-artist">${s.artist}</div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        // --- (Rest of standard functions: Playlist, Album, Search, etc.) ---
        function createSongCardHTML(song) {
            const img = getSongCover(song);
            return `
            <div class="music-card" onclick="playSong(${song.id})">
                <div class="cover-art" style="background-image:url('${img}')">
                    <div class="ctx-btn" onclick="showContextMenu(event, 'song', {id: ${song.id}})">
                        <svg class="icon" viewBox="0 0 24 24" style="width:18px;height:18px;"><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg>
                    </div>
                </div>
                <div style="font-weight:bold; font-size:0.95rem; margin-bottom:2px;">${song.title}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div>
            </div>`;
        }
        
        function renderHorizontalRows(containerId, songs) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 
            const chunkSize = 20; 
            for (let i = 0; i < songs.length; i += chunkSize) {
                const chunk = songs.slice(i, i + chunkSize);
                const wrapper = document.createElement('div');
                wrapper.className = 'horizontal-section-wrapper';
                const row = document.createElement('div');
                row.className = 'horizontal-row';
                row.innerHTML = chunk.map(s => createSongCardHTML(s)).join('');
                wrapper.appendChild(row);
                container.appendChild(wrapper);
            }
        }

        function renderAlbumSection() {
            const container = document.getElementById('home-album-container');
            const albums = [...new Set(musicLibrary.map(s => s.album))];
            container.innerHTML = albums.map(alb => `
                <div class="music-card" onclick="openAlbumDetail('${alb}')">
                    <div class="cover-art" style="background-image:url('${getAlbumImage(alb)}')">
                         <div class="ctx-btn" onclick="showContextMenu(event, 'album', {name: '${alb}'})">
                            <svg class="icon" viewBox="0 0 24 24" style="width:18px;height:18px;"><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg>
                        </div>
                    </div>
                    <div style="font-weight:bold; font-size:0.95rem;">${alb}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">專輯</div>
                </div>
            `).join('');
        }

        function renderPlaylists() { 
            const container = document.getElementById('playlists-container'); 
            const playlists = currentUserData.playlists || []; 
            const likedCount = currentUserData.liked_songs ? currentUserData.liked_songs.length : 0;
            const favCover = currentUserData.favorites_cover 
                ? `background-image:url('${currentUserData.favorites_cover}'); background-size:cover !important; background-position:center !important;`
                : `background: linear-gradient(135deg, #FA2D48, #FF7657); display:flex; align-items:center; justify-content:center;`;
            const favInner = currentUserData.favorites_cover ? `` : `<svg class="icon" viewBox="0 0 24 24" style="width:50px; height:50px; color:white; stroke:white; fill:white;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;

            let html = `
                <div class="music-card" onclick="openPlaylistDetail('favorites')">
                    <div class="cover-art" style="${favCover}">${favInner}</div>
                    <div style="font-weight:bold; font-size:0.95rem; margin-bottom:2px;">喜好項目</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">${likedCount} 首歌曲</div>
                </div>
            `;
            html += playlists.map(pl => {
                const isSelected = selectedPlaylists.has(pl.id);
                return `
                <div class="music-card ${isBatchDeleteMode ? 'edit-mode' : ''} ${isSelected ? 'selected' : ''}" onclick="handlePlaylistClick(${pl.id})">
                    <div class="cover-art" style="background-image:url('${pl.img || DEFAULT_PLAYLIST_IMG}')"><div class="batch-select-overlay"></div></div>
                    <div style="font-weight:bold; font-size:0.95rem; margin-bottom:2px;">${pl.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">${pl.songs.length} 首歌曲</div>
                </div>
            `}).join(''); 
            container.innerHTML = html;
        }

        function toggleBatchDeleteMode() {
            isBatchDeleteMode = !isBatchDeleteMode;
            selectedPlaylists.clear();
            const btn = document.getElementById('batch-delete-toggle-btn');
            const actionBar = document.getElementById('batch-action-bar');
            if(isBatchDeleteMode) {
                btn.innerText = "完成"; btn.style.color = "var(--accent-color)"; actionBar.classList.add('active');
            } else {
                btn.innerText = "編輯"; btn.style.color = "var(--text-primary)"; actionBar.classList.remove('active');
            }
            updateBatchSelectCount(); renderPlaylists();
        }
        function handlePlaylistClick(plId) {
            if(plId === 'favorites') { if(!isBatchDeleteMode) openPlaylistDetail('favorites'); return; }
            if (isBatchDeleteMode) {
                if (selectedPlaylists.has(plId)) selectedPlaylists.delete(plId); else selectedPlaylists.add(plId);
                updateBatchSelectCount(); renderPlaylists();
            } else { openPlaylistDetail(plId); }
        }
        function updateBatchSelectCount() { document.getElementById('batch-select-count').innerText = `已選取 ${selectedPlaylists.size} 個項目`; }
        async function executeBatchDelete() {
            if (selectedPlaylists.size === 0) return alert("請先選取要刪除的清單");
            if (confirm(`確定要刪除這 ${selectedPlaylists.size} 個播放清單嗎？`)) {
                currentUserData.playlists = currentUserData.playlists.filter(p => !selectedPlaylists.has(p.id));
                await saveUserToDB(currentUserData); toggleBatchDeleteMode(); renderPlaylists();
            }
        }
        function triggerCoverEdit() { if(currentPlaylistId) document.getElementById('playlist-cover-upload').click(); }
        function handlePlaylistCoverUpdate(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const newCover = e.target.result;
                    if(currentPlaylistId === 'favorites') currentUserData.favorites_cover = newCover;
                    else { const pl = currentUserData.playlists.find(p => p.id === currentPlaylistId); if(pl) pl.img = newCover; }
                    await saveUserToDB(currentUserData); renderPlaylists(); openPlaylistDetail(currentPlaylistId);
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        // [新增] 處理導航堆疊邏輯：當開啟新視窗前，若當前已有視窗打開，則存入 Stack
        function openPlaylistDetail(plId, isNavigatingBack = false) {
            if (!isNavigatingBack && document.getElementById('collection-detail-modal').classList.contains('active') && currentModalState) {
                modalHistory.push(currentModalState);
            }
            currentModalState = { type: 'playlist', id: plId };

            let pl, songs, title, subtitle, cover;
            const coverEl = document.getElementById('cd-cover');
            
            if (plId === 'favorites') {
                currentPlaylistId = 'favorites';
                title = "喜好項目";
                songs = currentUserData.liked_songs.map(sid => musicLibrary.find(s => s.id === sid)).filter(s => s);
                subtitle = `${songs.length} 首歌曲`;
                coverEl.style.backgroundImage = currentUserData.favorites_cover ? `url('${currentUserData.favorites_cover}')` : 'none';
                if(!currentUserData.favorites_cover) coverEl.style.background = 'linear-gradient(135deg, #FA2D48, #FF7657)';
            } else {
                pl = currentUserData.playlists.find(p => p.id === plId);
                if(!pl) return;
                currentPlaylistId = plId;
                songs = pl.songs.map(sid => musicLibrary.find(s => s.id === sid)).filter(s => s);
                title = pl.name;
                subtitle = `${songs.length} 首歌曲`;
                coverEl.style.background = '#eee';
                coverEl.style.backgroundImage = `url(${pl.img || DEFAULT_PLAYLIST_IMG})`;
            }

            coverEl.style.borderRadius = "20px";

            currentCollectionSongs = songs;
            document.getElementById('cd-nav-title').innerText = title;
            document.getElementById('cd-title').innerText = title;
            document.getElementById('cd-subtitle').innerText = subtitle;
            coverEl.innerHTML = `<div class="cover-edit-overlay"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></div>`;

            let html = `<h3 style="margin-bottom:15px; font-size:1.1rem; opacity:0; animation:fadeIn 0.5s ease forwards;">歌曲列表</h3>`;
            html += songs.map(s => createPlaylistSongRowHTML(s)).join('');
            if (plId !== 'favorites') {
                html += `
                <div class="add-music-bar" onclick="openSearchForPlaylist(${plId})"><svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>添加音樂</div>
                <div style="margin-top: 40px; margin-bottom: 20px; display: flex; justify-content: flex-end; width: 100%;">
                    <button onclick="deleteCurrentPlaylist()" style="padding: 10px 24px; background: rgba(250, 45, 72, 0.1); color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 24px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center;">
                        <svg class="icon" viewBox="0 0 24 24" style="width: 18px; height: 18px; margin-right: 6px;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>刪除此清單
                    </button>
                </div>`;
            }
            document.getElementById('cd-content-area').innerHTML = html;
            document.getElementById('collection-detail-modal').classList.add('active');
        }

        function createPlaylistSongRowHTML(song) {
            const img = getSongCover(song);
            return `
            <div class="song-list-item" onclick="playSong(${song.id})">
                <div class="song-row-img" style="background-image:url('${img}')"></div>
                <div class="song-row-info"><div class="song-row-title">${song.title}</div><div class="song-row-artist">${song.artist}</div></div>
                <button class="list-more-btn" onclick="showContextMenu(event, 'playlist_song', {id: ${song.id}, albumName: '${song.album}'})"><svg class="icon" viewBox="0 0 24 24" style="width:18px; height:18px;"><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button>
            </div>`;
        }

        function openAlbumDetail(albumName, isNavigatingBack = false) {
            if (!isNavigatingBack && document.getElementById('collection-detail-modal').classList.contains('active') && currentModalState) {
                modalHistory.push(currentModalState);
            }
            currentModalState = { type: 'album', id: albumName };

            const songs = musicLibrary.filter(s => s.album === albumName);
            if(songs.length === 0) return;

            document.getElementById('cd-nav-title').innerText = albumName;
            document.getElementById('cd-title').innerText = albumName;
            document.getElementById('cd-subtitle').innerText = `專輯 • ${songs[0]?.artist || ''}`;
            const coverEl = document.getElementById('cd-cover');
            coverEl.style.background = '#eee';
            coverEl.style.backgroundImage = `url(${getAlbumImage(albumName)})`;
            coverEl.style.borderRadius = "20px";
            coverEl.innerHTML = '';
            
            currentCollectionSongs = songs;
            let html = `<h3 style="margin-bottom:15px; font-size:1.1rem; opacity:0; animation:fadeIn 0.5s ease forwards;">歌曲列表</h3>`;
            html += songs.map(s => {
                 const img = getSongCover(s);
                 return `
                    <div class="song-list-item" onclick="playSong(${s.id})">
                        <div class="song-row-img" style="background-image:url('${img}')"></div>
                        <div class="song-row-info"><div class="song-row-title">${s.title}</div><div class="song-row-artist">${s.artist}</div></div>
                        <button class="list-more-btn" onclick="showContextMenu(event, 'song', {id: ${s.id}})"><svg class="icon" viewBox="0 0 24 24" style="width:18px;height:18px;"><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button>
                    </div>`;
            }).join('');
            document.getElementById('cd-content-area').innerHTML = html;
            document.getElementById('collection-detail-modal').classList.add('active');
        }

        // [修改] 藝人頁面：增加排序邏輯與導航堆疊
        function openArtistDetail(artistName, isNavigatingBack = false) {
            // 處理導航堆疊
            if (!isNavigatingBack && document.getElementById('collection-detail-modal').classList.contains('active') && currentModalState) {
                modalHistory.push(currentModalState);
            }
            currentModalState = { type: 'artist', id: artistName };

            // 取得歌曲
            let songs = musicLibrary.filter(s => s.artist === artistName);
            
            // [排序邏輯] 越新(ID越大)越前面 + 一點點隨機(Noise)
            // 公式：比較 (b.id + random) - (a.id + random)
            // 係數 20 代表大約相差 20 首內的歌曲可能會隨機互換位置，但相差太遠的不會
            songs.sort((a, b) => {
                const scoreA = a.id + (Math.random() * 20);
                const scoreB = b.id + (Math.random() * 20);
                return scoreB - scoreA;
            });

            document.getElementById('cd-nav-title').innerText = artistName;
            document.getElementById('cd-title').innerText = artistName;
            document.getElementById('cd-subtitle').innerText = "藝人";
            const coverEl = document.getElementById('cd-cover');
            coverEl.style.backgroundImage = `url(${getArtistImage(artistName)})`;
            coverEl.style.borderRadius = "50%";
            coverEl.innerHTML = '';

            currentCollectionSongs = songs;
            let html = '';

            // 1. 歌曲區塊 (垂直四排，左右滑動)
            if(songs.length > 0) {
                html += `<h3 style="margin-bottom:15px; font-size:1.1rem;">熱門歌曲</h3>`;
                html += `<div class="horizontal-grid-scroller">`;
                html += songs.map(s => createPlaylistSongRowHTML(s)).join('');
                html += `</div>`;
            } else {
                 html += `<div style="padding:20px 0; color:var(--text-secondary);">暫無歌曲</div>`;
            }

            // 2. 專輯區塊
            const albums = [...new Set(songs.map(s => s.album))];
            if(albums.length > 0) {
                html += `<h3 style="margin-top:30px; margin-bottom:15px; font-size:1.1rem;">專輯</h3>`;
                html += `<div class="horizontal-row">`;
                html += albums.map(alb => `
                    <div class="music-card" onclick="openAlbumDetail('${alb}')">
                        <div class="cover-art" style="background-image:url('${getAlbumImage(alb)}')"></div>
                        <div style="font-weight:bold; font-size:0.95rem;">${alb}</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">專輯</div>
                    </div>
                `).join('');
                html += `</div>`;
            }

            // 3. 成員區塊
            const members = artistMembers[artistName];
            if(members && members.length > 0) {
                html += `<h3 style="margin-top:30px; margin-bottom:15px; font-size:1.1rem;">成員</h3>`;
                html += `<div class="horizontal-row" style="padding-bottom:10px;">`;
                html += members.map(m => `
                    <div class="member-avatar" onclick="openArtistDetail('${m}')">
                        <div class="member-avatar-img" style="background-image:url('${getArtistImage(m)}')"></div>
                        <div class="member-name">${m}</div>
                    </div>
                `).join('');
                html += `</div>`;
            }

            document.getElementById('cd-content-area').innerHTML = html;
            document.getElementById('collection-detail-modal').classList.add('active');
        }
        
        // [新增] 處理返回鍵邏輯
        function handleModalBack() {
            if (modalHistory.length > 0) {
                // 如果歷史堆疊有資料，取出上一頁並渲染 (isNavigatingBack = true)
                const prevState = modalHistory.pop();
                if (prevState.type === 'artist') {
                    openArtistDetail(prevState.id, true);
                } else if (prevState.type === 'album') {
                    openAlbumDetail(prevState.id, true);
                } else if (prevState.type === 'playlist') {
                    openPlaylistDetail(prevState.id, true);
                }
            } else {
                // 如果沒有歷史紀錄，則關閉視窗
                closeCollectionDetail();
            }
        }

        function playCollectionAll(shuffle) {
            if(currentCollectionSongs.length > 0) {
                let queue = [...currentCollectionSongs];
                isShuffleMode = shuffle;
                if (shuffle) {
                    for (let i = queue.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [queue[i], queue[j]] = [queue[j], queue[i]];
                    }
                }
                currentQueue = queue;
                currentSongIndex = 0;
                playSongObject(currentQueue[0]);
                document.getElementById('btn-shuffle').classList.toggle('active', isShuffleMode);
            }
        }

        function openSearchForPlaylist(plId) { addingToPlaylistId = plId; document.getElementById('playlist-add-search-input').value = ''; document.getElementById('playlist-add-results').innerHTML = '<div style="text-align:center; color:var(--text-secondary);">輸入關鍵字以搜尋</div>'; document.getElementById('search-for-playlist-modal').classList.add('active'); }
        function closeSearchForPlaylist() { document.getElementById('search-for-playlist-modal').classList.remove('active'); addingToPlaylistId = null; }
        function handlePlaylistAddSearch(e) {
            const val = e.target.value.toLowerCase().trim();
            const resDiv = document.getElementById('playlist-add-results');
            if(!val) { resDiv.innerHTML = ''; return; }
            const matched = musicLibrary.filter(s => s.title.toLowerCase().includes(val) || s.artist.toLowerCase().includes(val));
            resDiv.innerHTML = matched.map(s => `
                <div class="song-list-item" onclick="addSongToSpecificPlaylist(${s.id})">
                     <div class="song-row-img" style="background-image:url('${getSongCover(s)}')"></div>
                     <div class="song-row-info"><div class="song-row-title">${s.title}</div><div class="song-row-artist">${s.artist}</div></div>
                     <div style="color:var(--accent-color); font-weight:bold;">+</div>
                </div>
            `).join('');
        }
        async function addSongToSpecificPlaylist(sid) {
            if(!addingToPlaylistId) return;
            const p = currentUserData.playlists.find(x => x.id === addingToPlaylistId);
            if(p && !p.songs.includes(sid)) { p.songs.push(sid); await saveUserToDB(currentUserData); renderPlaylists(); openPlaylistDetail(addingToPlaylistId); closeSearchForPlaylist(); } else { alert("歌曲已存在於清單中"); }
        }

        function openPlaylistSelector(e, idOrName, type){ 
            e.stopPropagation(); 
            itemsToAdd = (type === 'album') ? musicLibrary.filter(s => s.album === idOrName).map(s => s.id) : [idOrName];
            if(!currentUserData.playlists.length){if(confirm("尚未建立清單，是否新建?"))openCreatePlaylistModal();return;} 
            const l=document.getElementById('playlist-selector-list'); 
            l.innerHTML=`<div onclick="openCreatePlaylistModal()" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer; color:var(--accent-color); font-weight:bold;">+ 建立新清單</div>`+currentUserData.playlists.map(p=>`<div onclick="addToPlaylist(${p.id})" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer;">${p.name}</div>`).join(''); 
            document.getElementById('select-playlist-modal').classList.add('active'); 
        }
        function closePlaylistSelector(){ document.getElementById('select-playlist-modal').classList.remove('active'); }
        
        async function addToPlaylist(pid){ 
            const p=currentUserData.playlists.find(x=>x.id===pid); 
            if(p){
                let addedCount = 0;
                itemsToAdd.forEach(sid => { if(!p.songs.includes(sid)) { p.songs.push(sid); addedCount++; } });
                if (addedCount > 0) { await saveUserToDB(currentUserData); renderPlaylists(); alert(`已加入 ${addedCount} 首歌曲到清單`); } else { alert("選取的歌曲已存在於清單中"); }
            }
            closePlaylistSelector(); 
        }

        function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
        function closeLoginModal() { document.getElementById('login-modal').classList.remove('active'); }
        async function handleLogin(e) { 
            e.preventDefault(); const u = document.getElementById('username').value; const p = document.getElementById('password').value; 
            let user = await getUserFromDB(u); 
            if(user){ 
                if(user.password===p){ 
                    currentUserData=user; 
                    if(!currentUserData.liked_songs) currentUserData.liked_songs = []; 
                    if(!currentUserData.disliked_songs) currentUserData.disliked_songs = [];
                    if(!currentUserData.play_counts) currentUserData.play_counts = {};
                    if(!currentUserData.favorites_cover) currentUserData.favorites_cover = null;
                    await saveUserToDB(currentUserData);
                    localStorage.setItem('current_session_user',u); closeLoginModal(); document.getElementById('landing-page').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); initApp(); 
                } else alert("密碼錯誤"); 
            } else { 
                if(confirm("用戶不存在，是否立即註冊?")){ 
                    const n={username:u,password:p,avatar:null,playlists:[],liked_songs:[],disliked_songs:[],play_counts:{},favorites_cover:null,theme:'light',search_history:[]}; 
                    await saveUserToDB(n); currentUserData=n; localStorage.setItem('current_session_user',u); closeLoginModal(); document.getElementById('landing-page').classList.add('hidden'); document.getElementById('app-view').classList.remove('hidden'); initApp(); 
                } 
            } 
        }
        function handleLogout() { localStorage.removeItem('current_session_user'); location.reload(); }
        
        function openProfileModal() { document.getElementById('profile-modal').classList.add('active'); document.getElementById('player-bar').classList.add('hidden'); }
        function closeProfileModal() { document.getElementById('profile-modal').classList.remove('active'); document.getElementById('player-bar').classList.remove('hidden'); }
        async function updateUsername() { const n = document.getElementById('edit-username').value; if(!n)return; const old=JSON.parse(JSON.stringify(currentUserData)); const ex=await getUserFromDB(n); if(ex)return alert("使用者名稱已存在"); const nw={...old,username:n}; await saveUserToDB(nw); const db=await openDB(); const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).delete(old.username); currentUserData=nw; localStorage.setItem('current_session_user',n); updateUIFromUserData(); alert("更新成功"); }
        async function updatePassword() { const o=document.getElementById('old-password').value; const n=document.getElementById('new-password').value; if(o!==currentUserData.password)return alert("舊密碼錯誤"); currentUserData.password=n; await saveUserToDB(currentUserData); alert("密碼已更新"); }
        function handleProfileUpload(i) { if(i.files&&i.files[0]){ const r=new FileReader(); r.onload=async function(e){ currentUserData.avatar=e.target.result; await saveUserToDB(currentUserData); updateUIFromUserData(); }; r.readAsDataURL(i.files[0]); } }
        
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); document.getElementById('player-bar').classList.add('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); document.getElementById('player-bar').classList.remove('hidden'); }
        function toggleThemePill() { const isDark=document.body.getAttribute('data-theme')==='dark'; currentUserData.theme=isDark?'light':'dark'; saveUserToDB(currentUserData); updateThemeUI(currentUserData.theme); }
        function updateThemeUI(t) { 
            const p=document.getElementById('theme-pill'); const pl=document.getElementById('pill-light'); const pd=document.getElementById('pill-dark'); const m=document.getElementById('theme-color-meta'); 
            if(t==='dark'){ document.body.setAttribute('data-theme','dark'); p.setAttribute('data-state','dark'); pl.classList.remove('active'); pd.classList.add('active'); m.setAttribute('content','#000000'); }
            else{ document.body.removeAttribute('data-theme'); p.setAttribute('data-state','light'); pd.classList.remove('active'); pl.classList.add('active'); m.setAttribute('content','#FFFFFF'); } 
        }
        
        function openCreatePlaylistModal(){ document.getElementById('select-playlist-modal').classList.remove('active'); document.getElementById('create-playlist-modal').classList.add('active'); tempImgBase64=null; document.getElementById('img-preview').style.backgroundImage=''; }
        function closeCreatePlaylistModal(){ document.getElementById('create-playlist-modal').classList.remove('active'); if (document.activeElement) document.activeElement.blur(); }
        function previewImage(i){ if(i.files&&i.files[0]){ const r=new FileReader(); r.onload=function(e){ tempImgBase64=e.target.result; document.getElementById('img-preview').style.backgroundImage=`url(${tempImgBase64})`; }; r.readAsDataURL(i.files[0]); } }
        async function confirmCreatePlaylist(){ 
            const n=document.getElementById('new-playlist-name').value; if(!n)return alert("請輸入清單名稱"); 
            const p={id:Date.now(),name:n,songs:[],img:tempImgBase64}; currentUserData.playlists.push(p); 
            await saveUserToDB(currentUserData); renderPlaylists(); 
            setTimeout(() => { closeCreatePlaylistModal(); document.getElementById('new-playlist-name').value = ''; window.scrollTo(0, 0); }, 300);
            if(itemsToAdd.length > 0) addToPlaylist(p.id); 
        }
        async function removeFromPlaylist(e, songId) {
            e.stopPropagation(); if (!currentPlaylistId || currentPlaylistId==='favorites') return;
            if(!confirm("確定要從清單移除這首歌嗎？")) return;
            const pl = currentUserData.playlists.find(p => p.id === currentPlaylistId);
            if (pl) { pl.songs = pl.songs.filter(id => id !== songId); await saveUserToDB(currentUserData); renderPlaylists(); openPlaylistDetail(currentPlaylistId); }
        }
        async function deleteCurrentPlaylist() {
            if (!currentPlaylistId || currentPlaylistId==='favorites') return;
            if (confirm("確定要刪除此播放清單嗎？")) { currentUserData.playlists = currentUserData.playlists.filter(p => p.id !== currentPlaylistId); await saveUserToDB(currentUserData); renderPlaylists(); closeCollectionDetail(); }
        }
        
        // [修改] 關閉詳情頁時清空歷史堆疊
        function closeCollectionDetail() { 
            document.getElementById('collection-detail-modal').classList.remove('active'); 
            modalHistory = []; // 清空歷史
            currentModalState = null;
        }
        
        function handleSearchInput(e) {
            const val = e.target.value.trim();
            if(val) performSearch(val);
            else document.getElementById('search-results-area').innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding-top:20px;">輸入關鍵字開始搜尋</div>';
        }
        function showSearchHistory() {
            const history = currentUserData.search_history || [];
            const dropdown = document.getElementById('search-history-dropdown');
            if(history.length === 0) dropdown.innerHTML = '<div style="padding:15px; text-align:center; color:var(--text-secondary);">無搜尋紀錄</div>';
            else {
                dropdown.innerHTML = history.map(item => `
                    <div class="history-item" onclick="handleHistoryItemClick('${item.type}', '${item.title}', '${item.id || ''}')">
                        <div style="display:flex; align-items:center; overflow:hidden;">
                            <div style="width:36px; height:36px; border-radius:6px; background-size:cover !important; background-position:center !important; margin-right:12px; background-color:#eee; background-image:url('${item.img||DEFAULT_ALBUM_IMG}')"></div>
                            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.title}</div>
                        </div>
                        <span onclick="deleteHistory(event, '${item.title}', '${item.type}')">×</span>
                    </div>`).join('');
            }
            dropdown.classList.add('active');
        }
        async function deleteHistory(e, title, type) { e.stopPropagation(); let history = currentUserData.search_history || []; history = history.filter(h => !(h.title === title && h.type === type)); currentUserData.search_history = history; await saveUserToDB(currentUserData); showSearchHistory(); }
        async function handleSearchResultClick(type, title, img, id) {
            const newItem = { type, title, img, id: id || null, timestamp: Date.now() };
            let history = currentUserData.search_history || [];
            history = history.filter(h => !(h.title === title && h.type === type));
            history.unshift(newItem); if(history.length > 30) history = history.slice(0, 30);
            currentUserData.search_history = history; saveUserToDB(currentUserData);
            if(type === 'artist') openArtistDetail(title); else if(type === 'album') openAlbumDetail(title); else if(type === 'song') playSong(id);
        }
        function handleHistoryItemClick(type, title, id) { document.getElementById('search-history-dropdown').classList.remove('active'); if(type === 'artist') openArtistDetail(title); else if(type === 'album') openAlbumDetail(title); else if(type === 'song' && id) playSong(parseInt(id)); }
        
        async function performSearch(keyword) {
            document.getElementById('search-history-dropdown').classList.remove('active');
            const area = document.getElementById('search-results-area');
            const val = keyword.toLowerCase();
            const matchedSongs = musicLibrary.filter(s => s.title.toLowerCase().includes(val));
            const matchedAlbums = [...new Set(musicLibrary.filter(s => s.album.toLowerCase().includes(val)).map(s => s.album))];
            const matchedArtists = [...new Set(musicLibrary.filter(s => s.artist.toLowerCase().includes(val)).map(s => s.artist))];
            
            let html = '';
            if(matchedArtists.length) {
                html += `<div class="search-section-title">藝人</div><div class="horizontal-row">` + matchedArtists.map(art => `
                    <div class="artist-card" onclick="handleSearchResultClick('artist', '${art}', '${getArtistImage(art)}')">
                        <div class="artist-img" style="background-image:url('${getArtistImage(art)}')"></div>
                        <div style="font-weight:bold; font-size:0.9rem;">${art}</div>
                    </div>`).join('') + `</div>`;
            }
            if(matchedAlbums.length) {
                html += `<div class="search-section-title">專輯</div><div class="horizontal-row">` + matchedAlbums.map(alb => `
                    <div class="music-card" onclick="handleSearchResultClick('album', '${alb}', '${getAlbumImage(alb)}')">
                        <div class="cover-art" style="background-image:url('${getAlbumImage(alb)}')"></div>
                        <div style="font-weight:bold; font-size:0.95rem;">${alb}</div>
                    </div>`).join('') + `</div>`;
            }
            if(matchedSongs.length) {
                html += `<div class="search-section-title">歌曲</div><div class="grid-container">` + matchedSongs.map(s => createSongCardHTML(s)).join('') + `</div>`;
            }
            if(!html) html = `<div style="color:var(--text-secondary); text-align:center;">無結果</div>`;
            area.innerHTML = html;
        }

        document.addEventListener('click', function(e) { const container = document.querySelector('.search-container'); if (container && !container.contains(e.target)) document.getElementById('search-history-dropdown').classList.remove('active'); });
    </script>
</body>
</html>

