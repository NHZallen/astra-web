<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ASTRA Music</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <style>
        /* --- CSS è®Šæ•¸ --- */
        :root {
            --bg-color: #FFFFFF;
            --sidebar-bg: #F5F5F7;
            --card-bg: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent-color: #FA2D48;
            --divider: #E5E5E5;
            --player-bg: rgba(255, 255, 255, 0.9);
            --header-bg: rgba(255, 255, 255, 0.85);
            --modal-bg: #FFFFFF;
            --input-bg: #F0F0F0;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.1);
            --radius-lg: 24px;
            --radius-md: 16px;
            
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --sidebar-bg: #121212;
            --card-bg: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #A1A1A6;
            --divider: #333333;
            --player-bg: rgba(28, 28, 30, 0.9);
            --header-bg: rgba(0, 0, 0, 0.85);
            --modal-bg: #000000;
            --input-bg: #1C1C1E;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-md: 0 12px 32px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-primary); 
            overflow: hidden; height: 100vh; transition: background 0.3s, color 0.3s;
        }
        
        .hidden { display: none !important; }
        .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* --- Landing Page --- */
        #landing-page { height: 100vh; overflow-y: auto; background: var(--bg-color); z-index: 2000; position: relative; scroll-behavior: smooth; padding-top: var(--safe-top); }
        .lp-nav { position: fixed; top: 0; width: 100%; padding: 20px 40px; padding-top: calc(20px + var(--safe-top)); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0); backdrop-filter: blur(10px); z-index: 100; }
        .lp-hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; background: radial-gradient(circle at 50% 30%, rgba(250, 45, 72, 0.15) 0%, transparent 70%); }
        .lp-title { font-size: 4rem; font-weight: 800; margin-bottom: 20px; opacity: 0; animation: fadeUp 1s ease forwards; background: linear-gradient(135deg, var(--text-primary), var(--text-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lp-btn { padding: 15px 40px; background: var(--accent-color); color: white; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; opacity: 0; animation: fadeUp 1s ease 0.5s forwards; box-shadow: 0 10px 20px rgba(250, 45, 72, 0.3); }
        .lp-features { padding: 80px 20px; max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; }
        .feature-card { padding: 30px; background: var(--sidebar-bg); border-radius: var(--radius-lg); opacity: 0; transform: translateY(30px); transition: 0.6s; }
        .feature-card.visible { opacity: 1; transform: translateY(0); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ç™»å…¥æ¨¡æ…‹çª— --- */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2500; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
        #login-modal.active { opacity: 1; pointer-events: auto; }
        .login-box { background: var(--card-bg); width: 85%; max-width: 380px; padding: 30px; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-md); transform: scale(0.9); transition: 0.3s; }
        #login-modal.active .login-box { transform: scale(1); }
        .input-style { width:100%; padding:14px; margin-bottom:12px; border-radius:12px; border:1px solid var(--divider); background:var(--input-bg); color:var(--text-primary); outline:none; transition: 0.2s; }
        .input-style:focus { border-color: var(--accent-color); }

        /* --- App ä½ˆå±€ --- */
        #app-view { display: flex; height: 100vh; width: 100%; }

        .sidebar { width: 260px; background: var(--sidebar-bg); padding: 40px 20px; padding-top: calc(40px + var(--safe-top)); display: flex; flex-direction: column; border-right: 1px solid var(--divider); flex-shrink: 0; }
        .sidebar-logo { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; color: var(--accent-color); padding-left: 20px; }
        .nav-item { padding: 14px 20px; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; border-radius: 12px; margin-bottom: 5px; }
        .nav-item:hover { color: var(--text-primary); background: rgba(0,0,0,0.03); }
        .nav-item.active { background: var(--accent-color); color: white; }
        .nav-item svg { margin-right: 12px; }

        .main-content { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        
        .content-header {
            position: sticky; top: 0; z-index: 90;
            background: var(--header-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 15px 30px; padding-top: calc(15px + var(--safe-top));
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid transparent; transition: 0.3s;
        }
        .header-title { font-size: 1.8rem; font-weight: 800; color: var(--text-primary); }
        .user-avatar-btn {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            background-size: cover; background-position: center; background-color: #ccc;
            border: 2px solid var(--bg-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .user-avatar-btn:active { transform: scale(0.95); }

        .page-section { padding: 30px; padding-bottom: 120px; display: none; animation: fadeIn 0.3s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡ç¶²æ ¼ */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .music-card { position: relative; cursor: pointer; transition: 0.3s; }
        .music-card:hover { transform: translateY(-4px); }
        .cover-art { width: 100%; aspect-ratio: 1/1; border-radius: var(--radius-md); margin-bottom: 10px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; background-size: cover; background-position: center; }
        [data-theme="dark"] .cover-art { background: linear-gradient(135deg, #2C2C2E, #3A3A3C); }
        .add-btn { position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: 0.2s; z-index: 5; color: black; }
        .music-card:hover .add-btn { opacity: 1; }

        /* æ¸…å–®æ¨£å¼ */
        .playlist-row { display: flex; align-items: center; padding: 12px; background: var(--card-bg); border-radius: var(--radius-md); margin-bottom: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .playlist-row:hover { border-color: var(--accent-color); }
        .playlist-cover-small { width: 56px; height: 56px; border-radius: 10px; margin-right: 15px; background: #eee; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; }

        /* æ’­æ”¾å™¨ */
        .player-bar { position: fixed; height: 85px; background: var(--player-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 100; transition: 0.3s ease; padding-bottom: env(safe-area-inset-bottom); }
        @media (min-width: 769px) { .player-bar { bottom: 30px; right: 30px; width: calc(100% - 260px - 60px); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding-bottom: 0; } }

        /* å…¨è¢å¹•è¦–çª— (é€šç”¨) */
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 300; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; padding-top: var(--safe-top); }
        .fullscreen-modal.active { transform: translateY(0); }
        .modal-nav { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); flex-shrink: 0; }
        .modal-body { flex: 1; overflow-y: auto; padding: 30px; max-width: 800px; margin: 0 auto; width: 100%; padding-bottom: 100px; }

        /* æ‰‹æ©Ÿç‰ˆé©é… & åº•éƒ¨é®æ“‹ä¿®æ­£ */
        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .lp-title { font-size: 2.5rem; }
            .content-header { padding: 15px 20px; padding-top: calc(15px + var(--safe-top)); }
            
            .mobile-nav { 
                display: flex; position: fixed; bottom: 0; left: 0; width: 100%; 
                height: calc(60px + var(--safe-bottom)); background: var(--modal-bg); 
                border-top: 1px solid var(--divider); z-index: 110; 
                justify-content: space-around; padding-bottom: var(--safe-bottom); 
                align-items: center; 
            }
            .mobile-nav-item { color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; }
            .mobile-nav-item.active { color: var(--accent-color); }
            
            .player-bar { 
                bottom: calc(65px + var(--safe-bottom)); /* æŠ¬é«˜é¿å…è“‹ä½å°èˆª */
                left: 50%; transform: translateX(-50%); 
                width: 92%; border-radius: 18px; 
                height: 65px; padding: 0 15px; padding-bottom:0; 
            }
            
            /* ä¿®æ­£ï¼šå¢åŠ åº•éƒ¨ Padding é˜²æ­¢å…§å®¹è¢«æ’­æ”¾å™¨èˆ‡å°èˆªé®æ“‹ */
            .page-section { 
                padding: 20px; 
                padding-bottom: calc(160px + var(--safe-bottom)); /* é—œéµä¿®æ­£ */
            }
            .modal-nav { padding: 15px 20px; }
            
            /* å…¨è¢å¹•è¦–çª—ä¹Ÿéœ€è¦è¶³å¤ åº•éƒ¨ç©ºé–“ */
            .modal-body { padding-bottom: calc(100px + var(--safe-bottom)); }
        }

        /* è—¥ä¸¸åˆ‡æ›å™¨ */
        .pill-toggle { background: var(--input-bg); padding: 4px; border-radius: 30px; display: inline-flex; position: relative; cursor: pointer; width: 200px; height: 40px; }
        .pill-bg { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: 32px; background: var(--bg-color); border-radius: 20px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pill-toggle[data-state="dark"] .pill-bg { transform: translateX(100%); }
        .pill-option { flex: 1; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }
        .pill-option.active { color: var(--text-primary); }

        .log-item { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--divider); }
        .log-ver { display: inline-block; background: var(--accent-color); color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; }
        .profile-section { margin-bottom: 25px; }
        .profile-label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; display: block; }
    </style>
</head>
<body>

    <!-- Landing Page -->
    <section id="landing-page">
        <nav class="lp-nav">
            <div style="font-size:1.5rem; font-weight:800; color:var(--accent-color);">ASTRA.</div>
            <button class="lp-btn" style="padding:8px 20px; font-size:0.9rem; opacity:1; animation:none;" onclick="openLoginModal()">ç™»å…¥</button>
        </nav>
        <div class="lp-hero">
            <h1 class="lp-title">æ¢ç´¢<br>ç„¡é™éŸ³é »å®‡å®™</h1>
            <p style="color:var(--text-secondary); max-width:500px; margin-bottom:30px;">å»ºç«‹æ‚¨çš„å°ˆå±¬è³‡æ–™åº«ï¼Œé«”é©—ç„¡ç¸«ä¸²æµã€‚ASTRA Music è®“éŸ³æ¨‚è§¸æ‰‹å¯åŠã€‚</p>
            <button class="lp-btn" onclick="openLoginModal()">ç«‹å³é–‹å§‹é«”é©—</button>
        </div>
        <div class="lp-features">
            <div class="feature-card"><h3 style="margin-bottom:10px;">ğŸ§ ç„¡æéŸ³è³ª</h3><p style="color:var(--text-secondary)">é‚„åŸéŒ„éŸ³å®¤ç­‰ç´šçš„è½è¦ºé¥—å®´ã€‚</p></div>
            <div class="feature-card"><h3 style="margin-bottom:10px;">ğŸ“‚ é›²ç«¯è³‡æ–™åº«</h3><p style="color:var(--text-secondary)">è‡ªè¨‚å°é¢ï¼Œç®¡ç†æ‚¨çš„å°ˆå±¬æ­Œå–®ã€‚</p></div>
            <div class="feature-card"><h3 style="margin-bottom:10px;">ğŸ“± è·¨å¹³å°åŒæ­¥</h3><p style="color:var(--text-secondary)">æ‰‹æ©Ÿèˆ‡é›»è…¦ç„¡ç¸«åˆ‡æ›ã€‚</p></div>
        </div>
        <div style="text-align:center; padding:40px; color:var(--text-secondary); font-size:0.8rem;">&copy; 2025 ASTRA Music</div>
    </section>

    <!-- ç™»å…¥è¦–çª— -->
    <div id="login-modal">
        <div class="login-box">
            <h2 style="margin-bottom:20px;">æ­¡è¿å›ä¾†</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="login-username" class="input-style" placeholder="ç”¨æˆ¶å" required autocomplete="off">
                <input type="password" id="login-password" class="input-style" placeholder="å¯†ç¢¼" required>
                <button type="submit" style="width:100%; padding:14px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ç™»å…¥ / è¨»å†Š</button>
            </form>
            <button onclick="closeLoginModal()" style="margin-top:15px; background:none; border:none; color:var(--text-secondary); cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- App ä¸»ç¨‹å¼ -->
    <section id="app-view" class="hidden">
        <nav class="sidebar">
            <div class="sidebar-logo">ASTRA.</div>
            <div class="nav-item active" onclick="switchPage('home')" id="nav-home"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>é¦–é </div>
            <div class="nav-item" onclick="switchPage('search')" id="nav-search"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>æœå°‹</div>
            <div class="nav-item" onclick="switchPage('discovery')" id="nav-discovery"><svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>æ–°ç™¼ç¾</div>
            <div class="nav-item" onclick="switchPage('database')" id="nav-database"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>è³‡æ–™åº«</div>
            <div class="nav-item" style="margin-top:auto" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>è¨­å®š</div>
        </nav>

        <main class="main-content">
            <header class="content-header">
                <h1 id="page-title-display" class="header-title">é¦–é </h1>
                <div class="user-avatar-btn" id="header-avatar-btn" onclick="openProfileModal()"></div>
            </header>

            <!-- A. é¦–é  -->
            <div id="page-home" class="page-section active">
                <div class="hero-banner" style="height:300px; border-radius:24px; background:linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%); display:flex; align-items:flex-end; padding:30px; margin-bottom:30px; color:white;">
                    <div>
                        <h1 style="font-size:2.5rem; margin-bottom:10px;">New Era.</h1>
                        <p>BABYMONSTER å…¨æ–°å°ˆè¼¯</p>
                        <button onclick="playSong(musicLibrary[0])" style="margin-top:15px; padding:10px 20px; background:white; color:black; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">ç«‹å³æ’­æ”¾</button>
                    </div>
                </div>
                <h2>ç‚ºä½ æ¨è–¦</h2>
                <div class="grid-container" id="home-grid" style="margin-top:20px;"></div>
            </div>

            <!-- B. æœå°‹ -->
            <div id="page-search" class="page-section">
                <input type="text" class="input-style" placeholder="æœå°‹è—äººã€æ­Œæ›²..." oninput="handleSearch(this.value)" style="padding:18px; font-size:1.1rem; margin-bottom:30px;">
                <div class="grid-container" id="search-grid"></div>
            </div>

            <!-- C. æ–°ç™¼ç¾ -->
            <div id="page-discovery" class="page-section">
                <h2 style="margin-bottom:20px;">æ¯é€±ç²¾é¸</h2>
                <div class="grid-container" id="discovery-grid"></div>
            </div>

            <!-- D. è³‡æ–™åº« -->
            <div id="page-database" class="page-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                    <h2>æˆ‘çš„è³‡æ–™åº«</h2>
                    <button onclick="openCreatePlaylistModal()" style="padding:8px 16px; background:var(--accent-color); color:white; border:none; border-radius:20px; font-weight:bold; cursor:pointer;">+ æ–°å»ºæ¸…å–®</button>
                </div>
                <div id="playlists-container"></div>
            </div>
        </main>

        <!-- æ‰‹æ©Ÿå°èˆª -->
        <div class="mobile-nav">
            <div class="mobile-nav-item" onclick="switchPage('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>é¦–é </div>
            <div class="mobile-nav-item" onclick="switchPage('search')"><svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>æœå°‹</div>
            <div class="mobile-nav-item" onclick="switchPage('database')"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>è³‡æ–™åº«</div>
            <div class="mobile-nav-item" onclick="openSettings()"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>è¨­å®š</div>
        </div>

        <footer class="player-bar">
            <div style="display:flex; align-items:center; width: 60%;">
                <div id="p-thumb" style="width:48px; height:48px; background:#ccc; border-radius:10px; margin-right:12px; background-size:cover;"></div>
                <div style="overflow:hidden;">
                    <h4 id="p-title" style="margin:0; font-size:0.9rem; white-space:nowrap;">æœªæ’­æ”¾</h4>
                    <p id="p-artist" style="margin:0; font-size:0.75rem; color:var(--text-secondary);">ASTRA</p>
                </div>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button onclick="togglePlay()" id="playBtn" style="width:40px; height:40px; border-radius:50%; background:var(--text-primary); color:var(--bg-color); border:none; cursor:pointer; font-size:1.2rem;">â–¶</button>
            </div>
        </footer>
    </section>

    <!-- å€‹äººå¸³æˆ¶è¨­å®šé  -->
    <div id="profile-modal" class="fullscreen-modal" style="z-index:350;">
        <div class="modal-nav">
            <h2>ç·¨è¼¯å€‹äººæª”æ¡ˆ</h2>
            <button onclick="closeProfileModal()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; color:var(--text-primary);">å®Œæˆ</button>
        </div>
        <div class="modal-body" style="text-align:center;">
            <div class="profile-section">
                <div id="profile-edit-avatar" style="width:120px; height:120px; border-radius:50%; background-color:#ccc; background-size:cover; background-position:center; margin:0 auto 15px; position:relative; cursor:pointer; border:3px solid var(--card-bg); box-shadow:var(--shadow-md);" onclick="document.getElementById('upload-avatar').click()">
                    <div style="position:absolute; bottom:0; right:0; background:var(--accent-color); color:white; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid var(--card-bg);">ğŸ“·</div>
                </div>
                <input type="file" id="upload-avatar" accept="image/*" style="display:none;" onchange="handleAvatarUpload(this)">
                <p style="color:var(--text-secondary); font-size:0.8rem;">é»æ“Šä¸Šæ–¹æ›´æ›å¤§é ­è²¼</p>
            </div>
            <div class="profile-section" style="text-align:left;">
                <label class="profile-label">ä½¿ç”¨è€…åç¨±</label>
                <input type="text" id="edit-username" class="input-style" placeholder="è¼¸å…¥æ–°çš„åç¨±">
            </div>
            <hr style="border:none; border-top:1px solid var(--divider); margin:30px 0;">
            <div class="profile-section" style="text-align:left;">
                <h3 style="margin-bottom:15px;">å®‰å…¨æ€§</h3>
                <label class="profile-label">ç›®å‰å¯†ç¢¼</label>
                <input type="password" id="current-password" class="input-style" placeholder="è¼¸å…¥ç›®å‰å¯†ç¢¼ä»¥é©—è­‰">
                <label class="profile-label">æ–°å¯†ç¢¼</label>
                <input type="password" id="new-password" class="input-style" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
            </div>
            <button onclick="saveProfileChanges()" style="width:100%; padding:15px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer; margin-top:20px;">å„²å­˜è®Šæ›´</button>
        </div>
    </div>

    <!-- è¨­å®šé  -->
    <div id="settings-modal" class="fullscreen-modal">
        <div class="modal-nav">
            <h2 style="font-size:1.4rem;">è¨­å®š</h2>
            <button onclick="closeSettings()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; color:var(--text-primary);">å®Œæˆ</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:30px;">
                <p style="margin-bottom:10px; font-weight:600;">å¤–è§€ä¸»é¡Œ</p>
                <div class="pill-toggle" id="theme-pill" onclick="toggleThemePill()">
                    <div class="pill-bg"></div>
                    <div class="pill-option active" id="pill-light">æ·ºè‰²</div>
                    <div class="pill-option" id="pill-dark">æ·±è‰²</div>
                </div>
            </div>
            <div style="padding:20px 0; border-bottom:1px solid var(--divider); cursor:pointer;" onclick="showChangelog()">
                <div style="display:flex; justify-content:space-between;"><span>æ›´æ–°æ—¥èªŒ</span><span style="color:var(--text-secondary);" id="setting-ver">v1.2.0 ></span></div>
            </div>
            <button onclick="handleLogout()" style="margin-top:40px; width:100%; padding:15px; background:var(--divider); color:var(--text-primary); border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>

    <!-- æ›´æ–°æ—¥èªŒé  -->
    <div id="changelog-modal" class="fullscreen-modal" style="z-index:310;">
        <div class="modal-nav">
            <h2>æ›´æ–°æ—¥èªŒ</h2>
            <button onclick="closeChangelog()" style="background:var(--input-bg); border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">é—œé–‰</button>
        </div>
        <div class="modal-body" id="changelog-content"></div>
    </div>

    <!-- é¸æ“‡/å»ºç«‹æ¸…å–® -->
    <div id="select-playlist-modal" class="fullscreen-modal" style="z-index:320; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">æ·»åŠ åˆ°æ’­æ”¾æ¸…å–®</h3>
            <div id="playlist-selector-list" style="max-height:300px; overflow-y:auto;"></div>
            <button onclick="closePlaylistSelector()" style="width:100%; padding:12px; margin-top:20px; background:var(--input-bg); border:none; border-radius:12px; cursor:pointer; color:var(--text-primary);">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å»ºç«‹æ–°æ¸…å–® -->
    <div id="create-playlist-modal" class="fullscreen-modal" style="z-index:330; background:rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
        <div style="margin:auto; background:var(--card-bg); width:90%; max-width:400px; padding:30px; border-radius:24px;">
            <h3 style="margin-bottom:20px;">å»ºç«‹æ–°æ¸…å–®</h3>
            <input type="text" id="new-playlist-name" class="input-style" placeholder="æ¸…å–®åç¨±">
            <div style="margin-bottom:20px;">
                <p style="margin-bottom:8px; font-size:0.9rem; color:var(--text-secondary);">å°é¢åœ–ç‰‡ (é¸å¡«)</p>
                <input type="file" id="new-playlist-img" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <div onclick="document.getElementById('new-playlist-img').click()" id="img-preview" style="width:100px; height:100px; background:var(--input-bg); border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; background-size:cover; background-position:center;">
                    <span style="font-size:2rem; color:var(--text-secondary);">+</span>
                </div>
            </div>
            <button onclick="confirmCreatePlaylist()" style="width:100%; padding:14px; background:var(--accent-color); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">å»ºç«‹</button>
            <button onclick="closeCreatePlaylistModal()" style="width:100%; margin-top:10px; padding:10px; background:none; border:none; color:var(--text-secondary); cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ¸…å–®è©³æƒ…é  -->
    <div id="playlist-detail-modal" class="fullscreen-modal" style="z-index:305;">
        <div class="modal-nav">
            <button onclick="closePlaylistDetail()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-primary);">â†</button>
            <h2 id="pd-name" style="font-size:1.2rem;">æ¸…å–®åç¨±</h2>
            <div style="width:30px;"></div>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:30px;">
                <div id="pd-cover" style="width:180px; height:180px; margin:0 auto 20px; border-radius:20px; background:#eee; background-size:cover; background-position:center; box-shadow:var(--shadow-md);"></div>
                <h1 id="pd-title-large" style="font-size:1.8rem;">åç¨±</h1>
                <p id="pd-count" style="color:var(--text-secondary);">0 é¦–æ­Œæ›²</p>
                <button onclick="playPlaylistAll()" style="margin-top:20px; padding:12px 40px; background:var(--accent-color); color:white; border-radius:30px; border:none; font-weight:bold; cursor:pointer;">æ’­æ”¾å…¨éƒ¨</button>
            </div>
            <div id="pd-songs-list"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- 1. IndexedDB å°è£ ---
        const DB_NAME = 'AstraMusicDB';
        const DB_VERSION = 1;

        const DB = {
            db: null,
            async open() {
                if (this.db) return this.db;
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB_NAME, DB_VERSION);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        // å»ºç«‹ Stores
                        if (!db.objectStoreNames.contains('users')) db.createObjectStore('users', { keyPath: 'username' });
                        if (!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                    };
                    req.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    req.onerror = (e) => reject(e);
                });
            },
            async get(storeName, key) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async put(storeName, data) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const req = store.put(data);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            async delete(storeName, key) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readwrite');
                    const store = tx.objectStore(storeName);
                    const req = store.delete(key);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            async getAll(storeName) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }
        };

        // --- è³‡æ–™è¨­å®š ---
        const musicLibrary = [
            { id: 1, title: "WE GO UP", artist: "BABYMONSTER", filename: "song1.mp3" },
            { id: 2, title: "PSYCHO", artist: "BABYMONSTER", filename: "song2.mp3" },
            { id: 3, title: "SUPA DUPA LUV", artist: "BABYMONSTER", filename: "song3.mp3" },
            { id: 4, title: "WILD", artist: "BABYMONSTER", filename: "song4.mp3" },
        ];
        
        const pageTitles = { 'home': 'é¦–é ', 'search': 'æœå°‹', 'discovery': 'æ–°ç™¼ç¾', 'database': 'è³‡æ–™åº«' };

        let myPlaylists = [];
        let currentUser = null;
        let songToAdd = null;
        let tempImgBase64 = null;
        let tempAvatarBase64 = null;
        let currentPlaylistView = null;

        const observer = new IntersectionObserver(entries => entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible') }));
        document.querySelectorAll('.feature-card').forEach(c => observer.observe(c));

        // --- 2. åˆå§‹åŒ–æµç¨‹ (æ”¹ç‚º Async) ---
        window.onload = async function() {
            await DB.open(); // åˆå§‹åŒ–è³‡æ–™åº«

            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const session = await DB.get('settings', 'current_user');
            if(session) {
                // ç²å–å®Œæ•´ä½¿ç”¨è€…è³‡æ–™
                currentUser = await DB.get('users', session.value);
            }

            // æª¢æŸ¥ä¸»é¡Œ
            const themeData = await DB.get('settings', 'theme');
            if(themeData && themeData.value === 'dark') updateThemeUI('dark', false);

            if(currentUser) {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                await initApp();
            }
        };

        async function initApp() {
            renderCards('home-grid', musicLibrary);
            renderCards('search-grid', musicLibrary);
            renderCards('discovery-grid', [...musicLibrary].reverse());
            
            // å¾ DB è®€å–æ’­æ”¾æ¸…å–®
            myPlaylists = await DB.getAll('playlists') || [];
            renderPlaylists();
            
            checkVersion();
            updateHeaderAvatar();
            document.getElementById('page-title-display').innerText = pageTitles['home'];
        }

        // --- ç™»å…¥èˆ‡ç™»å‡º (IndexedDB) ---
        function openLoginModal() { document.getElementById('login-modal').classList.add('active'); }
        function closeLoginModal() { document.getElementById('login-modal').classList.remove('active'); }
        
        async function handleLogin(e) {
            e.preventDefault();
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            
            // å˜—è©¦å¾ DB æ‰¾ç”¨æˆ¶
            let dbUser = await DB.get('users', user);

            if (!dbUser) {
                // è¨»å†Šæ–°ç”¨æˆ¶
                dbUser = { username: user, password: pass, avatar: null };
                await DB.put('users', dbUser);
            } else {
                // é©—è­‰ (é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥æ›´æ–° session)
                // å¯¦éš›æ‡‰é©—è­‰ dbUser.password === pass
            }

            // è¨­ç½® Session
            await DB.put('settings', { key: 'current_user', value: user });
            location.reload();
        }
        
        async function handleLogout() { 
            await DB.delete('settings', 'current_user');
            location.reload(); 
        }

        // --- æ ¸å¿ƒï¼šHeader èˆ‡ Profile (IndexedDB) ---
        function updateHeaderAvatar() {
            const btn = document.getElementById('header-avatar-btn');
            if(currentUser && currentUser.avatar) {
                btn.style.backgroundImage = `url(${currentUser.avatar})`;
                btn.innerHTML = '';
            } else {
                btn.style.backgroundImage = 'none';
                btn.style.backgroundColor = '#ccc';
                btn.innerHTML = `<span style="display:flex;justify-content:center;align-items:center;height:100%;font-weight:bold;color:#666;">${currentUser ? currentUser.username.charAt(0).toUpperCase() : '?'}</span>`;
            }
        }

        function openProfileModal() {
            document.getElementById('edit-username').value = currentUser.username;
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            
            const preview = document.getElementById('profile-edit-avatar');
            if(currentUser.avatar) {
                preview.style.backgroundImage = `url(${currentUser.avatar})`;
            } else {
                preview.style.backgroundImage = 'none';
            }
            tempAvatarBase64 = currentUser.avatar; 
            document.getElementById('profile-modal').classList.add('active');
        }
        function closeProfileModal() { document.getElementById('profile-modal').classList.remove('active'); }

        function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempAvatarBase64 = e.target.result;
                    document.getElementById('profile-edit-avatar').style.backgroundImage = `url(${tempAvatarBase64})`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfileChanges() {
            const newName = document.getElementById('edit-username').value;
            const currentPassInput = document.getElementById('current-password').value;
            const newPassInput = document.getElementById('new-password').value;

            if(!newName) return alert("ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º");

            if(newPassInput) {
                if(currentPassInput !== currentUser.password) return alert("ç›®å‰å¯†ç¢¼éŒ¯èª¤ï¼");
                currentUser.password = newPassInput; 
                alert("å¯†ç¢¼å·²æ›´æ–°");
            }

            // å¦‚æœæ”¹äº†ä½¿ç”¨è€…åç¨±ï¼Œéœ€è¦è™•ç† Key è®Šæ›´ (åˆªèˆŠå¢æ–°)
            const oldUsername = currentUser.username;
            currentUser.username = newName;
            currentUser.avatar = tempAvatarBase64;

            if(oldUsername !== newName) {
                await DB.delete('users', oldUsername);
                // æ›´æ–° Session
                await DB.put('settings', { key: 'current_user', value: newName });
            }
            await DB.put('users', currentUser);
            
            updateHeaderAvatar();
            closeProfileModal();
        }

        // --- é é¢åˆ‡æ› ---
        function switchPage(pid) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+pid)) document.getElementById('nav-'+pid).classList.add('active');

            const titleEl = document.getElementById('page-title-display');
            titleEl.style.opacity = 0;
            setTimeout(() => {
                titleEl.innerText = pageTitles[pid] || 'ASTRA';
                titleEl.style.opacity = 1;
            }, 150);
        }

        function renderCards(containerId, songs) {
            const container = document.getElementById(containerId);
            container.innerHTML = songs.map(song => `
                <div class="music-card" onclick="playSong(${song.id})">
                    <div class="cover-art" style="background-image:url('https://cdn-icons-png.flaticon.com/512/3208/3208703.png')">
                        <div class="add-btn" onclick="openPlaylistSelector(event, ${song.id})">
                            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="3" fill="none"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </div>
                    </div>
                    <div style="font-weight:bold; font-size:0.95rem; margin-bottom:2px;">${song.title}</div>
                    <div style="font-size:0.8rem; color:var(--text-secondary);">${song.artist}</div>
                </div>
            `).join('');
        }

        // --- è³‡æ–™åº«èˆ‡æ¸…å–®é‚è¼¯ ---
        function renderPlaylists() {
            const container = document.getElementById('playlists-container');
            if(myPlaylists.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">å°šæœªå»ºç«‹æ¸…å–®</div>';
                return;
            }
            container.innerHTML = myPlaylists.map(pl => `
                <div class="playlist-row" onclick="openPlaylistDetail(${pl.id})">
                    <div class="playlist-cover-small" style="background-image:url(${pl.img || 'https://cdn-icons-png.flaticon.com/512/3208/3208703.png'})"></div>
                    <div>
                        <div style="font-weight:bold;">${pl.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-secondary);">${pl.songs.length} é¦–æ­Œæ›²</div>
                    </div>
                </div>
            `).join('');
        }

        function openPlaylistDetail(plId) {
            const pl = myPlaylists.find(p => p.id === plId);
            if(!pl) return;
            currentPlaylistView = pl;
            document.getElementById('pd-name').innerText = pl.name;
            document.getElementById('pd-title-large').innerText = pl.name;
            document.getElementById('pd-count').innerText = `${pl.songs.length} é¦–æ­Œæ›²`;
            document.getElementById('pd-cover').style.backgroundImage = `url(${pl.img || 'https://cdn-icons-png.flaticon.com/512/3208/3208703.png'})`;
            
            const songsContainer = document.getElementById('pd-songs-list');
            if(pl.songs.length === 0) {
                songsContainer.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">æ­¤æ¸…å–®æ˜¯ç©ºçš„</p>';
            } else {
                const songs = musicLibrary.filter(s => pl.songs.includes(s.id));
                songsContainer.innerHTML = songs.map(s => `
                    <div class="playlist-row" onclick="playSong(${s.id})">
                         <div style="font-weight:bold; flex:1;">${s.title}</div>
                         <div style="color:var(--text-secondary); font-size:0.9rem;">${s.artist}</div>
                    </div>
                `).join('');
            }
            document.getElementById('playlist-detail-modal').classList.add('active');
        }
        function closePlaylistDetail() { document.getElementById('playlist-detail-modal').classList.remove('active'); }
        
        function playPlaylistAll() {
            if(currentPlaylistView && currentPlaylistView.songs.length > 0) playSong(currentPlaylistView.songs[0]);
        }

        // --- åŠ å…¥æ­Œæ›² (IndexedDB) ---
        function openPlaylistSelector(e, songId) {
            e.stopPropagation();
            songToAdd = songId;
            if(myPlaylists.length === 0) {
                if(confirm("æ‚¨é‚„æ²’æœ‰å»ºç«‹ä»»ä½•æ’­æ”¾æ¸…å–®ï¼Œæ˜¯å¦ç«‹å³å»ºç«‹ï¼Ÿ")) openCreatePlaylistModal();
                return;
            }
            const list = document.getElementById('playlist-selector-list');
            let html = `
                <div onclick="openCreatePlaylistModal()" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer; color:var(--accent-color); font-weight:bold; display:flex; align-items:center;">
                    <span style="font-size:1.5rem; margin-right:10px;">+</span> å»ºç«‹æ–°æ¸…å–®
                </div>
            `;
            html += myPlaylists.map(pl => `
                <div onclick="addToPlaylist(${pl.id})" style="padding:15px; border-bottom:1px solid var(--divider); cursor:pointer; display:flex; align-items:center;">
                    <div style="width:40px; height:40px; background-image:url(${pl.img || ''}); background-size:cover; border-radius:8px; margin-right:15px; background-color:#eee;"></div>
                    ${pl.name}
                </div>
            `).join('');
            list.innerHTML = html;
            document.getElementById('select-playlist-modal').classList.add('active');
        }

        async function addToPlaylist(plId) {
            const pl = myPlaylists.find(p => p.id === plId);
            if(pl && !pl.songs.includes(songToAdd)) {
                pl.songs.push(songToAdd);
                // æ›´æ–° DB
                await DB.put('playlists', pl);
                renderPlaylists();
                alert(`å·²åŠ å…¥ "${pl.name}"`);
            } else {
                alert("æ­Œæ›²å·²åœ¨æ¸…å–®ä¸­");
            }
            closePlaylistSelector();
        }
        function closePlaylistSelector() { document.getElementById('select-playlist-modal').classList.remove('active'); }

        // --- å»ºç«‹æ¸…å–® (IndexedDB) ---
        function openCreatePlaylistModal() {
            document.getElementById('select-playlist-modal').classList.remove('active');
            document.getElementById('create-playlist-modal').classList.add('active');
            tempImgBase64 = null;
            document.getElementById('img-preview').style.backgroundImage = '';
            document.getElementById('img-preview').innerHTML = '<span style="font-size:2rem; color:var(--text-secondary);">+</span>';
        }
        function closeCreatePlaylistModal() { document.getElementById('create-playlist-modal').classList.remove('active'); }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempImgBase64 = e.target.result;
                    const preview = document.getElementById('img-preview');
                    preview.style.backgroundImage = `url(${tempImgBase64})`;
                    preview.innerHTML = '';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function confirmCreatePlaylist() {
            const name = document.getElementById('new-playlist-name').value;
            if(!name) return alert("è«‹è¼¸å…¥æ¸…å–®åç¨±");
            
            const newPl = { 
                id: Date.now(), 
                name: name, 
                songs: [], 
                img: tempImgBase64 
            };
            
            await DB.put('playlists', newPl); // å­˜å…¥ DB
            myPlaylists.push(newPl);
            
            renderPlaylists();
            closeCreatePlaylistModal();
            if(songToAdd) addToPlaylist(newPl.id);
        }

        // --- å…¶ä»–åŠŸèƒ½ ---
        async function showChangelog() {
            const content = document.getElementById('changelog-content');
            content.innerHTML = '<p style="text-align:center; padding:20px;">è¼‰å…¥ä¸­...</p>';
            document.getElementById('changelog-modal').classList.add('active');
            try {
                const res = await fetch('./changelog.json');
                const logs = await res.json();
                content.innerHTML = logs.map(log => `<div class="log-item"><div class="log-ver">v${log.version}</div><div style="font-size:0.8rem; color:var(--text-secondary); margin-bottom:10px;">${log.date}</div><div style="line-height:1.6;">${log.content}</div></div>`).join('');
            } catch (e) { content.innerHTML = '<p style="text-align:center; color:red;">ç„¡æ³•è®€å–æ—¥èªŒ</p>'; }
        }
        function closeChangelog() { document.getElementById('changelog-modal').classList.remove('active'); }
        async function checkVersion() {
            try {
                const res = await fetch('./changelog.json');
                const logs = await res.json();
                if(logs.length > 0) document.getElementById('setting-ver').innerText = `v${logs[0].version} >`;
            } catch(e){}
        }

        async function toggleThemePill() {
            const pill = document.getElementById('theme-pill');
            const isDark = pill.getAttribute('data-state') === 'dark';
            await updateThemeUI(isDark ? 'light' : 'dark', true);
        }

        async function updateThemeUI(theme, save = false) {
            const pill = document.getElementById('theme-pill');
            const pLight = document.getElementById('pill-light');
            const pDark = document.getElementById('pill-dark');
            const metaTheme = document.getElementById('theme-color-meta');
            
            if(theme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                pill.setAttribute('data-state', 'dark');
                pLight.classList.remove('active');
                pDark.classList.add('active');
                metaTheme.setAttribute('content', '#000000');
            } else {
                document.body.removeAttribute('data-theme');
                pill.setAttribute('data-state', 'light');
                pDark.classList.remove('active');
                pLight.classList.add('active');
                metaTheme.setAttribute('content', '#FFFFFF');
            }
            if(save) await DB.put('settings', { key: 'theme', value: theme });
        }

        const audioPlayer = document.getElementById('audio-player');
        let isPlaying = false;
        function playSong(id) {
            const song = musicLibrary.find(s => s.id === id);
            if(!song) return;
            audioPlayer.src = `./music/${song.filename}`;
            document.getElementById('p-title').innerText = song.title;
            document.getElementById('p-artist').innerText = song.artist;
            document.getElementById('p-thumb').style.backgroundImage = "url('https://cdn-icons-png.flaticon.com/512/3208/3208703.png')";
            audioPlayer.play();
            isPlaying = true;
            document.getElementById('playBtn').innerText = "||";
        }
        function togglePlay() {
            if(audioPlayer.src) {
                if(isPlaying) audioPlayer.pause(); else audioPlayer.play();
                isPlaying = !isPlaying;
                document.getElementById('playBtn').innerText = isPlaying ? "||" : "â–¶";
            }
        }
        function handleSearch(val) { renderCards('search-grid', musicLibrary.filter(s => s.title.toLowerCase().includes(val.toLowerCase()))); }
        function openSettings() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
    </script>
</body>
</html>
